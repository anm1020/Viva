<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>μμ•½ κ²°κ³Ό</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" href="/css/book.css" />
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>
<body>
	<div th:replace="fragments/header :: headerFragment"></div>

	
  <div class="result-wrapper">
    <h1>μμ•½ κ²°κ³Ό</h1>

    <div th:if="${reservation != null}">
      <table class="reservation-result-table">
        <tr>
          <th>μμ•½λ²νΈ</th>
          <td th:text="${reservation.resId}">β€”</td>
        </tr>
        <tr>
          <th>μμ•½μΌμ‹</th>
          <td>
            <span th:text="${reservation.reservedDate}">yyyy-MM-dd</span>
            <span th:text="${reservation.reservedTime}">HH:mm</span>
          </td>
        </tr>
        <tr>
          <th>μƒνƒ</th>
          <td>
            <span th:switch="${reservation.resStatus}">
              <span th:case="'pending'">κ²°μ  λ€κΈ°</span>
              <span th:case="'confirmed'">κ²°μ  μ™„λ£</span>
              <span th:case="'cancelled'">μ·¨μ†λ¨</span>
              <span th:case="*">-</span>
            </span>
          </td>
        </tr>
      </table>

			<!-- μΉ΄λ“ κ²°μ  λ§ν¬ -->
			  <div class="btn-group" th:if="${reservation.resStatus == 'pending'}">
				  <button type="button" class="btn-card btn-pay" 
                th:data-resid="${reservation.resId}">
          π’³ μΉ΄λ“ κ²°μ 
        </button>
			<!-- β… ν¬μΈνΈ κ²°μ  λ²„νΌ -->
				 <button id="btn-point-pay" th:data-userid="${userId}"
          th:data-resid="${reservation.resId}" data-amount="5000" class="btn-point">
          π’° ν¬μΈνΈλ΅ κ²°μ 
        </button>
			</div>
		</div>

		<div th:if="${reservation == null}">
			<p>μμ•½ μ •λ³΄λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤.</p>
			<p th:text="${error}"></p>
		</div>

		<p>
			<a th:href="@{/mypage(tab='schedule')}" class="back-link">λ‚΄ μμ•½ λ©λ΅μΌλ΅ λμ•„κ°€κΈ°</a>
		</p>
	</div>

	<!-- β… ν¬μΈνΈ κ²°μ  AJAX -->
	 <script>
    $('#btn-point-pay').on('click', function() {
      const userId = $(this).data('userid');
      const resId = $(this).data('resid');
      const amount = $(this).data('amount');

      if (!confirm(amount + ' ν¬μΈνΈλ΅ κ²°μ ν•μ‹κ² μµλ‹κΉ?')) return;

      $.ajax({
        type: 'POST',
        url: '/point/use/ajax',  // ajax μ „μ© μ—”λ“ν¬μΈ
        data: { userId, resId, amount },
        success: function(response) {
          alert("ν¬μΈνΈ κ²°μ  μ™„λ£!");
          location.href = "/mypage?tab=schedule";
        },
        error: function(xhr) {
        	 if (confirm("ν¬μΈνΈκ°€ λ¶€μ΅±ν•©λ‹λ‹¤. ν¬μΈνΈλ¥Ό μ¶©μ „ν•μ‹κ² μµλ‹κΉ?")) {
        		    window.location.href = "/point/chargePage"; // ν¬μΈνΈ μ¶©μ „ νμ΄μ§€λ΅ μ΄λ™
        	 }
        }
      });
    });
  </script>

  <!-- μΉ΄λ“ κ²°μ  μ•„μ„ν¬νΈ μ—°λ™ -->
  <script>
    $(function(){
      IMP.init("imp14397622"); // μ•„μ„ν¬νΈ κ°€λ§Ήμ  μ‹λ³„μ½”λ“

      $(document).on('click', '.btn-pay.btn-card', function(e) {
        e.preventDefault();

        const resId = $(this).data('resid');
        const userId = /*[[${userId}]]*/ 'UNKNOWN'; // μ„λ²„μ—μ„ μ„Έμ… λ“±μΌλ΅ λ°›μ„ κ²ƒ
        const amount = 5000; // κ²°μ  κΈμ•΅ (ν•„μ” μ‹ λ™μ μΌλ΅ λ³€κ²½)

        IMP.request_pay({
          channelKey : "channel-key-01764171-b249-4c16-9d18-e9174fa8e611",
          pay_method: 'card',
          merchant_uid: 'order_' + new Date().getTime(),
          name: 'λ©΄μ ‘ μμ•½ κ²°μ ',
          amount: amount,
          buyer_tel: '010-0000-0000'
        }, function(rsp) {
          if (!rsp.success) {
            alert('κ²°μ  μ‹¤ν¨: ' + rsp.error_msg);
            return;
          }

          // κ²°μ  μ„±κ³µ μ‹ μ„λ²„μ— κ²°μ  μ •λ³΄ μ €μ¥ μ”μ²­
          $.ajax({
            type: 'POST',
            url: '/payment/save',
            contentType: 'application/json',
            data: JSON.stringify({
              payResno: rsp.merchant_uid,
              payAmount: rsp.paid_amount,
              payStatus: rsp.status,
              resId: resId,
              userId: userId,
              payType: "CARD"
            }),
            success: function(data) {
              alert('μΉ΄λ“κ²°μ  μ™„λ£');
              location.href = "/mypage?tab=schedule";
            },
            error: function(xhr) {
              alert('μ„λ²„ ν†µμ‹  μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
            }
          });
        });
      });
    });
	</script>


	<div th:replace="fragments/footer :: footerFragment"></div>

</body>
</html>
