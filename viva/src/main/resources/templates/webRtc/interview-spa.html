<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>í™”ìƒ ë©´ì ‘ SPA</title>

<style>
/* main-view, new-view, list-viewëŠ” ê°ê° ìˆ¨ê¹€ì²˜ë¦¬ */
.view {
	display: none;
}

.view.active {
	display: block;
}

body {
	font-family: 'Arial', sans-serif;
	background-color: #f2f2f2;
	padding: 20px;
}

/* ================================== */
header, footer {
	background-color: #cfd8ff;
	padding: 10px 20px;
	text-align: center;
}

header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-weight: bold;
}

.logo {
	font-size: 1.2rem;
}

.login-link {
	font-size: 0.9rem;
}

main {
	background-color: #ffffff;
	min-height: 400px;
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 40px 0;
}

.content-box {
	border: 1px solid #d0d0d0;
	border-radius: 6px;
	padding: 30px 50px;
	text-align: center;
}

.content-box h2 {
	margin-bottom: 30px;
	font-size: 1.4rem;
}

.button-group {
	display: flex;
	gap: 20px;
	justify-content: center;
}

.nav-button {
	width: 120px;
	height: 100px;
	background-color: #e0e0e0;
	border: none;
	border-radius: 6px;
	font-size: 1rem;
	font-weight: bold;
	cursor: pointer;
	transition: background-color 0.2s;
}

.nav-button:hover {
	background-color: #d6d6d6;
}

footer {
	font-weight: bold;
}

/* ================================== */
.room-list {
	display: flex;
	flex-wrap: wrap;
	gap: 20px;
}

.room-card {
	background-color: #fff;
	width: 300px;
	border-radius: 12px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	padding: 16px;
	position: relative;
}

.room-status-dot {
	width: 10px;
	height: 10px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 8px;
}

.status-waiting {
	background-color: red;
}

.status-playing {
	background-color: green;
}

.status-ended {
	background-color: gray;
}

.room-title {
	font-size: 1.1rem;
	font-weight: bold;
	margin: 8px 0;
}

.room-info {
	color: #666;
	font-size: 0.9rem;
	margin-top: 4px;
}

.room-icon {
	position: absolute;
	bottom: 16px;
	right: 16px;
	font-size: 1.2rem;
}

.room-list a {
	text-decoration: none;
	color: inherit;
}

.room-list a:hover {
	transform: translateY(-4px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/*** ë¹„ë””ì˜¤ ì˜ì—­ css ***/
#videoroom-view {
	padding: 20px;
}

#local-area, #remote-area {
	margin-bottom: 20px;
}

.label {
	font-size: 14px;
	background-color: #3498db;
	color: #fff;
	padding: 2px 6px;
	border-radius: 3px;
}

.hide {
	display: none;
}

.remote-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	gap: 10px;
}

.remote-box {
	position: relative;
	border: 1px solid #ccc;
	padding: 5px;
	min-height: 150px;
}

.remote-box video {
  background-color: black;
  width: 100%;
  height: 240px; /* ë˜ëŠ” auto, fixed ë“± */
  object-fit: cover;
}

.bitrate-controls {
	margin-left: 10px;
	display: inline-block;
	position: relative;
}

.dropdown-menu {
	list-style: none;
	position: absolute;
	background: #fff;
	border: 1px solid #aaa;
	margin: 0;
	padding: 0;
	display: none;
}

.dropdown-menu li {
	padding: 5px 10px;
}

.dropdown-menu li:hover {
	background-color: #f0f0f0;
}

#bitrateset:hover+.dropdown-menu, .dropdown-menu:hover {
	display: block;
}

.remote-box video {
  width: 100%;
  max-width: 480px;       /* ğŸ‘ˆ ì›í•˜ëŠ” ë„ˆë¹„ ì œí•œ */
  height: auto;
  aspect-ratio: 4 / 3;     /* ë˜ëŠ” 16 / 9 ë“± ë¹„ìœ¨ ê³ ì • */
  object-fit: cover;       /* contain or cover */
}

</style>
<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js}"></script>
<script
	th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js}"></script>



<!-- ë‚´ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script th:src="@{/js/webRtc/janus.js}"></script>

<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css}" />
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css}" />


</head>
<body>

	<!-- [1] ë©”ì¸ í™”ë©´ -->
	<div id="main-view" class="view active">
		<header>
			<div class="logo">ë¡œê³ </div>
			<div class="login-link">
				<a href="/login">ë¡œê·¸ì¸</a>
			</div>
		</header>
		<main>
			<div class="content-box">
				<h2>ë©´ì ‘ ë©”ì¸</h2>
				<div class="button-group">
					<button class="nav-button" onclick="navigate('new')">New
						Meeting</button>
					<button class="nav-button" onclick="navigate('list')">Join</button>
				</div>
			</div>
		</main>
		<footer>í‘¸í„°</footer>
	</div>

	<!-- [2] ë°© ìƒì„± í™”ë©´ -->
	<div id="new-view" class="view">
		<h2>ë©´ì ‘ ë°© ìƒì„±</h2>
		<form id="createRoomForm">
			<label for="intrRoomTitle">ë°© ì œëª©:</label> <input type="text"
				id="intrRoomTitle" name="intrRoomTitle" required />
			<button type="submit">ë°©ìƒì„±</button>
		</form>
		<button onclick="navigate('main')">â† ë’¤ë¡œê°€ê¸°</button>
	</div>

	<!-- [3] ë°© ëª©ë¡ í™”ë©´ -->
	<div id="list-view" class="view">
		<h2>ë©´ì ‘ ë°© ëª©ë¡</h2>
		<div id="roomList" class="room-list"></div>
		<button onclick="navigate('main')">â† ë’¤ë¡œê°€ê¸°</button>
	</div>

	<!-- [4] í†µí™”ë°© í™”ë©´ -->
	<div id="videoroom-view" class="view">
		<h2>í™”ìƒ í†µí™”</h2>

		<div class="remote-grid" id="remoteContainer"></div>


		<!-- ë¡œì»¬ ë¹„ë””ì˜¤ -->
<!-- 		<section id="local-area"> -->
<!-- 			<h3> -->
<!-- 				ë‚´ í™”ë©´ <span id="publisher" class="label hide"></span> <span -->
<!-- 					class="bitrate-controls hide"> -->
<!-- 					<button id="bitrateset">Bandwidth â–¼</button> -->
<!-- 					<ul id="bitrate" class="dropdown-menu"> -->
<!-- 						<li><a href="#" id="0">No limit</a></li> -->
<!-- 						<li><a href="#" id="128">128kbps</a></li> -->
<!-- 						<li><a href="#" id="256">256kbps</a></li> -->
<!-- 						<li><a href="#" id="512">512kbps</a></li> -->
<!-- 						<li><a href="#" id="1024">1mbps</a></li> -->
<!-- 						<li><a href="#" id="1500">1.5mbps</a></li> -->
<!-- 						<li><a href="#" id="2000">2mbps</a></li> -->
<!-- 					</ul> -->
<!-- 				</span> -->
<!-- 			</h3> -->
<!-- 			<div id="videolocal"> -->
<!-- 				<video id="myVideo" autoplay muted playsinline width="320" -->
<!-- 					height="240" border="1"></video> -->
<!-- 			</div> -->
<!-- 		</section> -->
		<!-- ì›ê²© ë¹„ë””ì˜¤ -->
<!-- 		<section id="remote-area"> -->
<!-- 			<h3>ìƒëŒ€ í™”ë©´</h3> -->
<!-- 			<div class="remote-grid"> -->
<!-- 				<div class="remote-box" id="videoremote1"> -->
<!-- 					<span id="remote1" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote2"> -->
<!-- 					<span id="remote2" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote3"> -->
<!-- 					<span id="remote3" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote4"> -->
<!-- 					<span id="remote4" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote5"> -->
<!-- 					<span id="remote5" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 			</div> -->
<!-- 		</section> -->

		<button onclick="navigate('main')">ì¢…ë£Œ</button>
	</div>


	<script>
//video-room-viewì— ì§„ì… ì‹œ ì´ˆê¸°í™”
function navigate(view) {
    document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
    document.getElementById(view + '-view').classList.add('active');

    if (view === 'list') loadRoomList();
    if (view === 'videoroom'){
    	initJanus(); // í™”ìƒí†µí™” í™”ë©´ ì§„ì… ì‹œ ì´ˆê¸°í™”
    }else if (janus) {
    	// âœ… ë°© ë‚˜ê°€ê¸° ì‹œ ì „ì²´ ì •ë¦¬
        if (janus) {
            cleanupAllFeeds();       // remote feed + timer ì œê±°
            janus.destroy();         // Janus ì„¸ì…˜ ì¢…ë£Œ
            janus = null;
            sfutest = null;
            mypvtid = null;
            selectedRoomId = null;
            displayName = null;
        }
    }
}

function cleanupAllFeeds() {
    // remote feeds ì •ë¦¬
    for (let i = 1; i < feeds.length; i++) {
        if (feeds[i]) {
            try {
                feeds[i].detach();
            } catch (e) {
                console.warn(`feed #${i} detach ì‹¤íŒ¨`, e);
            }
            feeds[i] = null;
        }
    }

    // ë¹„íŠ¸ë ˆì´íŠ¸ íƒ€ì´ë¨¸ ì œê±°
    for (let key in bitrateTimer) {
        if (bitrateTimer[key]) {
            clearInterval(bitrateTimer[key]);
            bitrateTimer[key] = null;
        }
    }

    // ì›ê²© ë¹„ë””ì˜¤ DOM ì œê±°
    $('#remoteContainer').empty();

    // ë¡œì»¬ ë¹„ë””ì˜¤ ì •ë¦¬
    $('#videolocal').empty();
    $('#publish').show();
}

//ë°© ìƒì„±
document.getElementById("createRoomForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const title = document.getElementById("intrRoomTitle").value;

    fetch("/api/meeting/roomcreate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ intrRoomTitle: title })
    })
    .then(res => res.json())
    .then(data => {
        alert(`ë°© ìƒì„± ì™„ë£Œ: ${data.intrRoomTitle}`);
        navigate('list');
    });
});

// ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadRoomList() {
    fetch("/api/meeting/roomlist")
        .then(res => res.json())
        .then(data => {
            const listEl = document.getElementById("roomList");
            listEl.innerHTML = ""; // ì´ˆê¸°í™”

            data.forEach(room => {
                const statusClass = room.statusCd === 'waiting' ? 'status-waiting'
                                   : room.statusCd === 'in_progress' ? 'status-playing'
                                   : 'status-ended';

                const div = document.createElement("div");
                div.className = "room-card";

                div.innerHTML = `
                  <div>
                    <span class="room-status-dot ${statusClass}"></span>
                    <span>${room.intrRoomId}</span>
                  </div>
                  <div class="room-title">${room.intrRoomTitle}</div>
                  <div class="room-info">${room.hostId}ë‹˜ì˜ ë°©</div>
                  <div class="room-info">ìƒì„±: ${formatDate(room.createdDt)}</div>
                  <div class="room-icon">ğŸ”’ ğŸ”“</div>
                `;

                // ì´ë²¤íŠ¸ ë“±ë¡
                div.addEventListener("click", () => enterRoom(room.intrRoomId, room.hostId));

//                 const html = `
//                     <div class="room-card" onclick="enterRoom(${room.intrRoomId}, '${room.hostId}')">
//                         <div>
//                             <span class="room-status-dot ${statusClass}"></span>
//                             <span>${room.intrRoomId}</span>
//                         </div>
//                         <div class="room-title">${room.intrRoomTitle}</div>
//                         <div class="room-info">${room.hostId}ë‹˜ì˜ ë°©</div>
//                         <div class="room-info">ìƒì„±: ${formatDate(room.createdDt)}</div>
//                         <div class="room-icon">ğŸ”’ ğŸ”“</div>
//                     </div>
//                 `;
                listEl.appendChild(div);
            });
        });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString("ko-KR", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
    });
}

// ë°© ì…ì¥
function enterRoom(roomId, hostId) {
	selectedRoomId = roomId; // ì „ì—­ ë˜ëŠ” ìƒíƒœ ì €ì¥
	displayName = hostId;
    navigate('videoroom');   // SPA ë°©ì‹ì˜ í™”ë©´ ì „í™˜
}

// ë¸Œë¼ìš°ì € WebRTC ì§€ì› í™•ì¸ ë° janus ì´ˆê¸°í™”
function initJanus() {
    if (!Janus.isWebrtcSupported()) {
        alert("WebRTCë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        return;
    }

    Janus.init({
        debug: "all",
        callback: createJanusSession		// ì´ˆê¸°í™” í›„ ì„¸ì…˜ ìƒì„±
    });
}

var version = 1.2;
var server = null;
server = "https://janus.jsflux.co.kr/janus";

let janus = null;
let sfutest = null;
let opaqueId = "videoroom-" + Janus.randomString(12);
let mypvtid = null;

var feeds = [];
var bitrateTimer = [];

var doSimulcast = (getQueryStringValue("simulcast") === "yes" || getQueryStringValue("simulcast") === "true");
var doSimulcast2 = (getQueryStringValue("simulcast2") === "yes" || getQueryStringValue("simulcast2") === "true");
var subscriber_mode = (getQueryStringValue("subscriber-mode") === "yes" || getQueryStringValue("subscriber-mode") === "true");

//Helper to parse query string
function getQueryStringValue(name) {
	name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
	var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
	return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

// janus ì„¸ì…˜ ìƒì„±
function createJanusSession() {
    janus = new Janus({
        server: server,

        success: function () {
            janus.attach({
                plugin: "janus.plugin.videoroom",
                opaqueId: opaqueId,					// ì„¸ì…˜ ì‹ë³„ìš©

                // í”ŒëŸ¬ê·¸ì¸ ì—°ê²° ì„±ê³µ ì‹œ
                success: function (pluginHandle) {
                    sfutest = pluginHandle;

                    // ë°© ì°¸ì—¬ ìš”ì²­
                    const joinRequest = {
                        request: "join",
                        room: selectedRoomId,		// ì„ íƒëœ ë°© id
                        ptype: "publisher",
                        display: displayName
                    };
                    sfutest.send({ message: joinRequest });
                },
				
                // ì—ëŸ¬ì‹œ
                error: function (error) {
                    console.error("í”ŒëŸ¬ê·¸ì¸ attach ì‹¤íŒ¨", error);
                },

                consentDialog: function (on) {
                    Janus.debug("Consent dialog should be " + (on ? "on" : "off") + " now");
                    function publishOwnFeed(useAudio) {
                        sfutest.createOffer({
                            media: {
                                audioRecv: false, videoRecv: false,
                                audioSend: useAudio, videoSend: true
                            },
                            success: function (jsep) {
                                const publish = {
                                    request: "configure",
                                    audio: useAudio,
                                    video: true
                                };
                                sfutest.send({ message: publish, jsep: jsep });
                            },
                            error: function (error) {
                                console.error("ë¯¸ë””ì–´ publish ì˜¤ë¥˜", error);
                            }
                        });
                    }

                },

                mediaState: function (medium, on) {
                	Janus.log("Janus " + (on ? "started" : "stopped") + " receiving our " + medium);
                },

                webrtcState: function (on) {
                    Janus.log("WebRTC ì—°ê²° ìƒíƒœ:", on ? "ì—°ê²°ë¨" : "ëŠê¹€");
                },

                onmessage: function (msg, jsep) {
                    if (msg.videoroom === "joined") {
                        mypvtid = msg.private_id;
                        publishOwnFeed(true);
                    }
                    if (msg["publishers"]) {	// ê¸°ì¡´ ì°¸ê°€ì êµ¬ë…ì²˜ë¦¬
                    	const list = msg["publishers"];
                    	list.forEach(p => {
                    	newRemoteFeed(p.id, p.display, p.audio_codec, p.video_codec);
                    	});
                    }
                    if (jsep) {
                        sfutest.handleRemoteJsep({ jsep: jsep });
                    }
                },

                onlocalstream: function (stream) {
                    Janus.attachMediaStream(document.getElementById("myVideo"), stream);
                }
            });
        },

        error: function (error) {
            console.error("Janus ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨", error);
        },

        destroyed: function () {
            console.log("Janus ì„¸ì…˜ ì¢…ë£Œë¨");
        }
    });
}

function publishOwnFeed(useAudio) {
    sfutest.createOffer({
        media: {
            audioRecv: false, videoRecv: false,
            audioSend: useAudio, videoSend: true		// ìº /ë§ˆì´í¬ ì—†ì„ë•Œ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ì„ì‹œë¡œ falseì²˜ë¦¬
            										// ê¸°ì¡´ ê°’ useAudio, true
        },
        success: function (jsep) {
            const publish = {
                request: "configure",
                audio: useAudio,
                video: true
            };
            sfutest.send({ message: publish, jsep: jsep });
        },
        error: function (error) {
            console.error("ë¯¸ë””ì–´ publish ì˜¤ë¥˜", error);
        }
    });
}

//[jsflux] ìƒˆë¡œìš´ ìœ ì € ë“¤ì–´ì™”ì„ë•Œ
function newRemoteFeed(id, display, audio, video) {
	// A new feed has been published, create a new plugin handle and attach to it as a subscriber
	var remoteFeed = null;
	janus.attach(
		{
			plugin: "janus.plugin.videoroom",
			opaqueId: opaqueId,
			success: function(pluginHandle) {
				remoteFeed = pluginHandle;
				remoteFeed.simulcastStarted = false;
				Janus.log("Plugin attached! (" + remoteFeed.getPlugin() + ", id=" + remoteFeed.getId() + ")");
				Janus.log("  -- This is a subscriber");
				// We wait for the plugin to send us an offer
				var subscribe = {
					request: "join",
					room: selectedRoomId,
					ptype: "subscriber",
					feed: id,
					private_id: mypvtid
				};
				// In case you don't want to receive audio, video or data, even if the
				// publisher is sending them, set the 'offer_audio', 'offer_video' or
				// 'offer_data' properties to false (they're true by default), e.g.:
				// 		subscribe["offer_video"] = false;
				// For example, if the publisher is VP8 and this is Safari, let's avoid video
				if(Janus.webRTCAdapter.browserDetails.browser === "safari" &&
						(video === "vp9" || (video === "vp8" && !Janus.safariVp8))) {
					if(video)
						video = video.toUpperCase()
					toastr.warning("Publisher is using " + video + ", but Safari doesn't support it: disabling video");
					subscribe["offer_video"] = false;
				}
				remoteFeed.videoCodec = video;
				remoteFeed.send({ message: subscribe });
			},
			error: function(error) {
				Janus.error("  -- Error attaching plugin...", error);
				bootbox.alert("Error attaching plugin... " + error);
			},
			onmessage: function(msg, jsep) {
				Janus.debug(" ::: Got a message (subscriber) :::", msg);
				var event = msg["videoroom"];
				Janus.debug("Event: " + event);
				if(msg["error"]) {
					bootbox.alert(msg["error"]);
				} else if(event) {
					if(event === "attached") {
						// Subscriber created and attached
						for(var i=1;i<6;i++) {
							if(!feeds[i]) {
								feeds[i] = remoteFeed;
								remoteFeed.rfindex = i;
								break;
							}
						}
						remoteFeed.rfid = msg["id"];
						remoteFeed.rfdisplay = msg["display"];
						if(!remoteFeed.spinner) {
							var target = document.getElementById('videoremote'+remoteFeed.rfindex);
							remoteFeed.spinner = new Spinner({top:100}).spin(target);
						} else {
							remoteFeed.spinner.spin();
						}
						Janus.log("Successfully attached to feed " + remoteFeed.rfid + " (" + remoteFeed.rfdisplay + ") in room " + msg["room"]);
						$('#remote'+remoteFeed.rfindex).removeClass('hide').html(remoteFeed.rfdisplay).show();
					} else if(event === "event") {
						// Check if we got a simulcast-related event from this publisher
						var substream = msg["substream"];
						var temporal = msg["temporal"];
						if((substream !== null && substream !== undefined) || (temporal !== null && temporal !== undefined)) {
							if(!remoteFeed.simulcastStarted) {
								remoteFeed.simulcastStarted = true;
								// Add some new buttons
								addSimulcastButtons(remoteFeed.rfindex, remoteFeed.videoCodec === "vp8" || remoteFeed.videoCodec === "h264");
							}
							// We just received notice that there's been a switch, update the buttons
							updateSimulcastButtons(remoteFeed.rfindex, substream, temporal);
						}
					} else {
						// What has just happened?
					}
				}
				if(jsep) {
					Janus.debug("Handling SDP as well...", jsep);
					// Answer and attach
					remoteFeed.createAnswer(
						{
							jsep: jsep,
							// Add data:true here if you want to subscribe to datachannels as well
							// (obviously only works if the publisher offered them in the first place)
							media: { audioSend: false, videoSend: false },	// We want recvonly audio/video
							success: function(jsep) {
								Janus.debug("Got SDP!", jsep);
								var body = { request: "start", room: selectedRoomId };
								remoteFeed.send({ message: body, jsep: jsep });
							},
							error: function(error) {
								Janus.error("WebRTC error:", error);
								bootbox.alert("WebRTC error... " + error.message);
							}
						});
				}
			},
			iceState: function(state) {
				Janus.log("ICE state of this WebRTC PeerConnection (feed #" + remoteFeed.rfindex + ") changed to " + state);
			},
			webrtcState: function(on) {
				Janus.log("Janus says this WebRTC PeerConnection (feed #" + remoteFeed.rfindex + ") is " + (on ? "up" : "down") + " now");
			},
			onlocalstream: function(stream) {
				// The subscriber stream is recvonly, we don't expect anything here
			},
			onremotestream: function(stream) {
				Janus.debug("Remote feed #" + remoteFeed.rfindex + ", stream:", stream);
				const rawId = remoteFeed.rfid || remoteFeed.getId();
				const id = `rf${rawId}`;
				const display = remoteFeed.rfdisplay || `user-${id}`;

				// ì´ë¯¸ ìˆëŠ” ê²½ìš° ì œê±° í›„ ì¬ìƒì„± (ì¤‘ë³µ ë°©ì§€)
// 				$(`#remote-box-${id}`).remove();
				
				// ë¹„ë””ì˜¤ ì˜ì—­ ë™ì  ìƒì„±
				const remoteBox = $('<div>', {
				  class: 'remote-box',
				  id: `remote-box-${id}`,
				  style: 'position: relative;'
				});
				
				remoteBox.append(`<span class="label" id="label-${id}">${display}</span>`);
				remoteBox.append(`<video id="remotevideo-${id}" autoplay playsinline width="100%" height="100%" class="rounded centered relative hide"></video>`);
				remoteBox.append(`<span class="label label-primary hide" id="curres-${id}" style="position: absolute; bottom: 0px; left: 0px; margin: 5px;"></span>`);
				remoteBox.append(`<span class="label label-info hide" id="curbitrate-${id}" style="position: absolute; bottom: 0px; right: 0px; margin: 5px;"></span>`);
				
				const audioControls = $(
					'<div class="audio-controls" style="margin-top: 6px;">' +
					'<label for="volume-' + id + '">&#128266;</label>' +
					'<input type="range" id="volume-' + id + '" min="0" max="1" step="0.01" value="1" style="width: 100px;" />' +
					'<br />' +
					'<label for="sink-' + id + '">&#127911;</label>' +
					'<select id="sink-' + id + '"><option value="">ê¸°ë³¸ ì¶œë ¥</option></select>' +
					'</div>'
				);
				
// 				const audioControls = $(`
// 				  <div class="audio-controls" style="margin-top: 6px;">
// 				  	<label for="volume-${id}">&#128266;</label>
// 				    <input type="range" id="volume-${id}" min="0" max="1" step="0.01" value="1" style="width: 100px;" />
// 				    <br />
// 				    <label for="sink-${id}">&#127911;</label>
// 				    <select id="sink-${id}"><option value="">ê¸°ë³¸ ì¶œë ¥</option></select>
// 				  </div>
// 				`);
				remoteBox.append(audioControls);
				
				$('#remoteContainer').append(remoteBox);
				
				// ğŸ”Š ë³¼ë¥¨ ì¡°ì ˆ
				document.getElementById(`volume-${id}`).addEventListener('input', e => {
					const vol = parseFloat(e.target.value);
					const vid = document.getElementById(`remotevideo-${id}`);
					if (vid) vid.volume = vol;
				});

				// ğŸ§ ì˜¤ë””ì˜¤ ì¶œë ¥ ì¥ì¹˜ ì„ íƒ
				navigator.mediaDevices.enumerateDevices().then(devices => {
				    const outputs = devices.filter(d => d.kind === 'audiooutput');
				    const select = document.getElementById(`sink-${id}`);
				    outputs.forEach(device => {
				    	const opt = document.createElement('option');
				    	opt.value = device.deviceId;
				    	opt.textContent = device.label || device.deviceId;
				    	select.appendChild(opt);
				    });
				});
				
				document.getElementById(`sink-${id}`).addEventListener('change', function(e) {
				    const sinkId = e.target.value;
				    const video = document.getElementById(`remotevideo-${id}`);
				    if (!video.setSinkId) {
				      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” setSinkIdë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
				      return;
				    }
				    video.setSinkId(sinkId).then(() => {
				    	console.log(`ğŸ”ˆ [${id}] ì¶œë ¥ ì¥ì¹˜ ì„¤ì • ì™„ë£Œ: ${sinkId}`);
					}).catch(err => {
					   console.error("setSinkId ì˜¤ë¥˜:", err);
					});
				});
				
				// ğŸ¥ ì˜ìƒ ì—°ê²°
				const videoEl = document.getElementById(`remotevideo-${id}`);
				console.log("í˜„ì¬ ì—¬ê¸°");
				Janus.attachMediaStream(videoEl, stream);
				videoEl.classList.remove('hide');     // ğŸ‘ˆ ë°˜ë“œì‹œ í•„ìš”
				videoEl.style.display = 'block';      // ğŸ‘ˆ ì¶”ê°€ì ìœ¼ë¡œ ëª…ì‹œ

				// ğŸ¯ í•´ìƒë„/ë¹„íŠ¸ë ˆì´íŠ¸ ì¶”ì 
				$(videoEl).on("playing", function () {
				    const w = this.videoWidth;
				    const h = this.videoHeight;
				    $(`#curres-${id}`).removeClass('hide').text(`${w}x${h}`);
				});

				if (!bitrateTimer[id]) {
				    bitrateTimer[id] = setInterval(() => {
				    	const bitrate = remoteFeed.getBitrate();
				    	const w = videoEl.videoWidth;
				    	const h = videoEl.videoHeight;
				    	$(`#curbitrate-${id}`).removeClass('hide').text(bitrate);
				      	if (w && h) $(`#curres-${id}`).removeClass('hide').text(`${w}x${h}`);
					}, 1000);
				}
				
				const videoTracks = stream.getVideoTracks();
				console.log("ğŸ¥ videoTracks", videoTracks);
				if (!videoTracks || videoTracks.length === 0) {
					  // ë¹„ë””ì˜¤ íŠ¸ë™ì´ ì—†ìœ¼ë©´ ê²€ì€ ë°°ê²½ì˜ placeholderë§Œ ìœ ì§€
					  const videoEl = document.getElementById(`remotevideo-${id}`);
					  $(videoEl)
					    .removeClass('hide')
					    .css({
					      backgroundColor: 'black',
					      display: 'block'
					    });

					  // í”Œë ˆì´ ì´ë²¤íŠ¸ ë¬´ì‹œ ì²˜ë¦¬
					  $(videoEl).off('playing');
				}


// 				var addButtons = false;
// 				if($('#remotevideo'+remoteFeed.rfindex).length === 0) {
// 					addButtons = true;
					
					
// 			        // ë³¼ë¥¨ ì¡°ì ˆ ì´ë²¤íŠ¸ ë°”ì¸ë”©
// 			        document.getElementById(`volume-${remoteFeed.rfindex}`).addEventListener('input', function(e) {
// 			            const vol = parseFloat(e.target.value);
// 			            const video = document.getElementById(`remotevideo${remoteFeed.rfindex}`);
// 			            if (video) video.volume = vol;
// 			        });
					
// 			        // ì˜¤ë””ì˜¤ ì¶œë ¥ ì¥ì¹˜ ëª©ë¡ ì±„ìš°ê¸°
// 			        navigator.mediaDevices.enumerateDevices().then(devices => {
// 			            const outputs = devices.filter(d => d.kind === 'audiooutput');
// 			            const select = document.getElementById(`sink-${remoteFeed.rfindex}`);
// 			            outputs.forEach(d => {
// 			                const option = document.createElement('option');
// 			                option.value = d.deviceId;
// 			                option.textContent = d.label || d.deviceId;
// 			                select.appendChild(option);
// 			            });
// 			        });

// 			        // ì˜¤ë””ì˜¤ ì¶œë ¥ ì¥ì¹˜ ì„ íƒ ì´ë²¤íŠ¸ ë°”ì¸ë”©
// 			        document.getElementById(`sink-${remoteFeed.rfindex}`).addEventListener('change', function(e) {
// 			            const sinkId = e.target.value;
// 			            const videoEl = document.getElementById(`remotevideo${remoteFeed.rfindex}`);
// 			            if (!videoEl.setSinkId) {
// 			                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” setSinkIdë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
// 			                return;
// 			            }
// 			            videoEl.setSinkId(sinkId).then(() => {
// 			                console.log(`Feed #${remoteFeed.rfindex}ì˜ ì˜¤ë””ì˜¤ ì¶œë ¥ ì¥ì¹˜ê°€ ${sinkId || "ê¸°ë³¸"}ë¡œ ì„¤ì •ë¨`);
// 			            }).catch(err => {
// 			                console.error("setSinkId ì˜¤ë¥˜:", err);
// 			            });
// 			        });
			        
// 					// ì˜ìƒ ì¤€ë¹„ ì´ë²¤íŠ¸
// 					$("#remotevideo"+remoteFeed.rfindex).bind("playing", function () {
// 						if(remoteFeed.spinner)
// 							remoteFeed.spinner.stop();
// 						remoteFeed.spinner = null;
// 						$('#waitingvideo'+remoteFeed.rfindex).remove();
// 						if(this.videoWidth)
// 							$('#remotevideo'+remoteFeed.rfindex).removeClass('hide').show();
// 						var width = this.videoWidth;
// 						var height = this.videoHeight;
// 						$('#curres'+remoteFeed.rfindex).removeClass('hide').text(width+'x'+height).show();
// 						if(Janus.webRTCAdapter.browserDetails.browser === "firefox") {
// 							// Firefox Stable has a bug: width and height are not immediately available after a playing
// 							setTimeout(function() {
// 								var width = $("#remotevideo"+remoteFeed.rfindex).get(0).videoWidth;
// 								var height = $("#remotevideo"+remoteFeed.rfindex).get(0).videoHeight;
// 								$('#curres'+remoteFeed.rfindex).removeClass('hide').text(width+'x'+height).show();
// 							}, 2000);
// 						}
// 					});
// 				}
				
// 				// ìŠ¤íŠ¸ë¦¼ ì—°ê²°
// 				Janus.attachMediaStream($('#remotevideo'+remoteFeed.rfindex).get(0), stream);
				
// 				// ë¹„ë””ì˜¤ íŠ¸ë™ ì—†ì„ ê²½ìš°
// 				var videoTracks = stream.getVideoTracks();
// 				if(!videoTracks || videoTracks.length === 0) {
// 					// No remote video
// 					$('#remotevideo'+remoteFeed.rfindex).hide();
// 					if($('#videoremote'+remoteFeed.rfindex + ' .no-video-container').length === 0) {
// 						$('#videoremote'+remoteFeed.rfindex).append(
// 							'<div class="no-video-container">' +
// 								'<i class="fa fa-video-camera fa-5 no-video-icon"></i>' +
// 								'<span class="no-video-text">No remote video available</span>' +
// 							'</div>');
// 					}
// 				} else {
// 					$('#videoremote'+remoteFeed.rfindex+ ' .no-video-container').remove();
// 					$('#remotevideo'+remoteFeed.rfindex).removeClass('hide').show();
// 				}
// 				if(!addButtons)
// 					return;
// 				if(Janus.webRTCAdapter.browserDetails.browser === "chrome" || Janus.webRTCAdapter.browserDetails.browser === "firefox" ||
// 						Janus.webRTCAdapter.browserDetails.browser === "safari") {
// 					$('#curbitrate'+remoteFeed.rfindex).removeClass('hide').show();
// 					bitrateTimer[remoteFeed.rfindex] = setInterval(function() {
// 						// Display updated bitrate, if supported
// 						var bitrate = remoteFeed.getBitrate();
// 						$('#curbitrate'+remoteFeed.rfindex).text(bitrate);
// 						// Check if the resolution changed too
// 						var width = $("#remotevideo"+remoteFeed.rfindex).get(0).videoWidth;
// 						var height = $("#remotevideo"+remoteFeed.rfindex).get(0).videoHeight;
// 						if(width > 0 && height > 0)
// 							$('#curres'+remoteFeed.rfindex).removeClass('hide').text(width+'x'+height).show();
// 					}, 1000);
// 				}
			},
			oncleanup: function() {
				const rawId = remoteFeed.rfid || remoteFeed.getId();
			    const index = remoteFeed.rfindex;
			    const id = `rf${rawId}`;

			    Janus.log(" ::: Got a cleanup notification (remote feed " + id + ") :::");
			    
			    // remote box DOM ì œê±°
				$(`#remote-box-${id}`).remove();
			    
				 // ë¹„íŠ¸ë ˆì´íŠ¸ íƒ€ì´ë¨¸ ì œê±°
				if (bitrateTimer[id]) {
				    clearInterval(bitrateTimer[id]);
				    bitrateTimer[id] = null;
				}
				
				// Spinner ì •ë¦¬
				if(remoteFeed.spinner)
					remoteFeed.spinner.stop();
				remoteFeed.spinner = null;
				
				// feeds ë°°ì—´ì—ì„œ í•´ë‹¹ feed ì œê±°
				feeds[remoteFeed.rfindex] = null;
				
				// ê¸°íƒ€ ë‚¨ì€ UI ìš”ì†Œ ì œê±°
				$('#remotevideo'+remoteFeed.rfindex).remove();
				$('#waitingvideo'+remoteFeed.rfindex).remove();
				$('#novideo'+remoteFeed.rfindex).remove();
				$('#curbitrate'+remoteFeed.rfindex).remove();
				$('#curres'+remoteFeed.rfindex).remove();
				if(bitrateTimer[remoteFeed.rfindex])
					clearInterval(bitrateTimer[remoteFeed.rfindex]);
				bitrateTimer[remoteFeed.rfindex] = null;
				remoteFeed.simulcastStarted = false;
				$('#simulcast'+remoteFeed.rfindex).remove();
				console.log("Unpublished");
				$('#videolocal').empty();
				$('#publish').show();
				$('#remoteContainer').empty();

				
				console.log(`ğŸ‘‹ feed ${id} cleanup ì™„ë£Œ`);
				
			}
		});
}



</script>

</body>
</html>