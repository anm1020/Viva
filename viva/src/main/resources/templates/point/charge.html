<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ν¬μΈνΈ μ¶©μ „</title>
  <script src="https://code.jquery.com/jquery-latest.js"></script>
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>
<body>
  <h2 th:text="'μ•λ…•ν•μ„Έμ”, ' + ${userName} + 'λ‹ π‘‹'"></h2>
  <p>ν„μ¬ λ³΄μ  ν¬μΈνΈ: <span th:text="${point}">0</span>μ›</p>

  <button class="charge-btn" data-amount="5000">π’Έ 5000μ› μ¶©μ „</button>
  <button class="charge-btn" data-amount="10000">π’Έ 10000μ› μ¶©μ „</button>

  <script th:inline="javascript">
    const userId = /*[[${userId}]]*/ 'guest';
    const userTel = /*[[${userTel}]]*/ '010-0000-0000';

    IMP.init("imp14397622"); // ν¬νΈμ› ID

    $('.charge-btn').on('click', function () {
      const amount = $(this).data('amount');

      IMP.request_pay({
        pay_method: 'card',
        channelKey : "channel-key-01764171-b249-4c16-9d18-e9174fa8e611",
        merchant_uid: 'order_' + new Date().getTime(),
        name: `${amount}μ› ν¬μΈνΈ μ¶©μ „`,
        amount: amount,
        buyer_tel: userTel
      }, function (rsp) {
        if (!rsp.success) {
          alert('κ²°μ  μ‹¤ν¨: ' + rsp.error_msg);
          return;
        }

        $.ajax({
          type: 'POST',
          url: '/point/save',
          contentType: 'application/json',
          data: JSON.stringify({
            userId: userId,
            payResno: rsp.merchant_uid,
            payAmount: rsp.paid_amount,
            resId: 0
          }),
          success: function (data) {
            alert('μ¶©μ „ μ„±κ³µ! + ' + data.amount + 'μ›');
            location.href = '/reservation/mylist';
          },
          error: function () {
            alert('μ¶©μ „ μ²λ¦¬ μ¤‘ μ¤λ¥ λ°μƒ');
          }
        });
      });
    });
  </script>
</body>
</html>
