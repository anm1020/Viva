<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì˜ˆì•½ ê²°ê³¼</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" href="/css/book.css" />
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>
<body>
	<div th:replace="fragments/header :: headerFragment"></div>

	
  <div class="result-wrapper">
    <h1>ì˜ˆì•½ ê²°ê³¼</h1>

    <div th:if="${reservation != null}">
      <table class="reservation-result-table">
        <tr>
          <th>ì˜ˆì•½ë²ˆí˜¸</th>
          <td th:text="${reservation.resId}">â€”</td>
        </tr>
        <tr>
          <th>ì˜ˆì•½ì¼ì‹œ</th>
          <td>
            <span th:text="${reservation.reservedDate}">yyyy-MM-dd</span>
            <span th:text="${reservation.reservedTime}">HH:mm</span>
          </td>
        </tr>
        <tr>
          <th>ìƒíƒœ</th>
          <td>
            <span th:switch="${reservation.resStatus}">
              <span th:case="'pending'">ê²°ì œ ëŒ€ê¸°</span>
              <span th:case="'confirmed'">ê²°ì œ ì™„ë£Œ</span>
              <span th:case="'cancelled'">ì·¨ì†Œë¨</span>
              <span th:case="*">-</span>
            </span>
          </td>
        </tr>
      </table>

			<!-- ì¹´ë“œ ê²°ì œ ë§í¬ -->
			  <div class="btn-group" th:if="${reservation.resStatus == 'pending'}">
				  <button type="button" class="btn-card btn-pay" 
                th:data-resid="${reservation.resId}">
          ğŸ’³ ì¹´ë“œ ê²°ì œ
        </button>
			<!-- âœ… í¬ì¸íŠ¸ ê²°ì œ ë²„íŠ¼ -->
				 <button id="btn-point-pay" th:data-userid="${userId}"
          th:data-resid="${reservation.resId}" data-amount="5000" class="btn-point">
          ğŸ’° í¬ì¸íŠ¸ë¡œ ê²°ì œ
        </button>
			</div>
		</div>

		<div th:if="${reservation == null}">
			<p>ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
			<p th:text="${error}"></p>
		</div>

		<p>
			<a th:href="@{/mypage(tab='schedule')}" class="back-link">ë‚´ ì˜ˆì•½ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
		</p>
	</div>

	<!-- âœ… í¬ì¸íŠ¸ ê²°ì œ AJAX -->
	 <script>
    $('#btn-point-pay').on('click', function() {
      const userId = $(this).data('userid');
      const resId = $(this).data('resid');
      const amount = $(this).data('amount');

      if (!confirm(amount + ' í¬ì¸íŠ¸ë¡œ ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      $.ajax({
        type: 'POST',
        url: '/point/use',
        data: { userId, resId, amount },
        success: function(response) {
          alert("í¬ì¸íŠ¸ ê²°ì œ ì™„ë£Œ!");
          location.href = "/reservation/mylist";
        },
        error: function(xhr) {
          alert("ê²°ì œ ì‹¤íŒ¨: " + xhr.responseText);
        }
      });
    });
  </script>

  <!-- ì¹´ë“œ ê²°ì œ ì•„ì„í¬íŠ¸ ì—°ë™ -->
  <script>
    $(function(){
      IMP.init("imp14397622"); // ì•„ì„í¬íŠ¸ ê°€ë§¹ì  ì‹ë³„ì½”ë“œ

      $(document).on('click', '.btn-pay.btn-card', function(e) {
        e.preventDefault();

        const resId = $(this).data('resid');
        const userId = /*[[${userId}]]*/ 'UNKNOWN'; // ì„œë²„ì—ì„œ ì„¸ì…˜ ë“±ìœ¼ë¡œ ë°›ì„ ê²ƒ
        const amount = 5000; // ê²°ì œ ê¸ˆì•¡ (í•„ìš” ì‹œ ë™ì ìœ¼ë¡œ ë³€ê²½)

        IMP.request_pay({
          channelKey : "channel-key-01764171-b249-4c16-9d18-e9174fa8e611",
          pay_method: 'card',
          merchant_uid: 'order_' + new Date().getTime(),
          name: 'ë©´ì ‘ ì˜ˆì•½ ê²°ì œ',
          amount: amount,
          buyer_tel: '010-0000-0000'
        }, function(rsp) {
          if (!rsp.success) {
            alert('ê²°ì œ ì‹¤íŒ¨: ' + rsp.error_msg);
            return;
          }

          // ê²°ì œ ì„±ê³µ ì‹œ ì„œë²„ì— ê²°ì œ ì •ë³´ ì €ì¥ ìš”ì²­
          $.ajax({
            type: 'POST',
            url: '/payment/save',
            contentType: 'application/json',
            data: JSON.stringify({
              payResno: rsp.merchant_uid,
              payAmount: rsp.paid_amount,
              payStatus: rsp.status,
              resId: resId,
              userId: userId,
              payType: "CARD"
            }),
            success: function(data) {
              alert('ì¹´ë“œê²°ì œ ì™„ë£Œ');
              location.href = "/mypage?tab=schedule";
            },
            error: function(xhr) {
              alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          });
        });
      });
    });
	</script>


	<div th:replace="fragments/footer :: footerFragment"></div>

</body>
</html>
