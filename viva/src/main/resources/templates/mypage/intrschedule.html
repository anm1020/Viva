<div th:fragment="fragment" class="reservation-list">
	<!-- âœ… 1. ë°›ì€ ì˜ˆì•½ ì¼ì • -->
	<h2 class="reservation-title">ì˜ˆì•½ ì¼ì •</h2>
	<table class="reservation-table">
		<thead>
			<tr>
				<th>ì˜ˆì•½ë²ˆí˜¸</th>
				<th>íšŒì› ì´ë¦„</th>
				<th>ì˜ˆì•½ì¼</th>
				<th>ì˜ˆì•½ì‹œê°„</th>
				<th>ì˜ˆì•½ ìƒì„±ì¼</th>
				<th>ìƒíƒœ</th>
				<th>ìƒì„±</th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="r : ${reservations}">
				<td th:text="${r.resId}">1</td>
				<td th:text="${memNames[r.memId]} ?: 'ì•Œ ìˆ˜ ì—†ìŒ'">ì˜ˆì•½ì ì´ë¦„</td>
				<td th:text="${r.reservedDate}">2025-07-09</td>
				<td th:text="${r.reservedTime}">12:00</td>
				<td th:text="${#dates.format(r.resCreateDt, 'yyyy-MM-dd HH:mm')}">2025-07-06
					17:00</td>
				<td><span class="status"
					th:classappend="${r.resStatus=='pending'?'pending':r.resStatus=='confirmed'?'confirmed':r.resStatus=='cancelled'?'cancelled':''}"
					th:text="${r.resStatus=='pending'?'ê²°ì œ ì „':r.resStatus=='confirmed'?'ê²°ì œ ì™„ë£Œ':r.resStatus=='cancelled'?'ì·¨ì†Œë¨':'ì•Œ ìˆ˜ ì—†ìŒ'}">
				</span></td>
				<td>
					<button class="creation">ìƒì„±</button>
				</td>
			</tr>
		</tbody>
	</table>
	<!-- í˜„ì§„ ì¶”ê°€ -->
	<div id="createRoomModal" class="modal" style="display:none;">
		<div class="modal-content">
		    <h2>ë©´ì ‘ ë°© ìƒì„±</h2>
		    <label for="intrRoomTitle">ë°© ì œëª©:</label> 
		    <input type="text" id="intrRoomTitle" name="intrRoomTitle" /></label><br>
		    <label for="roomPw">ë¹„ë°€ë²ˆí˜¸:</label>
		    <input type="password" id="roomPw" name="roomPw" /></label><br>
		    <label for="participantCount">ìµœëŒ€ ì°¸ê°€ ì¸ì›:</label>
		    <input type="number" id="participantCount" name="participantCount" min="2" max="6" value="2" /></label><br>
		    <input type="hidden" id="host_id" name="host_id" th:value=${users.userId}>
		    <button id="btn-createRoom" class="btn-createRoom">ë°© ìƒì„±</button>
		    <button id="btn-close" class="btn-close">ì·¨ì†Œ</button>
		</div>
	</div>
	<script>
		$(document).off("click", ".creation").on("click", ".creation", function () {
		    $("#createRoomModal").show();
		    $("#intrRoomTitle").val("");
		    $("#roomPw").val("");
		    $("#participantCount").val("2");
		});
	
		// ëª¨ë‹¬ ë‹«ê¸°
		$(document).off("click", ".modal .btn-close").on("click", ".modal .btn-close", function () {
		    $("#createRoomModal").hide();
		});
		
		// ë°”ê¹¥ ì˜ì—­ í´ë¦­ì‹œ ë‹«ê¸° (ì„ íƒ)
		$(document).off("mousedown", ".modal").on("mousedown", ".modal", function (e) {
		    if ($(e.target).is(".modal")) $("#createRoomModal").fadeOut(100);
		});
		
		// ë°© ìƒì„± 
		$(document).off("click", "#btn-createRoom").on("click", "#btn-createRoom", function () {
		    const title = $("#intrRoomTitle").val();
		    const host_id = $("#host_id").val();
		    const roomPw = $("#roomPw").val();
		    const participantCount = $("#participantCount").val();

		    // ê°„ë‹¨ ìœ íš¨ì„±
		    if (!title) return alert("ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

		    fetch("/api/meeting/roomcreate", {
		        method: "POST",
		        headers: { "Content-Type": "application/json" },
		        body: JSON.stringify({
		            intrRoomTitle: title,
		            roomPw: roomPw,
		            hostId: host_id,
		            participantCount: participantCount
		        })
		    })
		    .then(res => {
		        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
		        return res.json();
		    })
		    .then(data => {
		        alert(`ë°© ìƒì„± ì™„ë£Œ: ${data.intrRoomTitle}`);

		        const roomId = data.intrRoomId;
		        const hostId = data.hostId;

		        // Janus ì„¸ì…˜ ìƒì„±(ì•„ë˜ í•¨ìˆ˜ ì°¸ê³ )
		        return createRoomsOnJanus(roomId, hostId, participantCount);
		    })
		    .then(() => {
		        // ëª¨ë‘ ì™„ë£Œ í›„
		        $("#createRoomModal").hide();
		        $("#contentArea").load("/reservation/intrmypage"); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨(SPA)
		    })
		    .catch(err => {
		        alert("ë°© ìƒì„± ì‹¤íŒ¨: " + err.message);
		    });
		});

		var version = 1.2;
		var server = null;
		server = "https://janus.jsflux.co.kr/janus";
		var janus = null;
		var sfutest = null;
		var mypvtid = null;
		var opaqueId = "videoroom-" + Janus.randomString(12);
		var selectedRoomId = null;
		var displayName = null;
		
		function createRoomsOnJanus(roomId, hostId, participantCount) {
		        Janus.init({
		            debug: "all",
		            callback: function () {
		                janus = new Janus({
		                    server: server, // Janus ì„œë²„ ì£¼ì†Œ
		                    success: function () {
		                        janus.attach({
		                        	// ë¹„ë””ì˜¤ë£¸ í”ŒëŸ¬ê·¸ì¸ attach
		                            plugin: "janus.plugin.videoroom",
		                            success: function (videohandle) {
		                                videohandle.send({
		                                    message: {
		                                        request: "create",
		                                        room: roomId,
		                                        description: `Room for host ${hostId}`,
		                                        publishers: participantCount,
		                                        data: true
		                                    }
		                                });
		                                // ì‹¤ì œ ìƒì„± ê²°ê³¼ë¥¼ ë°›ìœ¼ë ¤ë©´ onmessage í•¸ë“¤ ì¶”ê°€ë„ ê°€ëŠ¥
		                                alert("videoroom ìƒì„± ì„±ê³µ");
// 		                                resolve();
			                            console.log("ğŸ“¹ Video room created");
			        	            },
			        	            error: function (err) {
			        	              console.error("Video plugin attach error", err);
			        	            }
		        	           });
		        	        },
		        	        error: function (err) {
		        	          console.error("Janus session error", err);
		        	        },
		        	        destroyed: function () {
		        	          console.log("Janus session destroyed");
		        	        }
		      	      });
		      	    }
		      	  });
		      }
		
		
	</script>

	<!-- âœ… 2. ë¹„í™œì„±í™”ëœ ë‚ ì§œ/ì‹œê°„ -->
	<h2>ë¹„í™œì„±í™”í•œ ì‹œê°„</h2>
	<table class="reservation-table">
		<thead>
			<tr>
				<th>ë‚ ì§œ</th>
				<th>ì‹œê°„</th>
				<th>ì‚­ì œ</th>
			</tr>
		</thead>
		<tbody>
			<tr th:if="${#lists.isEmpty(disabledList)}">
				<td colspan="2">ë¹„í™œì„±í™”ëœ ì‹œê°„ ì—†ìŒ</td>
			</tr>
			<tr th:each="d : ${disabledList}">
				<td th:text="${d.disabledDate}">2025-07-11</td>
				<td th:text="${d.disabledTime}">13:00</td>
				<td>
				<button type="button" class="btn-delete" th:data-id="${d.disId}">ì‚­ì œ</button>
				</td>
			</tr>
		</tbody>
	</table>

	<!-- âœ… 3. ë¹„í™œì„±í™” ë“±ë¡ í¼ (ë‹¬ë ¥) -->
	<h2>ë‚ ì§œ/ì‹œê°„ ë¹„í™œì„±í™” ë“±ë¡</h2>
	<form id="disableForm" th:action="@{/reservation/blockDate}"
		method="post">
		<label> ë‚ ì§œ: <input type="text" id="datePicker" name="date"
			required>
		</label> <label> ì‹œê°„: <select name="time" required>
				<option value="">-- ì‹œê°„ ì„ íƒ --</option>
				<option value="09:00">09:00</option>
				<option value="10:00">10:00</option>
				<option value="11:00">11:00</option>
				<option value="11:00">12:00</option>
				<option value="13:00">13:00</option>
				<option value="14:00">14:00</option>
				<option value="15:00">15:00</option>
				<option value="15:00">16:00</option>
				<option value="15:00">17:00</option>
				<option value="15:00">18:00</option>
		</select>
		</label>
		<button type="submit" class="btn-register">ë¹„í™œì„±í™” ë“±ë¡</button>
	</form>

	<!--ë“±ë¡ -->
	<script>
	$(document).off("submit", "#disableForm").on("submit", "#disableForm", function(e) {
		  e.preventDefault();

		  const form = $(this);
		  const date = form.find("input[name='date']").val();
		  const time = form.find("select[name='time']").val();

		  $.ajax({
		    url: "/reservation/blockDate",
		    method: "POST",
		    data: { date, time },
		    success: function() {
		      // ë“±ë¡ ì„±ê³µ ì‹œ ë‹¤ì‹œ fragment ë¡œë“œ
		      $("#contentArea").load("/reservation/intrmypage", function() {
		        // flatpickr ë‹¤ì‹œ ì´ˆê¸°í™”
		        flatpickr("#datePicker", {
		          dateFormat: "Y-m-d",
		          minDate: "today"
		        });
		      });
		    },
		    error: function(xhr) {
		      if (xhr.status === 409) {
		        alert("ì´ë¯¸ ë“±ë¡ëœ ë‚ ì§œ+ì‹œê°„ì…ë‹ˆë‹¤!");
		      } else {
		        alert("ë“±ë¡ ì‹¤íŒ¨!");
		      }
		    }
		  });
		});

	</script>
	<script>
	$(document).off("click", ".btn-delete").on("click", ".btn-delete", function () {
		  const id = $(this).data("id");

		  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

		  $.ajax({
		    type: "POST",
		    url: "/reservation/deleteDisabled",
		    data: { id: id },
		    success: function () {
		      // fragment ë‹¤ì‹œ ë¡œë“œ
		      $("#contentArea").load("/reservation/intrmypage", function () {
		        flatpickr("#datePicker", {
		          dateFormat: "Y-m-d",
		          minDate: "today"
		        });
		      });
		    },
		    error: function () {
		      alert("ì‚­ì œ ì‹¤íŒ¨!");
		    }
		  });
		});

</script>



</div>