<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ë©´ì ‘ê´€ ìƒì„¸</title>
<link rel="stylesheet" th:href="@{/css/interviewer.css}">
<link rel="stylesheet" th:href="@{/css/reservation.css}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://code.jquery.com/jquery-latest.js"></script>

</head>
<body>

	<div class="detail-container">
		<div class="interviewer-profile">
			<img th:src="@{${interviewer.intrImage}}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
				class="profile-img" />
			<div class="info-box">
				<p>
					<strong>ì´ë¦„:</strong> <span th:text="${interviewer.userName}"></span>
				</p>
				<p>
					<strong>ê²½ë ¥:</strong> <span th:text="${interviewer.userCareer}"></span>
				</p>
				<p>
					<strong>ì§ë¬´:</strong> <span th:text="${interviewer.intrCate}"></span>
				</p>
				<p>
					<strong>ë³´ìœ  ìŠ¤í‚¬:</strong> <span th:text="${interviewer.userSkill}"></span>
				</p>
				<p>
					<strong>ìƒë‹´ ê°€ê²©:</strong> <span th:text="${interviewer.intrPrice}">0</span>
					ì›
				</p>
			</div>

		</div>

		<!-- âœ… ìê¸°ì†Œê°œ ì˜ì—­ -->
		<div class="detail-content-section">
			<h3>ìê¸°ì†Œê°œ</h3>
			<div class="detail-content-box">
				<p th:text="${interviewer.intrContent}">ìƒë‹´ ë°©ì‹, ê°•ì , ì´ë ¥ ë“±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
				</p>
			</div>
		</div>

		<!-- âœ… í›„ê¸° ì„¹ì…˜ -->
		<hr>
		<div class="review-section">
			<h3>í›„ê¸°</h3>
			<!-- ë¦¬ë·° ë“±ë¡ í¼ -->
			<form
				th:action="@{'/interviewer/' + ${interviewer.intrId} + '/review'}"
				method="post" style="margin-bottom: 30px;">
				<label>ë³„ì : <select name="score" required>
						<option value="5">5.0</option>
						<option value="4.5">4.5</option>
						<option value="4">4.0</option>
						<option value="3.5">3.5</option>
						<option value="3">3.0</option>
						<option value="2.5">2.5</option>
						<option value="2">2.0</option>
						<option value="1.5">1.5</option>
						<option value="1">1.0</option>
				</select>
				</label> <label>ë‚´ìš©: <input type="text" name="content"
					maxlength="300" required style="width: 300px;">
				</label>
				<button type="submit">ë“±ë¡</button>
			</form>
			<!-- íšŒì›ë§Œ ì˜ˆì•½ ë²„íŠ¼ ì´ìŠ¬ -->
			<div
				th:if="${session.user != null and session.user.userRole != 'intr'}">
				<div style="margin-top: 40px; text-align: center;">
					<button type="button" id="btn-open-popup" class="reserve-btn">ğŸ‘‰
						ì˜ˆì•½í•˜ëŸ¬ ê°€ê¸°</button>
				</div>

				<!-- âœ… ì˜ˆì•½ í¼ fragment ì‚½ì… -->
				<!-- âœ… ì˜ˆì•½ í¼: ì²˜ìŒì—” ì•ˆ ë³´ì´ë„ë¡ ìˆ¨ê¹€ -->
				<div id="reservation-box" style="display: none; margin-top: 30px;">
				<input type="hidden" id="intrUserId" th:value="${intrUserId}" />
					<div th:replace="interviewer/reservationform :: reservationForm"></div>
				</div>
			</div>

			<!-- âœ… ë©´ì ‘ê´€ì€ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ ì¶œë ¥ -->
			<div
				th:if="${session.user != null and session.user.userRole == 'intr'}"
				style="margin-top: 40px; text-align: center;">
				<span style="color: gray; font-size: 13px;">(ë©´ì ‘ê´€ì€ ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)</span>
			</div>



			<!-- ë¦¬ë·° ëª©ë¡ -->
			<div th:each="r : ${reviews}">
				<div class="review-card">
					<p>
						<strong th:text="${r.userId}">ì‘ì„±ì</strong> | <span
							th:text="${#temporals.format(r.createdDt, 'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</span>
					</p>
					<p th:text="${r.content}">í›„ê¸° ë‚´ìš©</p>
					<p>
						â­ <span th:text="${r.score}">5.0</span>
					</p>
					<!-- ë³¸ì¸ ë¦¬ë·°ì—ë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë…¸ì¶œ (ì˜ˆì‹œ: principal.name == r.userId) -->
					<div
						th:if="${#authentication != null and #authentication.name == r.userId}">
						<!-- ìˆ˜ì • í¼ (ê°„ë‹¨í•˜ê²Œ inline form) -->
						<form
							th:action="@{'/interviewer/' + ${interviewer.intrId} + '/review/' + ${r.reviewNo} + '/edit'}"
							method="post" style="display: inline;">
							<select name="score" required>
								<option th:selected="${r.score == 5}" value="5">5.0</option>
								<option th:selected="${r.score == 4.5}" value="4.5">4.5</option>
								<option th:selected="${r.score == 4}" value="4">4.0</option>
								<option th:selected="${r.score == 3.5}" value="3.5">3.5</option>
								<option th:selected="${r.score == 3}" value="3">3.0</option>
								<option th:selected="${r.score == 2.5}" value="2.5">2.5</option>
								<option th:selected="${r.score == 2}" value="2">2.0</option>
								<option th:selected="${r.score == 1.5}" value="1.5">1.5</option>
								<option th:selected="${r.score == 1}" value="1">1.0</option>
							</select> <input type="text" name="content" th:value="${r.content}"
								maxlength="300" required style="width: 200px;">
							<button type="submit">ìˆ˜ì •</button>
						</form>
						<!-- ì‚­ì œ ë²„íŠ¼ -->
						<form
							th:action="@{'/interviewer/' + ${interviewer.intrId} + '/review/' + ${r.reviewNo} + '/delete'}"
							method="post" style="display: inline;">
							<button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	
<script th:inline="javascript">
  // ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” JSONì´ nullì¼ ê²½ìš° ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™”
  var reservedSlots = /*[[${reservedSlotsJson}]]*/ null;
  var disabledSlots = /*[[${disabledSlotsJson}]]*/ null;
  var intrId = /*[[${intrUserId}]]*/ null;

  reservedSlots = reservedSlots || {};
  disabledSlots = disabledSlots || {};
</script>

<script th:inline="javascript">
  var reservedSlots = /*[[${reservedSlotsJson}]]*/ '{}';
  var disabledSlots = /*[[${disabledSlotsJson}]]*/ '{}';

  reservedSlots = JSON.parse(reservedSlots);
  disabledSlots = JSON.parse(disabledSlots);
</script>

<script>
  $(document).ready(function () {
    let selectedDate = null;
    let selectedTime = null;

    $('#btn-open-popup').on('click', function () {
      $('#reservation-box').slideDown();

      flatpickr("#calendar", {
        inline: true,
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function (_, dateStr) {
          selectedDate = dateStr;

          const label = document.getElementById('selected-date-label');
          const koreanDate = new Date(dateStr).toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'short'
          });
          label.textContent = `${koreanDate} ì‹œê°„ ì„ íƒ`;

          document.getElementById('summary-date').textContent = koreanDate;

          // Step 2 ì‹œê°„ ì„ íƒ ì˜ì—­ ë³´ì´ê¸°
          $('#step-time').show();

          // Step 3 ì˜ˆì•½ ìš”ì•½ ì˜ì—­ ìˆ¨ê¸°ê¸° (ì‹œê°„ ì„ íƒ ì „)
          $('#step-summary').hide();

          renderTimes();
        }
      });
    });

    function renderTimes() {
      console.log('renderTimes called, selectedDate:', selectedDate);
      const grid = $('#times-grid').empty();
      if (!selectedDate) return;

      const reserved = (reservedSlots && reservedSlots[selectedDate]) || [];
      console.log('reserved:', reserved);

      const disabled = (disabledSlots && disabledSlots[selectedDate]) || [];
      console.log('disabled:', disabled);

      const blocked = [...reserved, ...disabled];
      console.log('blocked:', blocked);

      for (let h = 9; h <= 18; h++) {
        const t = (h < 10 ? '0' : '') + h + ':00';
        const isDisabled = blocked.includes(t);
        console.log('time:', t, 'isDisabled:', isDisabled);

        $('<button>')
          .text(t)
          .addClass(isDisabled ? 'disabled' : '')
          .prop('disabled', isDisabled)
          .on('click', function () {
            if (isDisabled) return;

            $('.times-grid button').removeClass('selected');
            $(this).addClass('selected');
            selectedTime = t;

            document.getElementById('summary-time').textContent = t;

            // Step 3 ì˜ˆì•½ ìš”ì•½ ì˜ì—­ ë³´ì´ê¸°
            $('#step-summary').show();
          })
          .appendTo(grid);
      }
    }

    $('#btn-confirm').on('click', function () {
      if (!selectedDate || !selectedTime) {
        return alert('ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }

      const payload = {
        intrId: intrId,
        reservedDate: selectedDate,
        reservedTime: selectedTime
      };
      console.log('ì˜ˆì•½í•  intrId:', intrId);
      $.ajax({
        type: 'POST',
        url: '/reservation/save',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function (resId) {
          window.location.href = `/reservation/result?resId=${resId}`;
        },
        error: function (xhr) {
          alert('ì˜ˆì•½ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + xhr.responseText);
        }
      });
    });
  });
</script>

</body>
</html>