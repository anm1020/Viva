<!DOCTYPE html>
<html lang="ko">
<head>

<meta charset="UTF-8">
<title>ë©´ì ‘ê´€ ìƒì„¸</title>
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" th:href="@{/css/interviewer.css}">
<link rel="stylesheet" th:href="@{/css/reservation.css}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://code.jquery.com/jquery-latest.js"></script>
</head>
<body>
 <!-- Header -->
  <div th:replace="fragments/header :: headerFragment"></div>

<div class="profile-layered">
  <div class="profile-container">
    <div class="profile-top">
      <div class="profile-photo">
        <img th:src="@{${interviewer.intrImage}}" alt="í”„ë¡œí•„ ì‚¬ì§„" style="width:100%;height:100%;object-fit:cover;"/>
      </div>
      <div class="profile-info">
        <div class="profile-actions">
          <!-- íšŒì›ë§Œ ì˜ˆì•½ ë²„íŠ¼ ì´ìŠ¬ -->
          <div th:if="${session.user != null and session.user.userRole != 'intr'}">
            <div style="margin-top: 40px; text-align: center;">
              <button type="button" id="btn-open-popup" class="reserve-btn">ğŸ‘‰
                ì˜ˆì•½í•˜ëŸ¬ ê°€ê¸°</button>
            </div>

            <!-- âœ… ì˜ˆì•½ í¼ fragment ì‚½ì… -->
            <!-- âœ… ì˜ˆì•½ í¼: ì²˜ìŒì—” ì•ˆ ë³´ì´ë„ë¡ ìˆ¨ê¹€ -->
            <div id="reservation-box" style="display: none; margin-top: 30px;">
              <input type="hidden" id="intrUserId" th:value="${intrUserId}" />
              <div th:replace="interviewer/reservationform :: reservationForm"></div>
            </div>
          </div>

          <!-- âœ… ë©´ì ‘ê´€ì€ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ ì¶œë ¥ -->
          <div
            th:if="${session.user != null and session.user.userRole == 'intr'}"
            style="margin-top: 40px; text-align: center;">
            <span style="color: gray; font-size: 13px;">(ë©´ì ‘ê´€ì€ ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)</span>
          </div>
          
          <!-- ë©´ì ‘ê´€ ë³¸ì¸ë§Œ ë³´ì´ëŠ” ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
          <div class="owner-actions" th:if="${role == 'intr' and #authentication.name == interviewer.userId}">
            <a class="edit-btn"
               th:href="@{'/interviewer/edit/' + ${interviewer.intrId}}">
              ìˆ˜ì •
            </a>
            <button class="delete-btn" 
                    th:onclick="'deleteInterviewer(' + ${interviewer.intrId} + ')'">
              ì‚­ì œ
            </button>
          </div>
        </div>
        
        <div><span class="profile-label">ì´ë¦„ :</span> <span th:text="${interviewer.userName}">ì´ë¦„</span></div>
        <div><span class="profile-label">ê²½ë ¥ :</span> <span th:text="${interviewer.userCareer}">ê²½ë ¥</span></div>
        <div><span class="profile-label">ì§ë¬´ :</span> <span th:text="${interviewer.intrCate}">ì§ë¬´</span></div>
        <div><span class="profile-label">ë³´ìœ  ìŠ¤í‚¬ :</span> <span th:text="${interviewer.userSkill}">ìŠ¤í‚¬</span></div>
      </div>
    </div>
  </div>
		<!-- âœ… ìê¸°ì†Œê°œ ì˜ì—­ -->
		<div class="detail-content-section">
			<h3>ìê¸°ì†Œê°œ</h3>
			<div class="detail-content-box">
				<p th:text="${interviewer.intrContent}">ìƒë‹´ ë°©ì‹, ê°•ì , ì´ë ¥ ë“±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
				</p>
			</div>
		</div>
  <!-- âœ… í›„ê¸° ì„¹ì…˜ -->
  <hr>
  <div class="review-section">
    <div class="review-header">
      <span>ë¦¬ë·° ì‘ì„±</span>
    </div>
    <!-- ë¦¬ë·° ë“±ë¡ í¼ -->
    <form th:action="@{'/interviewer/' + ${interviewer.intrId} + '/review'}" method="post" class="review-form">
      <div class="star-rating">
        <span class="star" data-value="1">â˜…</span>
        <span class="star" data-value="2">â˜…</span>
        <span class="star" data-value="3">â˜…</span>
        <span class="star" data-value="4">â˜…</span>
        <span class="star" data-value="5">â˜…</span>
        <input type="hidden" name="score" id="starScore" value="5" required>
      </div>
      <input type="text" name="content" maxlength="300" required placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="review-input">
      <button type="submit" class="review-submit-btn">ë“±ë¡</button>
    </form>
    <div class="review-list">
      <div class="review-item" th:each="r : ${reviews}">
        <div class="review-id" th:text="${r.userId}">ì•„ì´ë””</div>
        <div class="review-score">
          <span th:each="i : ${#numbers.sequence(1, 5)}">
            <span th:if="${i <= r.score}" class="star filled">â˜…</span>
            <span th:if="${i > r.score}" class="star">â˜…</span>
          </span>
        </div>
        <div class="review-content" th:text="${r.content}">ë¦¬ë·° ë‚´ìš©</div>
        <div class="review-actions">
          <!-- ì‚­ì œ: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì -->
          <form th:if="${#authentication != null and (#authentication.name == r.userId or role == 'admin')}"
                th:action="@{'/interviewer/' + ${interviewer.intrId} + '/review/' + ${r.reviewNo} + '/delete'}" method="post" style="display:inline;">
            <button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  // ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” JSONì´ nullì¼ ê²½ìš° ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™”
  var reservedSlots = /*[[${reservedSlotsJson}]]*/ null;
  var disabledSlots = /*[[${disabledSlotsJson}]]*/ null;
  var intrId = /*[[${intrUserId}]]*/ null;

  reservedSlots = reservedSlots || {};
  disabledSlots = disabledSlots || {};
</script>

<script th:inline="javascript">
  var reservedSlots = /*[[${reservedSlotsJson}]]*/ '{}';
  var disabledSlots = /*[[${disabledSlotsJson}]]*/ '{}';

  reservedSlots = JSON.parse(reservedSlots);
  disabledSlots = JSON.parse(disabledSlots);
</script>

<script>
  $(document).ready(function () {
    let selectedDate = null;
    let selectedTime = null;

    $('#btn-open-popup').on('click', function () {
      $('#reservation-box').slideDown();

      flatpickr("#calendar", {
        inline: true,
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function (_, dateStr) {
          selectedDate = dateStr;

          const label = document.getElementById('selected-date-label');
          const koreanDate = new Date(dateStr).toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'short'
          });
          label.textContent = `${koreanDate} ì‹œê°„ ì„ íƒ`;

          document.getElementById('summary-date').textContent = koreanDate;

          // Step 2 ì‹œê°„ ì„ íƒ ì˜ì—­ ë³´ì´ê¸°
          $('#step-time').show();

          // Step 3 ì˜ˆì•½ ìš”ì•½ ì˜ì—­ ìˆ¨ê¸°ê¸° (ì‹œê°„ ì„ íƒ ì „)
          $('#step-summary').hide();

          renderTimes();
        }
      });
    });

    function renderTimes() {
      console.log('renderTimes called, selectedDate:', selectedDate);
      const grid = $('#times-grid').empty();
      if (!selectedDate) return;

      const reserved = (reservedSlots && reservedSlots[selectedDate]) || [];
      console.log('reserved:', reserved);

      const disabled = (disabledSlots && disabledSlots[selectedDate]) || [];
      console.log('disabled:', disabled);

      const blocked = [...reserved, ...disabled];
      console.log('blocked:', blocked);

      for (let h = 9; h <= 18; h++) {
        const t = (h < 10 ? '0' : '') + h + ':00';
        const isDisabled = blocked.includes(t);
        console.log('time:', t, 'isDisabled:', isDisabled);

        $('<button>')
          .text(t)
          .addClass(isDisabled ? 'disabled' : '')
          .prop('disabled', isDisabled)
          .on('click', function () {
            if (isDisabled) return;

            $('.times-grid button').removeClass('selected');
            $(this).addClass('selected');
            selectedTime = t;

            document.getElementById('summary-time').textContent = t;

            // Step 3 ì˜ˆì•½ ìš”ì•½ ì˜ì—­ ë³´ì´ê¸°
            $('#step-summary').show();
          })
          .appendTo(grid);
      }
    }

    $('#btn-confirm').on('click', function () {
      if (!selectedDate || !selectedTime) {
        return alert('ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }

      const payload = {
        intrId: intrId,
        reservedDate: selectedDate,
        reservedTime: selectedTime
      };
      console.log('ì˜ˆì•½í•  intrId:', intrId);
      $.ajax({
        type: 'POST',
        url: '/reservation/save',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function (resId) {
          window.location.href = `/reservation/result?resId=${resId}`;
        },
        error: function (xhr) {
          alert('ì˜ˆì•½ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + xhr.responseText);
        }
      });
    });
  });
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
  // ë³„ì  ê¸°ëŠ¥
  const stars = document.querySelectorAll('.star-rating .star');
  const scoreInput = document.getElementById('starScore');
  let selected = parseInt(scoreInput.value) || 5;

  function updateStars(rating) {
    stars.forEach((star, idx) => {
      if (idx < rating) {
        star.classList.add('selected');
      } else {
        star.classList.remove('selected');
      }
    });
  }

  stars.forEach((star, idx) => {
    star.addEventListener('mouseenter', function() {
      updateStars(idx + 1);
      stars.forEach((s, i) => s.classList.toggle('hovered', i <= idx));
    });
    star.addEventListener('mouseleave', function() {
      updateStars(selected);
      stars.forEach(s => s.classList.remove('hovered'));
    });
    star.addEventListener('click', function() {
      selected = idx + 1;
      scoreInput.value = selected;
      updateStars(selected);
    });
  });

  updateStars(selected);

  // ê¸°ì¡´ ë¦¬ë·° ìˆ˜ì • í† ê¸€/ì·¨ì†Œ JSëŠ” ì‚­ì œë¨
});

// ë©´ì ‘ê´€ í”„ë¡œí•„ ì‚­ì œ í•¨ìˆ˜
function deleteInterviewer(intrId) {
  if (confirm('ì •ë§ë¡œ í”„ë¡œí•„ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    fetch('/interviewer/delete/' + intrId, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      if (response.ok) {
        alert('í”„ë¡œí•„ ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.href = '/interviewer'; // ë©´ì ‘ê´€ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
      } else {
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }
}
</script>
<!-- Footer -->
  <div th:replace="fragments/footer :: footerFragment"></div>
  </body>
</html>