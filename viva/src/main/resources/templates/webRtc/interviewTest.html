<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>í™”ìƒ ë©´ì ‘ SPA</title>

<style>
/* main-view, new-view, list-viewëŠ” ê°ê° ìˆ¨ê¹€ì²˜ë¦¬ */
.view {
	display: none;
}

.view.active {
	display: block;
}

body {
	font-family: 'Arial', sans-serif;
	background-color: #f2f2f2;
	padding: 20px;
}

/* ================================== */
header, footer {
	background-color: #cfd8ff;
	padding: 10px 20px;
	text-align: center;
}

header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-weight: bold;
}

.logo {
	font-size: 1.2rem;
}

.login-link {
	font-size: 0.9rem;
}

main {
	background-color: #ffffff;
	min-height: 400px;
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 40px 0;
}

.content-box {
	border: 1px solid #d0d0d0;
	border-radius: 6px;
	padding: 30px 50px;
	text-align: center;
}

.content-box h2 {
	margin-bottom: 30px;
	font-size: 1.4rem;
}

.button-group {
	display: flex;
	gap: 20px;
	justify-content: center;
}

.nav-button {
	width: 120px;
	height: 100px;
	background-color: #e0e0e0;
	border: none;
	border-radius: 6px;
	font-size: 1rem;
	font-weight: bold;
	cursor: pointer;
	transition: background-color 0.2s;
}

.nav-button:hover {
	background-color: #d6d6d6;
}

footer {
	font-weight: bold;
}

/* ================================== */
.room-list {
	display: flex;
	flex-wrap: wrap;
	gap: 20px;
}

.room-card {
	background-color: #fff;
	width: 300px;
	border-radius: 12px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	padding: 16px;
	position: relative;
}

.room-status-dot {
	width: 10px;
	height: 10px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 8px;
}

.status-waiting {
	background-color: red;
}

.status-playing {
	background-color: green;
}

.status-ended {
	background-color: gray;
}

.room-title {
	font-size: 1.1rem;
	font-weight: bold;
	margin: 8px 0;
}

.room-info {
	color: #666;
	font-size: 0.9rem;
	margin-top: 4px;
}

.room-icon {
	position: absolute;
	bottom: 16px;
	right: 16px;
	font-size: 1.2rem;
}

.room-list a {
	text-decoration: none;
	color: inherit;
}

.room-list a:hover {
	transform: translateY(-4px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/*** ë¹„ë””ì˜¤ ì˜ì—­ css ***/
/* ğŸ”· ì „ì²´ wrapper: ë¹„ë””ì˜¤ + ì±„íŒ… ìˆ˜í‰ ë°°ì¹˜ */
.video-chat-wrapper {
  display: flex;
  gap: 20px;
  height: 100%;
}

/* ğŸ”· ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ ì˜ì—­ */
.video-grid {
  flex: 3;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* ğŸ”· ì±„íŒ…ì°½ ì˜ì—­ */
.chat-panel {
  flex: 1;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #fff;
  display: flex;
  flex-direction: column;
  height: 600px; /* ì›í•˜ëŠ” ë†’ì´ ì„¤ì • */
}

/* ì±„íŒ…ì°½ ë‚´ë¶€ êµ¬ì„± */
.chat-title {
  font-weight: bold;
  padding: 10px;
  background-color: #cfd8ff;
  border-bottom: 1px solid #ccc;
  text-align: center;
}

.chat-messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 0.9rem;
}

.chat-input-area {
  display: flex;
  border-top: 1px solid #ccc;
}

.chat-input-area input {
  flex: 1;
  padding: 8px;
  border: none;
  border-right: 1px solid #ccc;
}

.chat-input-area button {
  padding: 8px 12px;
  border: none;
  background-color: #607d8b;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

.chat-input-area button:hover {
  background-color: #455a64;
}

.label {
	font-size: 14px;
	background-color: #3498db;
	color: #fff;
	padding: 2px 6px;
	border-radius: 3px;
}

.hide {
	display: none;
}

.remote-grid {
	display: grid;
	grid-template-columns: repeat(2, 1fr); /* 2ì—´ ê³ ì • */
	gap: 10px;
}

.remote-box {
	position: relative;
	border: 1px solid #ccc;
	padding: 5px;
	min-height: 150px;
}

.remote-box video {
  background-color: black;
  width: 100%;
  height: 240px; /* ë˜ëŠ” auto, fixed ë“± */
  object-fit: cover;
}

.bitrate-controls {
	margin-left: 10px;
	display: inline-block;
	position: relative;
}

.dropdown-menu {
	list-style: none;
	position: absolute;
	background: #fff;
	border: 1px solid #aaa;
	margin: 0;
	padding: 0;
	display: none;
}

.dropdown-menu li {
	padding: 5px 10px;
}

.dropdown-menu li:hover {
	background-color: #f0f0f0;
}

#bitrateset:hover+.dropdown-menu, .dropdown-menu:hover {
	display: block;
}

.remote-box video {
  width: 100%;
  max-width: 480px;       /* ğŸ‘ˆ ì›í•˜ëŠ” ë„ˆë¹„ ì œí•œ */
  height: auto;
  aspect-ratio: 4 / 3;     /* ë˜ëŠ” 16 / 9 ë“± ë¹„ìœ¨ ê³ ì • */
  object-fit: cover;       /* contain or cover */
}

/* ìƒë‹¨ ì‚¬ìš©ì ëª©ë¡ ë°” */
.top-bar {
  display: flex;
  gap: 10px;
  padding: 10px 20px;
  background-color: #1e1e1e;
  color: white;
  overflow-x: auto;
}

.participant {
  background-color: #333;
  padding: 6px 12px;
  border-radius: 4px;
  min-width: 80px;
  text-align: center;
}

.participant.current {
  border: 2px solid #4fa7ff;
}


</style>
<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js}"></script>
<script
	th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js}"></script>

<script th:src="@{https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js}"></script>
<script th:src="@{https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js}"></script>


<!-- ë‚´ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script th:src="@{/js/webRtc/janus.js}"></script>
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css}" />
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css}" />


</head>
<body>
<!-- header -->
<div th:replace="fragments/header :: header"></div>

	<!-- [2] ë°© ìƒì„± í™”ë©´ -->
	<div id="new-view" class="view">
		<h2>ë©´ì ‘ ë°© ìƒì„±</h2>
		<script>
			console.log("[[${userId}]]");
		</script>
		<form id="createRoomForm">
			<label for="intrRoomTitle">ë°© ì œëª©:</label> 
			<input type="text" id="intrRoomTitle" name="intrRoomTitle" required />
			<input type="hidden" id="host_id" name="host_id" th:value="${userId}">
			<button type="submit">ë°©ìƒì„±</button>
		</form>
		<button onclick="navigate('main')">â† ë’¤ë¡œê°€ê¸°</button>
	</div>

	<!-- [3] ë°© ëª©ë¡ í™”ë©´ -->
	<div id="list-view" class="view active">
		<h2>ë©´ì ‘ ë°© ëª©ë¡</h2>
		<input type="hidden" id="user_id" name="user_id" th:value="${userId}">
		<div id="roomList" class="room-list"></div>
		<button onclick="navigate('main')">â† ë’¤ë¡œê°€ê¸°</button>
	</div>

	<!-- [4] í†µí™”ë°© í™”ë©´ -->
	<div id="videoroom-view" class="view">
		 <!-- ğŸ”µ ìƒë‹¨ ì°¸ê°€ì ë°” -->
		<div class="top-bar">
		    <div class="participant">user</div>
		    <div class="participant current">ë‚˜</div>
		    <div class="participant">user</div>
		</div>

		<div class="video-chat-wrapper">
		    <!-- ğŸ”µ ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ -->
		    <div class="video-grid">
		    	<!-- ë‚´ í™”ë©´ í¬í•¨ -->
				<div class="remote-grid" id="remoteContainer">
					<!-- ë¹„ë””ì˜¤ ì¶œë ¥ ì˜ì—­ -->
				</div>
			</div>
			
			<!-- ğŸ”µ ì±„íŒ…ì°½ -->
		    <div class="chat-panel">
		      <div class="chat-title">ì±„íŒ…ì°½</div>
		      <div class="chat-messages" id="chatMessages"></div>
		      <div class="chat-input-area">
		        <input type="text" id="chatInput" placeholder="ë‚´ìš© ì…ë ¥" />
		        <button id="sendChatBtn">ì „ì†¡</button>
		      </div>
		  	</div>
		</div>
	    <div style="margin-top: 20px;">
	    	<button id="startCamBtn">ğŸ“· ìº  ì‹œì‘</button>
	    	<button id="exitBtn">ì¢…ë£Œ</button>
	    </div>
	</div>

<script>
//âœ… ì „ì—­ ìƒíƒœ ë³€ìˆ˜
var version = 1.2;
var server = null;
server = "https://janus.jsflux.co.kr/janus";
var janus = null;
var sfutest = null;
var mypvtid = null;
var opaqueId = "videoroom-" + Janus.randomString(12);
var selectedRoomId = null;
var displayName = null;
var feeds = [];
var isDestroying = false; 		// ì¤‘ë³µ detach ë°©ì§€ìš© í”Œë˜ê·¸
const audioContexts = {};  		// { [feedId]: { ctx, gainNode } }
var myUsername = null;
var myDataId = null;
const userId = "[[${userId}]]";
let hostId = null;
let isDataChannelReady = false;
let currentView = null;

document.addEventListener("DOMContentLoaded", () => {
	  // 'list-view'ê°€ í™œì„±í™”ëœ ê²½ìš° ìë™ìœ¼ë¡œ ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
	  const listView = document.getElementById("list-view");
	  if (listView && listView.classList.contains("active")) {
	  	loadRoomList();
	}
});

// navigate ì²˜ë¦¬ (í™”ë©´ ì „í™˜ ì‹œ ì •ë¦¬ í¬í•¨)
function navigate(view) {
	
	// 1ï¸ í˜„ì¬ ë·°ì—ì„œ ë‚˜ê°€ê¸° ì „ì— ì •ë¦¬ ì‘ì—…
	if (currentView === 'videoroom' && view !== 'videoroom') {
	    leaveRoom();  // WebSocket + Janus ì—°ê²° ì •ë¦¬
	}
	
	// 2 í™”ë©´ ì „í™˜
  	document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
  	document.getElementById(view + '-view').classList.add('active');
  
  	// ë·° ë³„ ì§„ì… ì²˜ë¦¬
  	if (view === 'list') loadRoomList();
  	
  	if (view === 'videoroom'){
		initJanus(); // ë°© ì…ì¥ ì‹œ ì´ˆê¸°í™”
  	}
  
  	currentView = view;
}

// âœ… ë°© ìƒì„±
const createForm = document.getElementById("createRoomForm");
if (createForm) {
  createForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const title = document.getElementById("intrRoomTitle").value;
	const host_id = document.getElementById("host_id").value;
	console.log("hostId : " + host_id);
    fetch("/api/meeting/roomcreate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
    	  intrRoomTitle: title,
    	  hostId: host_id
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(`ë°© ìƒì„± ì™„ë£Œ: ${data.intrRoomTitle}`);
      
      const roomId = data.intrRoomId;
      const hostId = data.hostId;

   	  // âœ… Janus ì„¸ì…˜ ì‹œì‘ â†’ ë°© ìƒì„± â†’ ì¢…ë£Œ
      createRoomsOnJanus(roomId, hostId);
      
      navigate('list');
    });
  });
}

// ë°© ìƒì„±ìš© janus ì„¸ì…˜ ìƒì„±
function createRoomsOnJanus(roomId, hostId) {
	  Janus.init({
	    debug: "all",
	    callback: function () {
	      const janus = new Janus({
	        server: server, // Janus ì„œë²„ ì£¼ì†Œ
	        success: function () {
	          // 1ï¸âƒ£ ë¹„ë””ì˜¤ë£¸ í”ŒëŸ¬ê·¸ì¸ attach
	          janus.attach({
	            plugin: "janus.plugin.videoroom",
	            success: function (videohandle) {
	              videohandle.send({
	                message: {
	                  request: "create",
	                  room: roomId,
	                  description: `Room for host ${hostId}`,
	                  publishers: 6,
	                  data: true
	                }
	              });

	              console.log("ğŸ“¹ Video room created");
	            },
	            error: function (err) {
	              console.error("Video plugin attach error", err);
	            }
	          });
	        },
	        error: function (err) {
	          console.error("Janus session error", err);
	        },
	        destroyed: function () {
	          console.log("Janus session destroyed");
	        }
	      });
	    }
	  });
}

// âœ… ë°© ëª©ë¡
function loadRoomList() {
  fetch("/api/meeting/roomlist")
    .then(res => res.json())
    .then(data => {
      const listEl = document.getElementById("roomList");
      if (!listEl) return;
      listEl.innerHTML = "";

      data.forEach(room => {
        const statusClass = room.statusCd === 'waiting' ? 'status-waiting'
                          : room.statusCd === 'in_progress' ? 'status-playing'
                          : 'status-ended';

        const div = document.createElement("div");
        div.className = "room-card";
        div.innerHTML = `
          <div>
            <span class="room-status-dot ${statusClass}"></span>
            <span>${room.intrRoomId}</span>
          </div>
          <div class="room-title">${room.intrRoomTitle}</div>
          <div class="room-info">${room.hostId}ë‹˜ì˜ ë°©</div>
          <div class="room-info">ìƒì„±: ${formatDate(room.createdDt)}</div>
          <div class="room-icon">ğŸ”’ ğŸ”“</div>
        `;
        div.addEventListener("click", () => enterRoom(room.intrRoomId, room.hostId, userId));
        listEl.appendChild(div);
      });
    });
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString("ko-KR", {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
  });
}

//ì°¸ê°€ì ëª©ë¡ì„ ë‹´ëŠ” ì „ì—­ ë°°ì—´
let participants = [];

//ì°¸ê°€ì ëª©ë¡ ì½˜ì†” ì¶œë ¥ í•¨ìˆ˜
function logParticipants() {
  console.log("ğŸ“‹ í˜„ì¬ ì°¸ê°€ì ëª©ë¡:");
  participants.forEach(p => {
    console.log(`- ID: ${p.id}, Display: ${p.display}`);
  });
}

// âœ… ì°¸ê°€ì ì¶”ê°€ í•¨ìˆ˜
function addParticipant(id, display) {
  if (!participants.find(p => p.id === id)) {
    participants.push({ id, display });
    logParticipants();
  }
}

// âœ… ì°¸ê°€ì ì œê±° í•¨ìˆ˜
function removeParticipant(id) {
  participants = participants.filter(p => p.id !== id);
  logParticipants();
}

// âœ… ë°© ì…ì¥
function enterRoom(roomId, host, name) {
  selectedRoomId = roomId;
  displayName = name;
  hostId = host;
  
  console.log("ì„ íƒëœ ë°© ë²ˆí˜¸ : " + selectedRoomId);
  console.log("ì„ íƒëœ ë°© hostId : " + hostId);
  console.log("ì…ì¥ ìœ ì € Id : " + displayName);
  
  connectChat(selectedRoomId);		// ì±„íŒ…ë°© ì—°ê²°

  
  // ğŸ”» ê¸°ì¡´ ì˜ìƒ DOM ì´ˆê¸°í™”
  $('#remoteContainer').empty();
  $('#local-box').remove();
  
  navigate('videoroom');
}

// âœ… Janus ì´ˆê¸°í™”
function initJanus() {
  if (!Janus.isWebrtcSupported()) {
    alert("WebRTCë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
    return;
  }
  
  Janus.init({
    debug: "all",
    callback: createJanusSession
  });
}

// âœ… ì„¸ì…˜ ìƒì„±
function createJanusSession() {
  
	console.log("ì„¸ì…˜ ìƒì„± : createJanusSession ì§„ì…");
	
	if (janus !== null) {
	    janus.destroy();
	    janus = null;
	  }
	  feeds = [];
	
    janus = new Janus({
    server: server,
    success: function () {
      janus.attach({
        plugin: "janus.plugin.videoroom",
        opaqueId: opaqueId,
        success: function (pluginHandle) {
          sfutest = pluginHandle;
          sfutest.send({
            message: {
              request: "join",
              room: Number(selectedRoomId),
              ptype: "publisher",
              display: displayName
            }
          });
          
          console.log("ì„¸ì…˜ ìƒì„± : ì„±ê³µ");
          
        },

     	// ICE ìƒíƒœ ë³€ê²½ ë¡œê·¸
		iceState: function(state) {
			Janus.log("ICE state changed to " + state);
		},
		
		// ë¯¸ë””ì–´ ì „ì†¡ ìƒíƒœ (audio/video) ë¡œê·¸
		mediaState: function(medium, on) {
			Janus.log("Janus " + (on ? "started" : "stopped") + " receiving our " + medium);
		},
		
		// webRTC ì—°ê²° ìƒíƒœ
		webrtcState: function(on) {
			Janus.log("Janus says our WebRTC PeerConnection is " + (on ? "up" : "down") + " now");
			// ëŒ€ì—­í­ ì¡°ì ˆ ë²„íŠ¼ì˜ì—­ í‘œì‹œ
			$('#bitrate').parent().parent().removeClass('hide').show();
			// ê° ëŒ€ì—­í­ ë©”ë‰´ í´ë¦­ ì‹œ bitrate ì„¤ì • ì²˜ë¦¬
			$('#bitrate a').click(function() {
				var id = $(this).attr("id");
				var bitrate = parseInt(id)*1000;	// kbps -> bps ë³€í™˜
				if(bitrate === 0) {
					Janus.log("Not limiting bandwidth via REMB");
				} else {
					Janus.log("Capping bandwidth to " + bitrate + " via REMB");
				}
				// ë²„íŠ¼ UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° ë©”ë‰´ ë‹«ê¸°
				$('#bitrateset').html($(this).html() + '<span class="caret"></span>').parent().removeClass('open');
				// janus ì„œë²„ì— bitrate ì„¤ì • ìš”ì²­
				sfutest.send({ message: { request: "configure", bitrate: bitrate }});
				return false;
			});
		},
        
        onmessage: function (msg, jsep) {
          
          console.log("ì°¸ê°€í•œ ë°© ë²ˆí˜¸: " + selectedRoomId);
          console.log("[DEBUG] onmessage ìˆ˜ì‹  msg:", msg);
          // ë°© ìµœì´ˆ ì°¸ê°€ì‹œ
          if (msg.videoroom === "joined") {
        	mypvtid = msg.private_id;
//              publishOwnFeed();
				publishOwnDummyFeed()
            if (msg.publishers) {
              msg.publishers.forEach(pub => {
                if (!feeds.find(f => f.rfid === pub.id)) {
                  newRemoteFeed(pub.id, pub.display);
                }
              });
            }
          }
          
          // ìƒˆë¡œìš´ ìœ ì €ê°€ ì…ì¥í•œ ê²½ìš°
          if (msg.videoroom === "event" && msg.publishers) {
        	  msg.publishers.forEach(pub => {
        	    if (!feeds.find(f => f.rfid === pub.id)) {
        	      newRemoteFeed(pub.id, pub.display);
        	    }
        	 });
          }

          // ë‹¤ë¥¸ ìœ ì €ê°€ í‡´ì¥í•œ ê²½ìš°
          if (msg.videoroom === "event" && msg.unpublished) {
            const unpublished = msg.unpublished;
            if (unpublished === 'ok') {
              // ë³¸ì¸ í‡´ì¥
              console.log("í˜„ì¬ feeds ëª©ë¡:", feeds.map(f => f.rfid));
              cleanupAllFeeds();
            } else {
              console.log("í˜„ì¬ feeds ëª©ë¡:", feeds.map(f => f.rfid));
              console.log("í‡´ì¥ ëŒ€ìƒ ID:", msg.leaving || msg.unpublished);
              console.log(`ğŸ§¹ publisher ${unpublished} í‡´ì¥`);
              
              removeParticipant(unpublished);                   // ğŸ‘ˆ ì°¸ê°€ì ì œê±°
              removeRemoteFeed(unpublished);
              
            }
          }

          if (msg.videoroom === "event" && msg.leaving) {
            console.log(`ğŸšª publisher ${msg.leaving} ë‚˜ê°`);
            removeParticipant(msg.leaving);                // ğŸ‘ˆ ì°¸ê°€ì ì œê±°
            removeRemoteFeed(msg.leaving);
          }

          if (jsep) sfutest.handleRemoteJsep({ jsep });
        },

        onlocalstream: function (stream) {		// ë‚´ ì¶œë ¥í™”ë©´
        	
        	console.log("onlocalstream ì§„ì…");
        	
        	const remoteId = 'local'; // ê³ ì • ID
        	const videoElId = `remotevideo-${remoteId}`;
        	const boxElId = `remote-box-${remoteId}`;
        	const muteBtnId = `mute-btn-${remoteId}`;
        	const volumeSliderId = `volume-slider-${remoteId}`;
        	
        	// ë‚´ í™”ë©´ ì˜ì—­
        	if (!document.getElementById(boxElId)) {
        	    const localBox = `
        	      <div class="remote-box" id="${boxElId}">
        	        <span>ë‚´ í™”ë©´</span>
        	        <video id="${videoElId}" autoplay muted playsinline></video>
        	        <div style="margin-top: 4px;">
        	          <button id="${muteBtnId}" style="cursor: pointer;">ğŸ”Š</button>
        	          <input type="range" min="0" max="2" step="0.01" value="1"
        	            class="volume-slider" data-id="${remoteId}" id="${volumeSliderId}"
        	            style="width: 80%; margin-top: 4px;" />
        	        </div>

        	        <!-- ğŸ”» Bandwidth ì„¤ì • (optional) -->
        	        <div class="bitrate-controls">
        	          <button id="bitrateset">Bandwidth â–¼</button>
        	          <ul id="bitrate" class="dropdown-menu">
        	            <li><a href="#" id="0">No limit</a></li>
        	            <li><a href="#" id="128">128kbps</a></li>
        	            <li><a href="#" id="256">256kbps</a></li>
        	            <li><a href="#" id="512">512kbps</a></li>
        	            <li><a href="#" id="1024">1mbps</a></li>
        	            <li><a href="#" id="1500">1.5mbps</a></li>
        	            <li><a href="#" id="2000">2mbps</a></li>
        	          </ul>
        	        </div>
        	      </div>`;
        	    $('#remoteContainer').append(localBox);
        	  }
          
        	const videoElement = document.getElementById(videoElId);
        	Janus.attachMediaStream(videoElement, stream);

        	// ìŒí–¥ ì¡°ì ˆ
        	  try {
        	    const audioCtx = new AudioContext();
        	    const source = audioCtx.createMediaStreamSource(stream);
        	    const gainNode = audioCtx.createGain();
        	    source.connect(gainNode).connect(audioCtx.destination);

        	    audioContexts[remoteId] = {
        	      ctx: audioCtx,
        	      gainNode: gainNode,
        	      muted: false
        	    };

        	    const slider = document.getElementById(volumeSliderId);
        	    const muteBtn = document.getElementById(muteBtnId);

        	    slider.addEventListener('input', e => {
        	      const value = parseFloat(e.target.value);
        	      const state = audioContexts[remoteId];
        	      if (!state) return;

        	      state.gainNode.gain.value = value;
        	      if (value === 0) {
        	        state.muted = true;
        	        muteBtn.textContent = 'ğŸ”‡';
        	      } else {
        	        state.muted = false;
        	        muteBtn.textContent = 'ğŸ”Š';
        	      }
        	    });

        	    muteBtn.addEventListener('click', () => {
        	      const state = audioContexts[remoteId];
        	      if (!state) return;

        	      const slider = document.getElementById(volumeSliderId);
        	      if (state.muted) {
        	        // ìŒì†Œê±° í•´ì œ
        	        const restoreVolume = parseFloat(slider.value) || 1.0;
        	        state.gainNode.gain.value = restoreVolume;
        	        muteBtn.textContent = 'ğŸ”Š';
        	      } else {
        	        // ìŒì†Œê±°
        	        state.gainNode.gain.value = 0.0;
        	        muteBtn.textContent = 'ğŸ”‡';
        	      }
        	      state.muted = !state.muted;
        	    });
        	  } catch (err) {
        	    console.warn("âš ï¸ local stream audio ì œì–´ ì‹¤íŒ¨", err);
        	  }
        	
          // streamì´ ë¹„ì–´ìˆëŠ” ê²½ìš°ì—ë„ attachMediaStream ì²˜ë¦¬ (ê²€ì€ í™”ë©´ í‘œì‹œ)
          Janus.attachMediaStream(document.getElementById('localvideo'), stream);
        },

        oncleanup: cleanupAllFeeds,
        ondetached: cleanupAllFeeds,
        error: function (err) {
          console.error("Janus ì˜¤ë¥˜", err);
        }
      });	// end videoroom í”ŒëŸ¬ê·¸ì¸
    },

    destroyed: cleanupAllFeeds
  });
}

// âœ… ë‚´ ì˜ìƒ publish
function publishOwnFeed() {
  console.log("publishOwnFeed ì •ìƒ í˜¸ì¶œ");
  sfutest.createOffer({
    media: { 
      audioRecv: false, videoRecv: false, 
      audioSend: true, videoSend: true
    },
    success: function (jsep) {
      sfutest.send({
        message: { request: "configure", audio: true, video: true },
        jsep
      });
      console.log("publishOwnFeed ì„±ê³µ");
    },
    error: async function (error) {
      console.warn("ğŸ“› ë‚´ stream publish ì‹¤íŒ¨", error.message);

      try {
        // âš ï¸ ìº /ë§ˆì´í¬ ì—†ìŒ â†’ dummyStream ì‚¬ìš©
        const dummyStream = getSilentDummyStream();

        // âš ï¸ local-boxëŠ” onlocalstreamì—ì„œë§Œ ìƒì„± â†’ ì—¬ê¸°ì„  ë¹„ë””ì˜¤ ì—°ê²°ë§Œ
        const videoElem = document.getElementById('localvideo');
        if (videoElem) {
          videoElem.srcObject = dummyStream;
        } else {
          console.warn("âš ï¸ localvideo elementê°€ ì—†ìŒ. onlocalstreamì—ì„œ ì²˜ë¦¬ í•„ìš”");
        }

        // Janusì— dummy stream attach í›„ publish
        sfutest.createOffer({
          stream: dummyStream,
          media: {
            audioRecv: false,
            videoRecv: false,
            audioSend: true,
            videoSend: true
          },
          success: function (jsep) {
            sfutest.send({
              message: { request: "configure", audio: true, video: true },
              jsep
            });
          },
          error: function (err) {
            console.error("ğŸ“› dummyStream publish ì‹¤íŒ¨", err);
          }
        });

      } catch (e) {
        console.error("âŒ dummyStream êµ¬ì„± ì‹¤íŒ¨", e);   
      }
    }
  });
}

// ì…ì¥ì‹œ ë”ë¯¸ ìŠ¤íŠ¸ë¦¼ publish
function publishOwnDummyFeed() {
	  const dummyStream = getSilentDummyStream();

	  sfutest.createOffer({
	    stream: dummyStream,
	    media: {
	      audioRecv: false,
	      videoRecv: false,
	      audioSend: true,
	      videoSend: true
	    },
	    success: function (jsep) {
	      sfutest.send({
	        message: { request: "configure", audio: true, video: true },
	        jsep
	      });
	    },
	    error: function (err) {
	      console.error("ğŸ“› dummyStream publish ì‹¤íŒ¨", err);
	    }
	  });
	}

// ìº ì—†ëŠ” ê²½ìš° ë”ë¯¸ ë°ì´í„°
function getSilentDummyStream() {
	  const stream = new MediaStream();

	  // ğŸ”‡ dummy audio track
	  const audioCtx = new AudioContext();
	  const oscillator = audioCtx.createOscillator();
	  const dst = oscillator.connect(audioCtx.createMediaStreamDestination());
	  oscillator.start();
	  const audioTrack = dst.stream.getAudioTracks()[0];
	  stream.addTrack(audioTrack);

	  // ğŸ“· dummy video track (ê²€ì • í™”ë©´)
	  const canvas = Object.assign(document.createElement("canvas"), { width: 320, height: 240 });
	  const ctx = canvas.getContext("2d");
	  ctx.fillStyle = "black";
	  ctx.fillRect(0, 0, canvas.width, canvas.height);
	  const videoTrack = canvas.captureStream().getVideoTracks()[0];
	  stream.addTrack(videoTrack);

	  return stream;
	}

// âœ… remote feed ì¶”ê°€
function newRemoteFeed(id, display) {

  //ì´ë¯¸ ë“±ë¡ëœ feedì¸ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
  if (feeds.find(f => f.rfid === id)) {
    console.warn(`âš ï¸ Feed ${id} already exists, skipping newRemoteFeed`);
    return;
  }
  
  //ì´ë¯¸ DOMì— í•´ë‹¹ IDì˜ video ë°•ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°
  if (document.getElementById(`remote-box-${id}`)) {
    console.warn(`âš ï¸ remote-box-${id} already exists in DOM, skipping`);
    return;
  }
  
  janus.attach({
    plugin: "janus.plugin.videoroom",
    opaqueId,

    success: function (pluginHandle) {
      const remoteFeed = pluginHandle;
      remoteFeed.rfid = id;
      remoteFeed.rfdisplay = display;

      feeds.push(remoteFeed);

      remoteFeed.send({
        message: {
          request: "join",
          room: Number(selectedRoomId),
          ptype: "subscriber",
          feed: id,
          private_id: mypvtid
        }
      });
    },

    onmessage: function (msg, jsep) {
      if (jsep) {
        feeds.find(f => f.rfid === id)?.createAnswer({
          jsep,
          media: { audioSend: false, videoSend: false },
          success: function (jsep) {
            feeds.find(f => f.rfid === id)?.send({ message: { request: "start", room: Number(selectedRoomId) }, jsep });
          },
          error: function (err) {
            console.error("remote SDP ì˜¤ë¥˜", err);
          }
        });
      }
    },

    onremotestream: function (stream) {
    	
    	const remoteId = id;
    	const videoElId = `remotevideo-${remoteId}`;
    	const boxElId = `remote-box-${remoteId}`;
    	const muteBtnId = `mute-btn-${remoteId}`;
    	const volumeSliderId = `volume-slider-${remoteId}`;
    	
    	if (document.getElementById(boxElId)) return;
      
    	// remote-box HTML ìƒì„± ë° ì‚½ì…
      	const html = `
        	<div class="remote-box" id="${boxElId}">
	          	<span>${display}</span>
	          	<video id="${videoElId}" autoplay playsinline></video>
	          	<div style="margin-top: 4px;">
	            	<button id="${muteBtnId}" style="cursor: pointer;">ğŸ”Š</button>
	          		<input type="range" min="0" max="2" step="0.01" value="1" 
	                	class="volume-slider" data-id="${remoteId}" style="width: 80%; margin-top: 4px;" />
	            </div>
        	</div>`;
      	$('#remoteContainer').append(html);
      	
      	// ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
        const videoElement = document.getElementById(videoElId);
        Janus.attachMediaStream(videoElement, stream);

        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
        const audioCtx = new AudioContext();
        const source = audioCtx.createMediaStreamSource(stream);
        const gainNode = audioCtx.createGain();

        // ì˜¤ë””ì˜¤ íë¦„: source -> gainNode -> ì¶œë ¥
        source.connect(gainNode).connect(audioCtx.destination);

        // ì „ì—­ ì €ì¥ì†Œì— ë“±ë¡
        audioContexts[remoteId] = {
          ctx: audioCtx,
          gainNode: gainNode,
          muted: false  // ì´ˆê¸° ìƒíƒœ: ìŒì†Œê±° ì•„ë‹˜
        };

     	// ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ì œì–´
        const slider = document.getElementById(volumeSliderId);
        slider.addEventListener('input', e => {
          const value = parseFloat(e.target.value);
          
          state.gainNode.gain.value = value;
          if (value === 0) {
            state.muted = true;
            muteBtn.textContent = 'ğŸ”‡';
          } else {
            state.muted = false;
            muteBtn.textContent = 'ğŸ”Š';
          }
        });
        
     	// ìŒì†Œê±° ë²„íŠ¼ ì œì–´
        const muteBtn = document.getElementById(muteBtnId);
        muteBtn.addEventListener('click', () => {
          const state = audioContexts[remoteId];
          const slider = document.getElementById(volumeSliderId);
          if (!state || !slider) return;
          
          if (state.muted) {
        	// ìŒì†Œê±° í•´ì œ
        	const restoreVolume = parseFloat(slider.value) || 1.0;
            state.gainNode.gain.value = restoreVolume;
            muteBtn.textContent = 'ğŸ”Š';
          } else {
        	// ìŒì†Œê±°
            state.gainNode.gain.value = 0.0;
            muteBtn.textContent = 'ğŸ”‡';
          }
          state.muted = !state.muted;
        });
      	
    },

    oncleanup: function () {
      removeRemoteFeed(id);
    },

    ondetached: function () {
      removeRemoteFeed(id);
    }
  });
}

// âœ… remote feed ì œê±°
function removeRemoteFeed(id) {
  console.log(`ğŸ§¹ remote feed ì œê±°: ${id}`);
  $(`#remote-box-${id}`).remove();
  if (audioContexts[id]) {
	audioContexts[id].ctx.close();
	delete audioContexts[id];
  }
  feeds = feeds.filter(f => f.rfid !== id);
}

// âœ… ì „ì²´ ì •ë¦¬
function cleanupAllFeeds() {

	 if (isDestroying) return;
	  isDestroying = true; // ğŸ” ì§„ì… í”Œë˜ê·¸ ì„¤ì •

	  console.log("ğŸ§¹ cleanupAllFeeds() ì‹¤í–‰");
	
  // remote feed detach + ë°°ì—´ ì´ˆê¸°í™”
   feeds.forEach((f, i) => {
    if (f) {
      try { f.detach(); } catch (e) {}
      feeds[i] = null;
    }
  });
  feeds = [];
  
  // ì˜ìƒ DOM ì œê±°
  $('#remoteContainer').empty();
  $('#local-box').remove();
  
  // Audio context ì •ë¦¬
  Object.values(audioContexts).forEach(state => state.ctx.close());
  Object.keys(audioContexts).forEach(k => delete audioContexts[k]);
  
  // í•¸ë“¤ ë° ì„¸ì…˜ ì´ˆê¸°í™”
  if (sfutest) sfutest.detach();
  sfutest = null;
  myid = null;
  mypvtid = null;
  myUsername = null;
  myDataId = null;
  selectedRoomId = null;
  displayName = null;
  
  // janus ì„¸ì…˜ ì œê±°
  if (janus) {
    janus.destroy();
    janus = null;
  }
  
}

// ì¢…ë£Œë²„íŠ¼ í´ë¦­ì‹œ
document.getElementById("exitBtn").addEventListener("click", function () {
	navigate('main'); // navigateëŠ” ì„¸ì…˜ì •ë¦¬ ì—†ì´ í™”ë©´ ì „í™˜ë§Œ
});

// ìº  ì‹œì‘ ë²„íŠ¼ í´ë¦­
document.getElementById("startCamBtn").addEventListener("click", function () {
	  publishOwnFeed();
});

// ë‚´ ìº  ìŒì†Œê±°
function toggleMute() {
	const muted = sfutest.isAudioMuted();
	if (muted) {
	    sfutest.unmuteAudio();
	    $('#mute').html("Mute");
	} else {
	    sfutest.muteAudio();
	    $('#mute').html("Unmute");
	}
}

// websocket ì—°ê²° ë° êµ¬ë…
let stompClient = null;
let chatSubscription = null;		// êµ¬ë… ê°ì²´ ì €ì¥ìš© (ë‚˜ì¤‘ì— unsubscribe ê°€ëŠ¥)

function connectChat(roomId) {
  if (stompClient && stompClient.connected) {
	  stompClient.disconnect(() => {
	    console.log("ğŸ”Œ ê¸°ì¡´ WebSocket ì—°ê²° í•´ì œ ì™„ë£Œ");
	  });
  }
	
  const socket = new SockJS("http://52.78.112.81:8080/ws-chat");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, function () {
    console.log("âœ… ì±„íŒ… ì—°ê²° ì„±ê³µ");
    
    // êµ¬ë…
    stompClient.subscribe(`/topic/chat/${roomId}`, function (messageOutput) {
      const msg = JSON.parse(messageOutput.body);
      appendChatMessage(msg.sender, msg.message);
    });
	sendMessage(displayName + "ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
  });
  
}

// websocket ì—°ê²° ì¢…ë£Œ
function disconnectChat() {
	if (stompClient && stompClient.connected) {
	  stompClient.disconnect(() => {
	    console.log("ğŸ›‘ WebSocket ì—°ê²° ì¢…ë£Œë¨");
	  });
	}
}

function leaveRoom() {
	// 1. ì±„íŒ… í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡
	if (stompClient && stompClient.connected) {
    	sendMessage(displayName + "ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
  	}
	
	// 2. WebSocket ì—°ê²° í•´ì œ
	if (stompClient) {
		disconnectChat();
		stompClient = null;
	
		// ì±„íŒ…ì°½ ì´ˆê¸°í™”
		const chatBox = document.getElementById("chatMessages");
		if (chatBox) chatBox.innerHTML = "";
		
	}

	// 3. Janus ì—°ê²° í•´ì œ
	if (janus && !isDestroying) {
	    isDestroying = true;
	    janus.destroy({
	      	success: () => {
	        	console.log("ğŸ§¹ Janus ì„¸ì…˜ ì¢…ë£Œ ì™„ë£Œ");
	        	cleanupAllFeeds();
		        janus = null;
		        isDestroying = false;
	    	}
	  	});
	}
	
	// 4. ì „ì—­ ìƒíƒœ ì´ˆê¸°í™”
	selectedRoomId = null;
	displayName = null;
}

// ë©”ì„¸ì§€ ì „ì†¡
function sendMessage(message) {
	const content = message;

	stompClient.send("/app/chat.send", {}, JSON.stringify({
		roomId: selectedRoomId,
		sender: displayName,
	    message: content
	}));

}

// ì±„íŒ… ë©”ì„¸ì§€ DOM ì¶”ê°€
function appendChatMessage(sender, msg) {
  const chatBox = document.getElementById("chatMessages");
  const p = document.createElement("p");
  
  const safeSender = escapeHtml(sender);
  const safeMsg = escapeHtml(msg);
  
  p.textContent = `[${sender}] ${msg}`;
  chatBox.appendChild(p);
  chatBox.scrollTop = chatBox.scrollHeight;
}

//HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ í•¨ìˆ˜ (XSS ë°©ì§€ìš©)
function escapeHtml(str) {
  return str.replace(/[&<>"']/g, function (match) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[match];
  });
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”©
const input = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendChatBtn");

document.getElementById("sendChatBtn").addEventListener("click", () => {
  const message = input.value.trim();
  if (message !== "") {
    sendMessage(message);
    input.value = "";
  }
});

//Enter í‚¤ ì…ë ¥ ì´ë²¤íŠ¸
input.addEventListener("keypress", function (e) {
  if (e.key === "Enter" && !e.shiftKey) {		// ì—”í„°í‚¤ ê°ì§€ && Shift+Enter ì¤„ë°”ê¿ˆ í—ˆìš©
    e.preventDefault(); // ì¤„ë°”ê¿ˆ ë°©ì§€
    sendBtn.click();    // ì „ì†¡ ë²„íŠ¼ í´ë¦­ê³¼ ë™ì¼í•œ íš¨ê³¼
  }
});

</script>


</body>
</html>