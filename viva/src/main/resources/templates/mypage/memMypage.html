<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<script src="https://code.jquery.com/jquery-latest.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<meta charset="UTF-8">
<title>ë©´ì ‘ê´€ ë§ˆì´í˜ì´ì§€</title>
<link rel="stylesheet" th:href="@{/css/main.css}">
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" th:href="@{/css/reservation.css}" />

<style>
body {
	background: #f7f9fc;
	font-family: 'Segoe UI', 'ë§‘ì€ ê³ ë”•', sans-serif;
	margin: 0;
	padding: 0;
}

.mypage-layout {
	display: flex;
	max-width: 1100px;
	margin: 50px auto 0 auto;
	min-height: 550px;
	background: #fff;
	border-radius: 14px;
	box-shadow: 0 2px 14px rgba(70, 110, 180, 0.08);
	overflow: hidden;
}
/* ì‚¬ì´ë“œë°” */
.sidebar {
	width: 230px;
	background: #eaf1fb;
	padding: 36px 0 0 0;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.sidebar-menu {
	display: flex;
	flex-direction: column;
	gap: 5px;
	padding-left: 24px;
}

.sidebar-menu a {
	font-size: 17px;
	color: #314266;
	text-decoration: none;
	padding: 10px 0 10px 12px;
	border-radius: 5px 0 0 5px;
	transition: background 0.18s;
	font-weight: 500;
	letter-spacing: -0.2px;
}

.sidebar-menu a.active, .sidebar-menu a:hover {
	background: #c3d3ee;
	color: #2951a3;
	font-weight: bold;
}

.sidebar-bottom {
	padding-left: 24px;
	padding-bottom: 38px;
}

.sidebar-bottom a {
	color: #d34040;
	font-weight: bold;
	text-decoration: none;
	font-size: 15px;
	transition: color 0.2s;
}

.sidebar-bottom a:hover {
	color: #b80000;
	text-decoration: underline;
}
/* ë©”ì¸ì»¨í…ì¸  */
.main-content {
	flex: 1;
	padding: 46px 44px;
	background: #f7f9fc;
	min-width: 0;
}

.info-cards {
	display: flex;
	gap: 36px;
}

.member-info {
	background: #fff;
	border-radius: 9px;
	box-shadow: 0 2px 8px rgba(135, 160, 180, 0.07);
	padding: 32px 38px 30px 38px;
	min-width: 320px;
	flex: 1;
	margin-bottom: 24px;
}

.member-info h2 {
	margin-top: 0;
	font-size: 21px;
	color: #314266;
	margin-bottom: 16px;
}

.member-info-list {
	font-size: 16px;
	line-height: 2.1;
	color: #222;
}

.stat-info {
	background: #eaf1fb;
	border-radius: 9px;
	box-shadow: 0 2px 8px rgba(70, 110, 180, 0.06);
	padding: 32px 40px;
	min-width: 220px;
	display: flex;
	flex-direction: column;
	justify-content: center;
	margin-bottom: 24px;
}

.stat-info h2 {
	margin-top: 0;
	font-size: 20px;
	color: #2951a3;
	margin-bottom: 18px;
}

.stat-info .point-value {
	font-size: 25px;
	color: #314266;
	font-weight: bold;
	margin-bottom: 8px;
}

@media ( max-width : 900px) {
	.mypage-layout {
		flex-direction: column;
	}
	.sidebar {
		width: 100%;
		flex-direction: row;
		padding: 0;
	}
	.main-content {
		padding: 24px 10px;
	}
	.info-cards {
		flex-direction: column;
		gap: 14px;
	}
}
</style>
<script th:inline="javascript">
  /*<![CDATA[*/
  var reservedSlots = /*[[${reservedSlotsJson}]]*/ {};
  console.log("ğŸ“¦ reservedSlots í™•ì¸:", reservedSlots);
  /*]]>*/
</script>
</head>
<body>
	<div th:replace="fragments/header :: header"></div>


	<div class="mypage-layout">
		<!-- ì‚¬ì´ë“œë°” -->
		<nav class="sidebar">
			<div>
				<div class="sidebar-menu">
					<a href="#" class="active">ë‚´ ì •ë³´</a> 
					<a th:href="@{/memberEdit}">ë‚´ì •ë³´ ìˆ˜ì •</a> 
					<a href="#">ë‚´ í›„ê¸° ê´€ë¦¬</a> 
					<a th:href="@{/reservation/mylist}"id="loadReservations">ì¼ì • ê´€ë¦¬</a> 
					<a th:href="@{/mypage/jaso/list}">ìì†Œì„œê´€ë¦¬</a> 
					<a href="#">AI ëŒ€í™” ë‚´ì—­</a>
					<a href="#" id="loadPaymentList">ê²°ì œ ë‚´ì—­</a> <!-- ê²°ì œë‚´ì—­ íƒ­ ë˜ëŠ” ë²„íŠ¼ -->
					<a th:href="@{/jobsite}">ì·¨ì—…ì‚¬ì´íŠ¸</a>
				</div>
			</div>
			<div class="sidebar-bottom">
				<!-- í˜ì´ì§€ ì´ë™ ì—†ì´ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œë§Œ ë™ì‘ -->
				<a href="#" id="withdrawBtn"
					style="color: #d34040; text-decoration: underline;">íšŒì› íƒˆí‡´</a>
			</div>
		</nav>

		<!-- ë©”ì¸ ì»¨í…ì¸  -->
		<section class="main-content">
			<div class="info-cards">
				<!-- íšŒì› ì •ë³´ -->
				<div class="member-info">
					<h2>íšŒì› ì •ë³´</h2>
					<div class="member-info-list">
						<div>
							<strong>ì•„ì´ë””:</strong> <span th:text="${users.userId}">intr1</span>
						</div>
						<div>
							<strong>ì´ë¦„:</strong> <span th:text="${users.userName}">í™ë©´ì ‘</span>
						</div>
						<div>
							<strong>í•¸ë“œí°ë²ˆí˜¸:</strong> <span th:text="${users.userNum}">010-0000-0000</span>
						</div>
						<div>
							<strong>ì´ë©”ì¼:</strong> <span th:text="${users.userEmail}">intr@naver.com</span>
						</div>
						<div>
							<strong>ì£¼ì†Œ:</strong> <span
								th:text="${users.userAdd + ' ' + users.userAddDetail}">ì£¼ì†Œ+ìƒì„¸ì£¼ì†Œ</span>
						</div>
						<div>
							<strong>ê°€ì…ì¼:</strong> <span th:text="${users.createdDt}">2025-06-27</span>
						</div>
					</div>
				</div>

				<!-- í¬ì¸íŠ¸ë§Œ í‘œì‹œí•˜ëŠ” í™œë™í†µê³„ -->
				<div class="stat-info">
					<h2>ë‚˜ì˜ í¬ì¸íŠ¸</h2>
					<div class="point-value" th:text="${point + 'P'}">
						<!--  <div th:text="${point + 'P'}"></div> -->
					</div>
				</div>

				<!-- 'ë‚´ ì˜ˆì•½ ã…Œâ‚©ëª©ë¡'-->
				<div id="schedule">
					<div id="reservationContainer"></div>
				</div>

				<!-- ê²°ì œë‚´ì—­ í‘œì‹œ ì˜ì—­ -->
				<div id="paymentListContainer" style="display:none;"></div>
		</section>
	</div>

	<!-- íƒˆí‡´ íŒì—… Modal (ì²˜ìŒì—ëŠ” display:none; ìˆ¨ê²¨ë‘ ) -->
	<div id="withdrawModal"
		style="display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.25); z-index: 9999;">
		<div
			style="background: #fff; width: 350px; margin: 120px auto; padding: 32px 24px 16px 24px; border-radius: 10px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.16); position: relative;">
			<h2 style="margin-bottom: 18px;">ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
			<form id="withdrawForm">
				<!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
				<div style="margin-bottom: 10px;">
					<label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><br> <input type="password"
						name="currentPass" style="width: 100%;" required />
				</div>
				<div style="margin-bottom: 18px;">
					<label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><br> <input type="password"
						name="confirmPass" style="width: 100%;" required />
				</div>
				<!-- ë²„íŠ¼ ì˜ì—­ -->
				<div style="display: flex; justify-content: space-between;">
					<button type="submit"
						style="background: #d34040; color: #fff; border: none; padding: 7px 20px; border-radius: 5px;">í™•ì¸</button>
					<button type="button" id="cancelWithdraw"
						style="background: #ccc; color: #222; border: none; padding: 7px 20px; border-radius: 5px;">ì·¨ì†Œ</button>
				</div>
			</form>
		</div>
	</div>

	<!-- íšŒì›ì •ë³´ ìˆ˜ì • í›„ ë©”ì„¸ì§€ -->
	<script th:if="${editSuccess != null}" th:inline="javascript">
	 alert('[[${editSuccess}]]');
</script>


	<script>
$(function(){
  // 1. "íšŒì› íƒˆí‡´" ë§í¬ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°
  $("#withdrawBtn").on("click", function(e){
    e.preventDefault(); // ë§í¬ ê¸°ë³¸ë™ì‘ ë§‰ê¸°(ìƒˆë¡œê³ ì¹¨X)
    $("#withdrawModal").show();
  });

  // 2. ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—… ë‹«ê¸°
  $("#cancelWithdraw").on("click", function(){
    $("#withdrawModal").hide();
    $("#withdrawForm")[0].reset(); // ì…ë ¥ê°’ ì´ˆê¸°í™”
  });

  // 3. í¼ ì œì¶œ(í™•ì¸) ì‹œ AJAXë¡œ íƒˆí‡´ ìš”ì²­
  $("#withdrawForm").on("submit", function(e){
    e.preventDefault();

    // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    var currentPass = $("input[name='currentPass']").val();
    var confirmPass = $("input[name='confirmPass']").val();

    // 1ì°¨ ì²´í¬: ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
    if(currentPass !== confirmPass){
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    // AJAXë¡œ ì„œë²„ì— íƒˆí‡´ ìš”ì²­
    $.ajax({
      type: "POST",
      url: "/member/withdraw", // ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤í•‘ì— ë§ì¶°ì„œ
      data: { currentPass: currentPass },
      success: function(result){
        if(result === "success"){
          alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          window.location.href = "/main"; // íƒˆí‡´ í›„ ì´ë™í•  í˜ì´ì§€
        }else if(result === "fail"){
          alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");
        }else{
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      },
      error: function(){
        alert("ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });
});
</script>
	<!-- ì¼ì •ê´€ë¦¬ -->
	<script>
  // ì¼ì •ê´€ë¦¬ íƒ­ í´ë¦­ ì‹œ ì˜ˆì•½ ëª©ë¡ fragment ë¡œë”©
  $(function(){
    $('#loadReservations').on('click', function(e){
      e.preventDefault();

      // 1) íƒ­ active í† ê¸€
      $('.sidebar-menu a').removeClass('active');
      $(this).addClass('active');

      // 2) ì¹´ë“œ ìš”ì†Œë§Œ ìˆ¨ê¸°ê¸°
      $('.member-info, .stat-info').hide();

      // 3) AJAX ë¡œë“œ
      $('#reservationContainer').load('/reservation/mylist', function(resp, status, xhr){
        if (status !== 'success') {
          alert('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + xhr.statusText);
          return;
        }

        // 4) reservedSlotsJson ì¶”ì¶œ
        const $jsonScript = $('#reservationContainer').find('#reservedSlotsJson');
        if ($jsonScript.length) {
          try {
            window.reservedSlots = JSON.parse($jsonScript.text());
            console.log("âœ… reservedSlots loaded:", window.reservedSlots);
          } catch (e) {
            console.error("âŒ reservedSlots íŒŒì‹± ì‹¤íŒ¨:", e);
            window.reservedSlots = {};
          }
        } else {
          console.warn("âš ï¸ reservedSlotsJson íƒœê·¸ ì—†ìŒ");
          window.reservedSlots = {};
        }

        // 5) ìŠ¤ì¼€ì¤„ëŸ¬ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        if (typeof window.initReservationSchedule === 'function') {
          window.initReservationSchedule();
        } else {
          console.warn("âš ï¸ initReservationSchedule í•¨ìˆ˜ê°€ ì—†ìŒ");
        }
      });
    });

    // âœ… í˜ì´ì§€ ë¡œë“œì‹œ ?tab=schedule ì´ë©´ ìë™ í´ë¦­
    const params = new URLSearchParams(window.location.search);
    if (params.get("tab") === "schedule") {
      $('#loadReservations').click();
    }
  });
</script>

	<!-- ì˜ˆì•½ë³€ê²½ -->
	<script>
// ğŸ’¡ ìŠ¤ì¼€ì¤„ëŸ¬ ì´ˆê¸°í™” í•¨ìˆ˜
window.initReservationSchedule = function() {
  $(document).on('click', '.action-link.change', function(e){
    e.preventDefault();

    const $tr = $(this).closest('tr');
    const resId = $tr.find('td:eq(0)').text().trim();
    const intrName = $tr.find('td:eq(1)').text().trim();
    const datePart = $tr.find('td:eq(2)').text().split(' ')[0];

    $('#infoResId').text(resId);
    $('#infoIntrName').text(intrName);

    flatpickr("#calendarPicker", {
      inline: true,
      dateFormat: "Y-m-d",
      defaultDate: datePart,
      onChange: function(_, dateStr){
        window.disableTimeButtons(dateStr);  // âœ… ë¹„í™œì„±í™” í˜¸ì¶œ
      }
    });

    window.disableTimeButtons(datePart); // âœ… ì´ˆê¸° ë‚ ì§œë„ ë¹„í™œì„±í™” ì²´í¬
    $('#schedulerPanel').slideDown();
  });

  // ì‹œê°„ ë²„íŠ¼ ì„ íƒ
  $(document).on('click', '.time-buttons button', function(){
    if ($(this).hasClass('disabled')) return;
    $('.time-buttons button').removeClass('active');
    $(this).addClass('active');
  });

  // ì €ì¥ ë²„íŠ¼
  $(document).on('click', '#saveChange', function(){
    const resId = $('#infoResId').text();
    const newDate = $('#calendarPicker').val();
    const newTime = $('.time-buttons button.active').data('time');

    if (!newDate || !newTime) {
      alert("ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    $.post('/reservation/reschedule', { resId, newDate, newTime })
      .done(() => {
        alert('ì˜ˆì•½ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        $('#reservationContainer').load('/reservation/mylist');
      })
      .fail(xhr => {
        alert('ë³€ê²½ ì‹¤íŒ¨: ' + xhr.responseText);
      });
  });

  // ì·¨ì†Œ ë²„íŠ¼
  $(document).on('click', '#cancelChange', function(){
    $('#schedulerPanel').slideUp();
  });
};

// ğŸ’¡ ì˜ˆì•½ëœ ì‹œê°„ ë¹„í™œì„±í™” í•¨ìˆ˜
window.disableTimeButtons = function(dateStr){
  const taken = (window.reservedSlots && window.reservedSlots[dateStr]) ? window.reservedSlots[dateStr] : [];

  $('.time-buttons button').each(function(){
    const $btn = $(this);
    const time = $btn.data('time');

    if (taken.includes(time)) {
      $btn.prop('disabled', true).addClass('disabled');
    } else {
      $btn.prop('disabled', false).removeClass('disabled');
    }
  });
};
</script>



	<!-- í™˜ë¶ˆ -->
	<script>
$(document).on('click', '.action-link.cancel', function(e){
	  e.preventDefault();
	  const resId = $(this).data('res-id');
	  console.log("ğŸ§¾ ì·¨ì†Œí•  ì˜ˆì•½ resId:", resId);  

	  if (!resId) {
	    alert("ì˜ˆì•½ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
	    return;
	  }

	  if (!confirm("ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

	  $.get('/reservation/cancel?resId=' + resId)
	    .done(function(){
	      alert("ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. í¬ì¸íŠ¸ê°€ í™˜ë¶ˆë©ë‹ˆë‹¤.");
	      $('#reservationContainer').load('/reservation/mylist'); // í”„ë˜ê·¸ë¨¼íŠ¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
	    })
	    .fail(function(xhr){
	      alert("ì·¨ì†Œ ì‹¤íŒ¨: " + xhr.responseText);
	    });
	});
</script>
<!--ê²°ì œë‚´ì—­ -->
<script>
$(function() {
	  // ê²°ì œë‚´ì—­ íƒ­ ë˜ëŠ” ë²„íŠ¼ í´ë¦­ ì‹œ í”„ë˜ê·¸ë¨¼íŠ¸ ë¡œë“œ
	  $('#loadPaymentList').on('click', function(e) {
	    e.preventDefault();

	    // íƒ­ í™œì„±í™” í† ê¸€ (ì„ íƒì‚¬í•­)
	    $('.sidebar-menu a').removeClass('active');
	    $(this).addClass('active');

	    // ë‹¤ë¥¸ ë©”ì¸ ì»¨í…ì¸  ìˆ¨ê¸°ê¸° (í•„ìš”í•˜ë©´)
	    $('.member-info, .stat-info, #reservationContainer').hide();

	    // ê²°ì œë‚´ì—­ ì»¨í…Œì´ë„ˆ ë³´ì´ê¸°
	    $('#paymentListContainer').show();

	    // AJAXë¡œ ê²°ì œë‚´ì—­ í”„ë˜ê·¸ë¨¼íŠ¸ ë¡œë“œ
	    $('#paymentListContainer').load('/payment/mypage/paymentList', function(response, status, xhr) {
	      if (status !== "success") {
	        alert("ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + xhr.statusText);
	      }
	    });
	  });

	  // í˜ì´ì§€ ë¡œë“œ ì‹œ íŠ¹ì • íŒŒë¼ë¯¸í„°ì— ë”°ë¼ ìë™ í´ë¦­ ì˜ˆì‹œ
	  const params = new URLSearchParams(window.location.search);
	  if (params.get("tab") === "payment") {
	    $('#loadPaymentList').click();
	  }
	});

</script>



</body>
</html>
