<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>AI ìŒì„± ë©´ì ‘</title>
  <link rel="stylesheet" th:href="@{/css/common.css}" />
  <link rel="stylesheet" th:href="@{/css/main.css}" />
  <link rel="stylesheet" th:href="@{/css/hero.css}" />
    <style>
 body {
  font-family: "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
  background-color: #f9f9f9;
  margin: 0;
  padding: 20px;
}

/* ---- ì¹´ë“œ 2ë‹¨ ë©”ì¸ ë ˆì´ì•„ì›ƒ ---- */
.main-container {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 40px;
  max-width: 1200px;
  margin: 40px auto 0 auto;
  padding: 0 20px;
}

/* ---- ì¹´ë“œ ê³µí†µ ---- */
.feedback-sidebar,
.main-content {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(31,77,227,0.04);
  min-height: 480px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

/* ---- ì™¼ìª½(í”¼ë“œë°±) ì¹´ë“œ ---- */
.feedback-sidebar {
  width: 380px;
  padding: 32px 24px 24px 24px;
}

.sidebar-title {
  font-size: 1.4rem;
  margin-bottom: 20px;
  color: #1f4de3;
  text-align: center;
}

.feedback-list {
  max-height: 600px;
  overflow-y: auto;
}

.feedback-item {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  background: #fafafa;
  cursor: pointer;
  transition: all 0.3s ease;
}

.feedback-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}

.feedback-item.selected {
  border-color: #1f4de3;
  background: #e3f2fd;
}

.feedback-date {
  font-size: 0.8rem;
  color: #666;
  margin-bottom: 8px;
}

.feedback-title {
  font-weight: bold;
  color: #333;
  margin-bottom: 8px;
}

.feedback-summary {
  font-size: 0.9rem;
  color: #555;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.empty-feedback {
  text-align: center;
  color: #666;
  padding: 40px 20px;
}

/* ---- ì˜¤ë¥¸ìª½(ìŒì„±ë©´ì ‘) ì¹´ë“œ ---- */
.main-content {
  width: 480px;
  padding: 32px 32px 24px 32px;
  /* ìœ„ì—ì„œ ì¤‘ë³µ ì„ ì–¸ëœ ë¶€ë¶„ì€ ì´ìª½ì—ì„œ ë®ì–´ì¨ì§ */
}

.main-content h2 {
  font-size: 1.8rem;
  margin-bottom: 16px;
  color: #1f4de3;
}

.main-content h3 {
  font-size: 1.2rem;
  color: #333;
  margin-top: 24px;
  margin-bottom: 8px;
}

.main-content p, .main-content li {
  font-size: 1rem;
  line-height: 1.6;
  color: #444;
}

.main-content ul {
  list-style: disc;
  padding-left: 20px;
}

.main-content blockquote {
  background-color: #f4f6fa;
  border-left: 4px solid #1f4de3;
  padding: 12px 16px;
  font-style: italic;
  margin: 12px 0;
}

#mic-btn {
  padding: 10px 20px;
  font-size: 1rem;
  border: none;
  border-radius: 8px;
  background-color: #1f4de3;
  color: white;
  cursor: pointer;
}

#mic-btn:hover {
  background-color: #173eb0;
}

#save-btn {
  padding: 10px 20px;
  font-size: 1rem;
  border: none;
  border-radius: 8px;
  background-color: #28a745;
  color: white;
  cursor: pointer;
  margin-left: 10px;
}

#save-btn:hover {
  background-color: #218838;
}

#save-btn:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

#status {
  margin-top: 10px;
  font-weight: bold;
}

.button-group {
  display: flex;
  gap: 10px;
  align-items: center;
}

  </style>
</head>
<body>
 <!-- Header -->
  <div th:replace="fragments/header :: headerFragment"></div>

 <section class="hero-banner">
		<div class="text-area">
			<h1>AI Chat</h1>
			<p>Prepare for your interview</p>
		</div>
		<div class="img-area">
			<!-- ì´ë¯¸ì§€ ìˆ¨ê¹€ ì²˜ë¦¬ë¨ -->
		</div>
	</section>
	<div class="board-footer">AI Chat</div>
  <div class="main-container">
    <!-- ì™¼ìª½ í”¼ë“œë°± ëª©ë¡ -->
    <div class="feedback-sidebar">
      <h3 class="sidebar-title">ğŸ“‹ ì €ì¥ëœ í”¼ë“œë°±</h3>
      <button id="new-voice-session-btn" style="width:100%;margin-bottom:16px;padding:10px 0;background:#1f4de3;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;">+ ìƒˆë¡œìš´ ìŒì„±ë©´ì ‘</button>
      <div id="feedback-list" class="feedback-list">
        <div class="empty-feedback">
          <p>ì•„ì§ ì €ì¥ëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          <p>ë…¹ìŒ í›„ ì €ì¥í•´ë³´ì„¸ìš”!</p>
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì˜ì—­ -->
    <div class="main-content">
      <h2>ğŸ¤ AI ìŒì„± ë©´ì ‘</h2>

      <!-- ë…¹ìŒ ë²„íŠ¼ -->
      <div class="button-group">
        <button id="mic-btn">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
        <button id="save-btn" disabled>ğŸ’¾ í”¼ë“œë°± ì €ì¥</button>
      </div>
      <p id="status">ë…¹ìŒ ëŒ€ê¸° ì¤‘</p>

      <!-- í…ìŠ¤íŠ¸ ë° í”¼ë“œë°± ê²°ê³¼ -->
      <div id="result-box" style="display:none;">
        <h3>ğŸ“ í…ìŠ¤íŠ¸ ë³€í™˜ ê²°ê³¼</h3>
        <p id="transcript"></p>

        <h3>ğŸ“‹ AI í”¼ë“œë°± </h3>
        <p id="summary"></p>

        <h3>ğŸ” ìƒì„¸ í”¼ë“œë°±</h3>
        <ul id="detail-list"></ul>

        <h3>ğŸ“ˆ ë¶„ì„ ìš”ì•½</h3>
        <ul>
          <li><strong>ë§ì†ë„:</strong> <span id="speech-speed"></span></li>
          <li><strong>ë°œìŒ:</strong> <span id="pronunciation"></span></li>
          <li><strong>ì¥ì :</strong> <span id="strengths"></span></li>
          <li><strong>ë‹¨ì :</strong> <span id="weaknesses"></span></li>
        </ul>

        <h3>âœ… ì˜ˆì‹œ ë¬¸ì¥</h3>
        <blockquote id="exampleSentence"></blockquote>

        <h3>ğŸ“¬ ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ</h3>
        <ul id="suggestionsJson"></ul>

        <!-- ìƒì„¸ í”¼ë“œë°± ì‚­ì œ ë²„íŠ¼ -->
        <div id="delete-feedback-box" style="display:none; margin-top: 24px; text-align: right;">
          <button id="delete-feedback-btn" style="background:#e74c3c;color:white;padding:8px 18px;border:none;border-radius:6px;cursor:pointer;font-size:1rem;">ğŸ—‘ ì‚­ì œ</button>
        </div>
      </div>
   
    </div>
  </div>
<!-- Footer -->
  <div th:replace="fragments/footer :: footerFragment"></div>
  <script>
    const micBtn = document.getElementById("mic-btn");
    const saveBtn = document.getElementById("save-btn");
    const status = document.getElementById("status");
    const transcriptEl = document.getElementById("transcript");
    const resultBox = document.getElementById("result-box");
    const summaryEl = document.getElementById("summary");
    const detailList = document.getElementById("detail-list");
    const exampleEl = document.getElementById("exampleSentence");
    const suggestionsEl = document.getElementById("suggestionsJson");
    const feedbackList = document.getElementById("feedback-list");
    const newVoiceSessionBtn = document.getElementById("new-voice-session-btn");

    let mediaRecorder;
    let chunks = [];
    let isRecording = false;
    let currentFeedbackData = null;
    let currentSessionId = null;
    let currentDetailFeedbackId = null;

    // ìŒì„± ì„¸ì…˜ ìƒì„± í•¨ìˆ˜
    async function createVoiceSession() {
      const res = await fetch('/ai/voice/session/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ title: 'ìŒì„±ë©´ì ‘' })
      });
      const data = await res.json();
      if (data.sessionId) {
        currentSessionId = data.sessionId;
      } else {
        alert('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ìƒì„±
    window.addEventListener('load', async () => {
      await createVoiceSession();
      loadFeedbackList();
    });

    // ì €ì¥ëœ í”¼ë“œë°± ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadFeedbackList() {
      try {
        const response = await fetch('/ai/voice/feedback-list');
        const feedbacks = await response.json();
        
        if (feedbacks.length === 0) {
          feedbackList.innerHTML = `
            <div class="empty-feedback">
              <p>ì•„ì§ ì €ì¥ëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              <p>ë…¹ìŒ í›„ ì €ì¥í•´ë³´ì„¸ìš”!</p>
            </div>
          `;
        } else {
          feedbackList.innerHTML = feedbacks.map(feedback => `
            <div class="feedback-item" data-id="${feedback.id}">
              <div class="feedback-date">${new Date(feedback.createdAt).toLocaleString()}</div>
              <div class="feedback-title">${feedback.sessionId}</div>
              <div class="feedback-summary">${feedback.summary || 'í”¼ë“œë°± ìš”ì•½'}</div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('í”¼ë“œë°± ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // í”¼ë“œë°± ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
    saveBtn.addEventListener("click", async () => {
      if (!currentFeedbackData) {
        status.textContent = "âŒ ì €ì¥í•  í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      try {
        status.textContent = "ğŸ’¾ ì €ì¥ ì¤‘...";
        saveBtn.disabled = true;

        const response = await fetch("/ai/voice/save-feedback", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(currentFeedbackData)
        });

        const result = await response.json();
        
        if (response.ok) {
          status.textContent = "âœ… í”¼ë“œë°±ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!";
          saveBtn.textContent = "âœ… ì €ì¥ ì™„ë£Œ";
          // í”¼ë“œë°± ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadFeedbackList();
        } else {
          status.textContent = "âŒ ì €ì¥ ì‹¤íŒ¨: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
        }
      } catch (error) {
        status.textContent = "âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message;
      } finally {
        saveBtn.disabled = false;
      }
    });

    micBtn.addEventListener("click", async () => {
      if (!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append("file", blob, "recording.webm");
          formData.append("sessionId", currentSessionId);

          status.textContent = "ğŸ§ ì°Œì‚ë  ë¶„ì„ ì¤‘...";
          const res = await fetch("/ai/voice/interview", {
            method: "POST",
            body: formData
          });

          const result = await res.json();

          if (result && result.transcript) {
            resultBox.style.display = "block";
            transcriptEl.textContent = result.transcript;
            summaryEl.textContent = result.summary;
            document.getElementById("speech-speed").textContent = result.speechSpeed;
            document.getElementById("pronunciation").textContent = result.pronunciation;
            document.getElementById("strengths").textContent = result.strengths;
            document.getElementById("weaknesses").textContent = result.weaknesses;

            // ìƒì„¸ í”¼ë“œë°± ë°°ì—´ ì¶œë ¥
            detailList.innerHTML = "";
            if (Array.isArray(result.details)) {
              result.details.forEach(item => {
                const li = document.createElement("li");
                li.innerHTML = `<strong>${item.title}</strong><br>${item.comment}`;
                detailList.appendChild(li);
              });
            }

            // ì˜ˆì‹œ ë¬¸ì¥  
            exampleEl.textContent = result.example || "";

            // ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ
            suggestionsEl.innerHTML = "";
            if (Array.isArray(result.suggestions)) {
              result.suggestions.forEach(sug => {
                const li = document.createElement("li");
                li.textContent = sug;
                suggestionsEl.appendChild(li);
              });
            }

            // í”¼ë“œë°± ë°ì´í„° ì €ì¥
            currentFeedbackData = {
              transcript: result.transcript,
              summary: result.summary,
              speechSpeed: result.speechSpeed,
              pronunciation: result.pronunciation,
              strengths: result.strengths,
              weaknesses: result.weaknesses,
              details: result.details,
              example: result.example,
              suggestions: result.suggestions,
              sessionId: currentSessionId
            };

            // ì €ì¥ ë²„íŠ¼ í™œì„±í™”
            saveBtn.disabled = false;
            saveBtn.textContent = "ğŸ’¾ í”¼ë“œë°± ì €ì¥";

            status.textContent = "âœ… í”¼ë“œë°± ì™„ë£Œ - ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”!";
          } else {
            status.textContent = "âŒ ë¶„ì„ ì‹¤íŒ¨";
          }
        };

        mediaRecorder.start();
        status.textContent = "ğŸ”´ ë…¹ìŒ ì¤‘ (ë‹¤ì‹œ í´ë¦­ ì‹œ ì¢…ë£Œ)";
        micBtn.textContent = "â¹ ë…¹ìŒ ì¢…ë£Œ";
        isRecording = true;
      } else {
        mediaRecorder.stop();
        micBtn.textContent = "ğŸ™ ë…¹ìŒ ì‹œì‘";
        isRecording = false;
      }
    });

    // ì˜¤ë¥¸ìª½ ì˜ì—­ ì´ˆê¸°í™” í•¨ìˆ˜
    function showVoiceInterviewUI() {
      resultBox.style.display = "none";
      transcriptEl.textContent = "";
      summaryEl.textContent = "";
      detailList.innerHTML = "";
      exampleEl.textContent = "";
      suggestionsEl.innerHTML = "";
      status.textContent = "ë…¹ìŒ ëŒ€ê¸° ì¤‘";
      saveBtn.disabled = true;
      saveBtn.textContent = "ğŸ’¾ í”¼ë“œë°± ì €ì¥";
      document.querySelector('.main-content h2').textContent = 'ğŸ¤ AI ìŒì„± ë©´ì ‘';
      document.getElementById('mic-btn').style.display = '';
      saveBtn.style.display = '';
      document.getElementById('delete-feedback-box').style.display = 'none';
      currentDetailFeedbackId = null;
    }

    // í”¼ë“œë°± ìƒì„¸ í‘œì‹œ í•¨ìˆ˜
    function showFeedbackDetail(feedback) {
      document.querySelector('.main-content h2').textContent = 'ğŸ“ ì €ì¥ëœ í”¼ë“œë°± ìƒì„¸';
      resultBox.style.display = "block";
      transcriptEl.textContent = feedback.transcript || '';
      summaryEl.textContent = feedback.summary || '';
      document.getElementById("speech-speed").textContent = feedback.speechSpeed || '';
      document.getElementById("pronunciation").textContent = feedback.pronunciation || '';
      document.getElementById("strengths").textContent = feedback.strengths || '';
      document.getElementById("weaknesses").textContent = feedback.weaknesses || '';
      // ìƒì„¸ í”¼ë“œë°±
      detailList.innerHTML = '';
      try {
        const details = feedback.detailsJson ? JSON.parse(feedback.detailsJson) : [];
        if (Array.isArray(details)) {
          details.forEach(item => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${item.title}</strong><br>${item.comment}`;
            detailList.appendChild(li);
          });
        }
      } catch {}
      // ì˜ˆì‹œ ë¬¸ì¥
      exampleEl.textContent = feedback.exampleSentence || '';
      // ì œì•ˆ
      suggestionsEl.innerHTML = '';
      try {
        const suggestions = feedback.suggestionsJson ? JSON.parse(feedback.suggestionsJson) : [];
        if (Array.isArray(suggestions)) {
          suggestions.forEach(sug => {
            const li = document.createElement("li");
            li.textContent = sug;
            suggestionsEl.appendChild(li);
          });
        }
      } catch {}
      status.textContent = `ì‘ì„±ì¼: ${(feedback.createdAt || '').replace('T', ' ').substring(0, 19)}`;
      // ë…¹ìŒ/ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€
      document.getElementById('mic-btn').style.display = 'none';
      saveBtn.style.display = 'none';
      // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      currentDetailFeedbackId = feedback.id;
      document.getElementById('delete-feedback-box').style.display = '';
    }

    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('delete-feedback-btn').addEventListener('click', async () => {
      if (!currentDetailFeedbackId) return;
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const res = await fetch(`/ai/voice/feedback/${currentDetailFeedbackId}`, { method: 'DELETE' });
        if (res.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          showVoiceInterviewUI();
          loadFeedbackList();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨');
        }
      } catch (err) {
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + err.message);
      }
    });

    // ëª©ë¡ í´ë¦­ ì´ë²¤íŠ¸
    feedbackList.addEventListener('click', async (e) => {
      const item = e.target.closest('.feedback-item');
      if (item) {
        const id = item.getAttribute('data-id');
        try {
          const res = await fetch(`/ai/voice/feedback-detail/${id}`);
          const feedback = await res.json();
          if (feedback && !feedback.error) {
            showFeedbackDetail(feedback);
          } else {
            alert(feedback.error || 'í”¼ë“œë°± ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨');
          }
        } catch (err) {
          alert('í”¼ë“œë°± ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜: ' + err.message);
        }
      }
    });

    // ìƒˆë¡œìš´ ìŒì„±ë©´ì ‘ ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ì¡´ UIë¡œ ë³µê·€
    newVoiceSessionBtn.addEventListener("click", async () => {
      await createVoiceSession();
      showVoiceInterviewUI();
      loadFeedbackList();
    });
  </script>
</body>
</html>
