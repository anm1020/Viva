<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì˜ˆì•½ í˜ì´ì§€</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://code.jquery.com/jquery-latest.js"></script>
  <style>
    #calendar { max-width: 300px; margin-bottom: 1rem; }
    .times-grid { display: flex; flex-wrap: wrap; gap: .5rem; }
    .times-grid button {
      padding: .5rem 1rem;
      border:1px solid #ccc;
      background:#f5f5f5;
      cursor:pointer;
    }
    .times-grid button.selected {
      background:#0078d4;
      color:#fff;
      border-color:#005a9e;
    }
    .times-grid button.disabled {
      background:#eee;
      color:#999;
      border-color:#ddd;
      cursor:not-allowed;
    }
  </style>
</head>
<body>
 <h1 th:text="'ì˜ˆì•½í•˜ê¸° - ' + ${userName} + 'ë‹˜'">ì˜ˆì•½í•˜ê¸°</h1>
<p>
  ë©´ì ‘ê´€: 
  <span th:text="${intrName}">í™ê¸¸ë™</span>
  (ID: <span th:text="${intrId}">hong</span>)
</p>

<p>
  ì˜ˆì•½ì: <span th:text="${userName} ?: 'ì´ë¦„ì—†ìŒ'"></span> 
  (ID: <span th:text="${userId}"></span>, ì—°ë½ì²˜: <span th:text="${userTel} ?: 'ë¯¸ì…ë ¥'"></span>)
</p>
 

  <!-- 1) ë‹¬ë ¥ -->
  <div id="calendar"></div>

  <!-- 2) ì‹œê°„ ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
  <div class="times-grid" id="times-grid"></div>

  <!-- 3) í™•ì • ë²„íŠ¼ -->
  <button id="btn-confirm" style="margin-top:1rem;">í™•ì¸</button>

  <!-- Thymeleaf JS ì¸ë¼ì¸ -->
  <script th:inline="javascript">
    /* ì„œë²„ì—ì„œ ì£¼ì…ëœ ë³€ìˆ˜ */
    var intrId       = /*[[${intrId}]]*/ 'unknown';
    var reservedSlots = /*[[${reservedSlots}]]*/ {}; 
    var disabledSlots = /*[[${disabledSlots}]]*/ {};
    /* reservedSlots ì˜ˆì‹œ: 
       { '2025-08-01': ['09:00','10:00'], 
         '2025-08-02': ['11:00'] } 
    */

    let selectedDate = null,
        selectedTime = null;

    // 1) ë‹¬ë ¥ ì´ˆê¸°í™”
    flatpickr("#calendar", {
      inline: true,
      dateFormat: "Y-m-d",
      onChange: function(_, dateStr) {
        selectedDate = dateStr;
        renderTimes();
      }
    });

    function renderTimes() {
    	  const grid = $('#times-grid').empty();

    	  const reserved = reservedSlots[selectedDate] || [];
    	  const disabled = disabledSlots[selectedDate] || [];
    	  const blocked  = [...reserved, ...disabled]; // ğŸ”¥ ì˜ˆì•½ + ë¹„í™œì„±í™” ëª¨ë‘ ë§‰ê¸°

    	  for (let h = 9; h <= 17; h++) {
    	    const t = (h < 10 ? '0' : '') + h + ':00';

    	    const isDisabled = blocked.includes(t);

    	    $('<button>')
    	      .text(t)
    	      .addClass(isDisabled ? 'disabled' : '')
    	      .prop('disabled', isDisabled) // â›” í´ë¦­ ë§‰ê¸°
    	      .on('click', function(){
    	        if (isDisabled) return;  // í´ë¦­ ë¬´ì‹œ
    	        $('.times-grid button').removeClass('selected');
    	        $(this).addClass('selected');
    	        selectedTime = t;
    	      })
    	      .appendTo(grid);
    	  }
    	}


    // 3) í™•ì • ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
    $('#btn-confirm').on('click', function(){
      if (!selectedDate || !selectedTime) {
        return alert('ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }

      const payload = {
        intrId:       intrId,
        reservedDate: selectedDate,
        reservedTime: selectedTime
      };

      $.ajax({
        type: 'POST',
        url: '/reservation/save',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(resId) {
          // ì˜ˆì•½ IDë¥¼ ë°›ì•„ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = `/reservation/result?resId=${resId}`;
        },
        error: function(xhr) {
          alert('ì˜ˆì•½ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + xhr.responseText);
        }
      });
    });
  </script>
</body>
</html>
