<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>í™”ìƒ ë©´ì ‘ SPA</title>

<style>
/* main-view, new-view, list-viewëŠ” ê°ê° ìˆ¨ê¹€ì²˜ë¦¬ */
.view {
	display: none;
}

.view.active {
	display: block;
}

body {
	font-family: 'Arial', sans-serif;
	background-color: #f2f2f2;
	padding: 20px;
}

/* ================================== */
 header, footer {
            background-color: #cfd8ff;
            padding: 10px 20px;
            text-align: center;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .logo {
            font-size: 1.2rem;
        }

        .login-link {
            font-size: 0.9rem;
        }

        main {
            background-color: #ffffff;
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 0;
        }

        .content-box {
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 30px 50px;
            text-align: center;
        }

        .content-box h2 {
            margin-bottom: 30px;
            font-size: 1.4rem;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .nav-button {
            width: 120px;
            height: 100px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .nav-button:hover {
            background-color: #d6d6d6;
        }

        footer {
            font-weight: bold;
        }

/* ================================== */
.room-list {
	display: flex;
	flex-wrap: wrap;
	gap: 20px;
}

.room-card {
	background-color: #fff;
	width: 300px;
	border-radius: 12px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	padding: 16px;
	position: relative;
}

.room-status-dot {
	width: 10px;
	height: 10px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 8px;
}

.status-waiting {
	background-color: red;
}

.status-playing {
	background-color: green;
}

.status-ended {
	background-color: gray;
}

.room-title {
	font-size: 1.1rem;
	font-weight: bold;
	margin: 8px 0;
}

.room-info {
	color: #666;
	font-size: 0.9rem;
	margin-top: 4px;
}

.room-icon {
	position: absolute;
	bottom: 16px;
	right: 16px;
	font-size: 1.2rem;
}

.room-list a {
	text-decoration: none;
	color: inherit;
}

.room-list a:hover {
	transform: translateY(-4px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
</style>
<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>

<!-- ë‚´ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script th:src="@{/js/webRtc/janus.js}"></script>

</head>
<body>

	<!-- [1] ë©”ì¸ í™”ë©´ -->
	<div id="main-view" class="view active">
		<header>
			<div class="logo">ë¡œê³ </div>
			<div class="login-link">
				<a href="/login">ë¡œê·¸ì¸</a>
			</div>
		</header>
		<main>
			<div class="content-box">
				<h2>ë©´ì ‘ ë©”ì¸</h2>
				<div class="button-group">
					<button class="nav-button" onclick="navigate('new')">New
						Meeting</button>
					<button class="nav-button" onclick="navigate('list')">Join</button>
				</div>
			</div>
		</main>
		<footer>í‘¸í„°</footer>
	</div>

	<!-- [2] ë°© ìƒì„± í™”ë©´ -->
	<div id="new-view" class="view">
		<h2>ë©´ì ‘ ë°© ìƒì„±</h2>
		<form id="createRoomForm">
			<label for="intrRoomTitle">ë°© ì œëª©:</label> <input type="text"
				id="intrRoomTitle" name="intrRoomTitle" required />
			<button type="submit">ë°©ìƒì„±</button>
		</form>
		<button onclick="navigate('main')">â† ë’¤ë¡œê°€ê¸°</button>
	</div>

	<!-- [3] ë°© ëª©ë¡ í™”ë©´ -->
	<div id="list-view" class="view">
		<h2>ë©´ì ‘ ë°© ëª©ë¡</h2>
		<div id="roomList" class="room-list"></div>
		<button onclick="navigate('main')">â† ë’¤ë¡œê°€ê¸°</button>
	</div>

	<!-- [4] í†µí™”ë°© í™”ë©´ -->
	<div id="videoroom-view" class="view">
	  <h2>í™”ìƒ í†µí™”</h2>
	  <video id="myVideo" autoplay muted playsinline width="320" height="240"></video>
	  <button onclick="navigate('main')">ì¢…ë£Œ</button>
	</div>


<script>
//video-room-viewì— ì§„ì… ì‹œ ì´ˆê¸°í™”
function navigate(view) {
    document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
    document.getElementById(view + '-view').classList.add('active');

    if (view === 'list') loadRoomList();
    if (view === 'videoroom') initJanus(); // í™”ìƒí†µí™” í™”ë©´ ì§„ì… ì‹œ ì´ˆê¸°í™”
}

//ë°© ìƒì„±
document.getElementById("createRoomForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const title = document.getElementById("intrRoomTitle").value;

    fetch("/api/meeting/roomcreate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ intrRoomTitle: title })
    })
    .then(res => res.json())
    .then(data => {
        alert(`ë°© ìƒì„± ì™„ë£Œ: ${data.intrRoomTitle}`);
        navigate('list');
    });
});

// ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadRoomList() {
    fetch("/api/meeting/roomlist")
        .then(res => res.json())
        .then(data => {
            const listEl = document.getElementById("roomList");
            listEl.innerHTML = ""; // ì´ˆê¸°í™”

            data.forEach(room => {
                const statusClass = room.statusCd === 'waiting' ? 'status-waiting'
                                   : room.statusCd === 'in_progress' ? 'status-playing'
                                   : 'status-ended';

                const html = `
                    <div class="room-card" onclick="enterRoom(${room.intrRoomId})">
                        <div>
                            <span class="room-status-dot ${statusClass}"></span>
                            <span>${room.intrRoomId}</span>
                        </div>
                        <div class="room-title">${room.intrRoomTitle}</div>
                        <div class="room-info">${room.hostId}ë‹˜ì˜ ë°©</div>
                        <div class="room-info">ìƒì„±: ${formatDate(room.createdDt)}</div>
                        <div class="room-icon">ğŸ”’ ğŸ”“</div>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', html);
            });
        });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString("ko-KR", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
    });
}

// ë°© ì…ì¥
function enterRoom(roomId) {
	selectedRoomId = roomId; // ì „ì—­ ë˜ëŠ” ìƒíƒœ ì €ì¥
    navigate('videoroom');   // SPA ë°©ì‹ì˜ í™”ë©´ ì „í™˜
}

// ë¸Œë¼ìš°ì € WebRTC ì§€ì› í™•ì¸ ë° janus ì´ˆê¸°í™”
function initJanus() {
    if (!Janus.isWebrtcSupported()) {
        alert("WebRTCë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        return;
    }

    Janus.init({
        debug: "all",
        callback: createJanusSession
    });
}

var version = 1.2;
var server = null;
server = "https://janus.jsflux.co.kr/janus";

let janus = null;
let sfutest = null;
let opaqueId = "videoroom-" + Janus.randomString(12);
let mypvtid = null;

function createJanusSession() {
    janus = new Janus({
        server: server,

        success: function () {
            janus.attach({
                plugin: "janus.plugin.videoroom",
                opaqueId: opaqueId,					// ì„¸ì…˜ ì‹ë³„ìš©

                // í”ŒëŸ¬ê·¸ì¸ ì—°ê²° ì„±ê³µ ì‹œ
                success: function (pluginHandle) {
                    sfutest = pluginHandle;

                    // ë°© ì°¸ì—¬ ìš”ì²­
                    const joinRequest = {
                        request: "join",
                        room: selectedRoomId,		// ì„ íƒëœ ë°© id
                        ptype: "publisher",
                        display: "ìµëª…"
                    };
                    sfutest.send({ message: joinRequest });
                },
				
                // ì—ëŸ¬ì‹œ
                error: function (error) {
                    console.error("í”ŒëŸ¬ê·¸ì¸ attach ì‹¤íŒ¨", error);
                },

                consentDialog: function (on) {
                    Janus.debug("Consent dialog should be " + (on ? "on" : "off") + " now");
                    function publishOwnFeed(useAudio) {
                        sfutest.createOffer({
                            media: {
                                audioRecv: false, videoRecv: false,
                                audioSend: useAudio, videoSend: true
                            },
                            success: function (jsep) {
                                const publish = {
                                    request: "configure",
                                    audio: useAudio,
                                    video: true
                                };
                                sfutest.send({ message: publish, jsep: jsep });
                            },
                            error: function (error) {
                                console.error("ë¯¸ë””ì–´ publish ì˜¤ë¥˜", error);
                            }
                        });
                    }

                },

                mediaState: function (medium, on) {
                	Janus.log("Janus " + (on ? "started" : "stopped") + " receiving our " + medium);
                },

                webrtcState: function (on) {
                    Janus.log("WebRTC ì—°ê²° ìƒíƒœ:", on ? "ì—°ê²°ë¨" : "ëŠê¹€");
                },

                onmessage: function (msg, jsep) {
                    if (msg.videoroom === "joined") {
                        mypvtid = msg.private_id;
                        publishOwnFeed(true);
                    }
                    if (jsep) {
                        sfutest.handleRemoteJsep({ jsep: jsep });
                    }
                },

                onlocalstream: function (stream) {
                    Janus.attachMediaStream(document.getElementById("myVideo"), stream);
                }
            });
        },

        error: function (error) {
            console.error("Janus ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨", error);
        },

        destroyed: function () {
            console.log("Janus ì„¸ì…˜ ì¢…ë£Œë¨");
        }
    });
}

function publishOwnFeed(useAudio) {
    sfutest.createOffer({
        media: {
            audioRecv: false, videoRecv: false,
            audioSend: useAudio, videoSend: true
        },
        success: function (jsep) {
            const publish = {
                request: "configure",
                audio: useAudio,
                video: true
            };
            sfutest.send({ message: publish, jsep: jsep });
        },
        error: function (error) {
            console.error("ë¯¸ë””ì–´ publish ì˜¤ë¥˜", error);
        }
    });
}


</script>

</body>
</html>