<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>í™”ìƒ ë©´ì ‘ SPA</title>

<style>
/* main-view, new-view, list-viewëŠ” ê°ê° ìˆ¨ê¹€ì²˜ë¦¬ */
html, body {
  height: 100%; 
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.view {
	display: none;
}

.view.active {
	display: block;
}

/* ================================== */

.roomList-container {
  display: flex;
  flex-direction: column;
  max-width: 1100px;
  margin: 50px auto 50px auto;
  min-height: calc(100vh - 200px);
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 14px rgba(70,110,180,0.08);
}


.room-list {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3ì—´ ê³ ì • */
  gap: 2rem;              /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
  justify-items: center;  /* ì¹´ë“œ ë‚´ë¶€ ê°€ìš´ë° ì •ë ¬ */
  margin: 2rem auto;
  max-width: 1100px;      /* í•œì¤„ì— 3ê°œê¹Œì§€ë§Œ */
}

.room-card {
  width: 300px;
  min-height: 180px;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 3px 20px #0001;
  padding: 1.6rem 1.2rem;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  transition: transform .13s;
  cursor: pointer;
  align-items: flex-start;
}

.room-card:hover {
  transform: translateY(-5px) scale(1.03);
  box-shadow: 0 5px 28px #0002;
}

.room-status-dot {
	width: 10px;
	height: 10px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 8px;
}

.status-waiting {
	background-color: red;
}

.status-playing {
	background-color: green;
}

.status-ended {
	background-color: gray;
}

.room-title {
	font-size: 1.1rem;
	font-weight: bold;
	margin: 8px 0;
}

.room-info {
	color: #666;
	font-size: 0.9rem;
	margin-top: 4px;
}

.room-icon {
	position: relative;
	top: 0px;
	left: 230px;
	font-size: 1.5rem;
}

.room-list a {
	text-decoration: none;
	color: inherit;
}

.room-list a:hover {
	transform: translateY(-4px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

#videoroom-view {
  height: 100vh;      /* ì „ì²´ í™”ë©´ */
  min-height: 0;
  margin: 0;
  padding: 0;
}

/*** ë¹„ë””ì˜¤ ì˜ì—­ css ***/
.video-chat-wrapper {
  display: flex;
  gap: 0;
  width: 100vw;
  height: calc(100vh - 110px); /* ìƒë‹¨ í—¤ë” ë“± ë¹¼ê³  ê½‰ ì±„ìš°ê¸° */
  overflow: auto;
  background: #181818;
}


/* ë©”ì¸ ë¹„ë””ì˜¤ ì˜ì—­ */
.main-video-area {
  flex: 3;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: visible; 
  min-width: 0;
  width: 100%;
  height: 100%; 
}

/* â˜… ë©”ì¸ë¹„ë””ì˜¤+ì¸ë„¤ì¼ í•˜ë‚˜ë¡œ ë³´ì´ê²Œ ê°ì‹¸ê¸° */
.main-video-bundle {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #222;
  border-radius: 22px;
  box-shadow: 0 4px 28px rgba(0,0,0,0.14);
  overflow: visible;
  margin-top: 5px;
}

/* ë©”ì¸ ë¹„ë””ì˜¤+ì¸ë„¤ì¼ ì»¨í…Œì´ë„ˆ */
.main-video-container {
  width: 100%;          /* ì „ì²´ í­ ì±„ìš°ê¸° */
  max-width: 1080px;    /* ìµœëŒ€ ë„ˆë¹„ëŠ” ì›í•˜ëŠ” ë§Œí¼ */
  height: 440px;        /* ë¹„ìœ¨ì€ í•„ìš”ì— ë”°ë¼ */
  position: relative;
  background: #222;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  padding: 0; 
}

/* ë©”ì¸ ë¹„ë””ì˜¤ */
#mainVideo {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 12px;
  background: #111;
  padding: 0px;
}

/* ì¸ë„¤ì¼ ë°” (ë©”ì¸ë¹„ë””ì˜¤ ìƒë‹¨ì— ë¼ìš´ë“œë¡œ ë¶™ì´ê¸°) */
.video-thumbnails {
  width: 100%;   /* ë¶€ëª¨ì™€ ë™ì¼í•˜ê²Œ! */
  max-width: 1080px;   /* ìœ„ì˜ main-video-containerì™€ ë§ì¶”ê¸° (ë˜ëŠ” 100%ë§Œ ì¨ë„ ë¨) */
  margin: 0 auto;      /* ê°€ìš´ë° ì •ë ¬ */
  min-height: 60px;
  background: #222;
  display: flex;
  gap: 14px;
  justify-content: center;
  border-top-left-radius: 22px;
  border-top-right-radius: 22px;
  border-bottom: 2px solid #202020;
  padding: 5px 0 5px 0;
  z-index: 2;
}


.video-thumbnails video {
  width: 110px;
  height: 75px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid transparent;
  cursor: pointer;
  pointer-events: auto; /* ë¹„ë””ì˜¤ë§Œ í´ë¦­ í—ˆìš© */
  background: #222;
}
.video-thumbnails video.active {
  border-color: #2298ff;
}

/* ì˜¤ë¥¸ìª½ íŒ¨ë„: í•­ìƒ ìƒë‹¨ë¶€í„° */
.right-panel {
  flex: 0 0 340px;   /* ê³ ì • í­ */
  height: 100%;      /* ë¶€ëª¨(.video-chat-wrapper)ì™€ ë™ì¼í•˜ê²Œ! */
  display: flex;
  flex-direction: column;
  background: #fff;
  border-left: 1px solid #dde1ed;
  box-shadow: 0 0 12px rgba(0,0,0,0.07);
  margin: 0;
  min-height: 0;     /* ì´ê²Œ flex overflow ë°©ì§€ì— ì¤‘ìš”í•¨ */
}
/*
.participant-panel {
  flex: 0 0 auto;
  margin-bottom: 20px;
  border: 1px solid #ddd;
  border-radius: 0;
  border-left: none;
  border-right: none;
  padding: 10px;
  background-color: #fff;
} 
*/
.chat-panel {
  flex: 1 1 0;
  display: flex;
  flex-direction: column;
  border: 1px solid #ddd;
  border-radius: 0;
  padding: 10px;
  background: #fff;
  min-height: 200px;
}

/* ì˜¤ë¥¸ìª½ ì „ì²´ íŒ¨ë„ (ì°¸ê°€ì + ì±„íŒ…) */
.right-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  border-left: 1px solid #ccc;
  padding: 10px;
  background: #f9f9f9;
}

/* ğŸ”· ì±„íŒ…ì°½ ì˜ì—­ */
.chat-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #ddd;
  background: #fff;
  padding: 10px;
}

/* ì±„íŒ…ì°½ ë‚´ë¶€ êµ¬ì„± */
.chat-title {
  font-weight: bold;
  padding: 10px;
  background-color: #cfd8ff;
  border-bottom: 1px solid #ccc;
  text-align: center;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  padding: 8px;
  background: #fafafa;
}

.chat-input-area {
  display: flex;
  gap: 10px;
}

.chat-input-area input {
  flex: 1;
  padding: 8px;
  border: none;
  border-right: 1px solid #ccc;
}

.chat-input-area button {
  padding: 8px 12px;
  border: none;
  background-color: #607d8b;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

.chat-input-area button:hover {
  background-color: #455a64;
}

.label {
	font-size: 14px;
	background-color: #3498db;
	color: #fff;
	padding: 2px 6px;
	border-radius: 3px;
}

.hide {
	display: none;
}

/*
.remote-grid {
	display: grid;
	grid-template-columns: repeat(2, 1fr); // 2ì¤„ê³ ì •
	gap: 10px;
}

.remote-box {
	position: relative;
	border: 1px solid #ccc;
	padding: 5px;
	min-height: 150px;
}

.remote-box video {
  background-color: black;
  width: 100%;
  height: 240px; // ë˜ëŠ” auto, fixed ë“±
  object-fit: cover;
}

.bitrate-controls {
	margin-left: 10px;
	display: inline-block;
	position: relative;
}

.dropdown-menu {
	list-style: none;
	position: absolute;
	background: #fff;
	border: 1px solid #aaa;
	margin: 0;
	padding: 0;
	display: none;
}

.dropdown-menu li {
	padding: 5px 10px;
}

.dropdown-menu li:hover {
	background-color: #f0f0f0;
}

#bitrateset:hover+.dropdown-menu, .dropdown-menu:hover {
	display: block;
}

.remote-box video {
  width: 100%;
  max-width: 480px;       // ğŸ‘ˆ ì›í•˜ëŠ” ë„ˆë¹„ ì œí•œ 
  height: auto;
  aspect-ratio: 4 / 3;     // ë˜ëŠ” 16 / 9 ë“± ë¹„ìœ¨ ê³ ì • 
  object-fit: cover;       // contain or cover 
}
*/
/* ìƒë‹¨ ì‚¬ìš©ì ëª©ë¡ ë°” */
/*
.participant {
  background-color: #ffffff;
  padding: 6px 12px;
  border-radius: 4px;
  min-width: 80px;
}

.participant.current {
  border: 2px solid #4fa7ff;
}
*/
/* ------------------------------ */

.participant-panel {
  flex: 0 0 auto;
  margin-bottom: 20px;
  border: 1px solid #ddd;
  padding: 10px;
  background-color: #fff;
}

.panel-header {
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
}

.panel-body {
  max-height: 150px;
  overflow-y: auto;
  padding: 8px; 
}


.participant {
  display: flex;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px solid #eee;
}

.participant .avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #ccc;
  color: #fff;
  text-align: center;
  line-height: 32px;
  margin-right: 10px;
  font-weight: bold;
}

.participant .display-name {
  background-color: white;
  color: black;
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  margin-left: 8px;
  flex-grow: 1;
}

.participant .icons {
  font-size: 0.9rem;
  color: gray;
}

/* ---------------------------- */

/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
.control-bar {
  width: 100%;
  max-width: 1080px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 24px;
  background: #181818;  /* ê²€ì€ë°°ê²½ */
  border-bottom-left-radius: 22px;
  border-bottom-right-radius: 22px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.11);
  padding: 10px 0 14px 0;
  position: relative;
}

.control-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #e0e0e0;
  font-weight: 500;
  font-size: 0.8rem;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: color 0.15s, background 0.15s;
  min-width: 60px;
  padding: 8px 12px;
  border-radius: 12px;
}
.control-btn:hover {
  background: #23242b;
  color: #49a0fa;
}
.control-btn .icon {
  font-size: 1.55rem;
  margin-bottom: 2px;
}
.control-btn.end {
  color: #f34555;
  font-weight: bold;
}
.control-btn.end:hover {
  background: #2c191a;
  color: #ff7575;
}

/* -------------------*/
/* ë¹„ë””ì˜¤í™”ë©´ */
/*
.video-thumbnails {
  display: flex;
  gap: 10px;
  padding: 10px;
  overflow-x: auto;
  background: #111;
  justify-content: center;
}
.video-thumbnails video {
  width: 120px;
  height: 80px;
  object-fit: cover;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: border 0.2s;
}
.video-thumbnails video.active {
  border-color: #2298ff;
}
.main-video-container {
  width: 100%;
  height: 420px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #222;
  margin-bottom: 12px;
}
#mainVideo {
  width: 640px;
  height: 100%;
  background: #000;
  border-radius: 12px;
  object-fit: contain;
}
*/

.profile-popup {
  position: absolute;
  min-width: 220px;
  background: #232428;
  color: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.33);
  padding: 16px 20px;
  z-index: 1002;
  animation: fadeIn 0.12s;
}
@keyframes fadeIn { from { opacity:0; transform: scale(0.98); } to { opacity:1; } }

.profile-header {
  display: flex; align-items: center; margin-bottom: 16px;
}
.profile-header .avatar {
  width: 44px; height: 44px; border-radius: 50%; background: #666; font-size: 1.5rem;
  display: flex; align-items: center; justify-content: center; font-weight: bold;
  margin-right: 12px;
}
.profile-header .profile-nick { font-weight: bold; font-size: 1.1rem; }

.profile-volume { display: flex; align-items: center; gap: 10px; }
.profile-volume .icon { font-size: 1.2rem; }
.profile-volume .volume-value { font-size: 0.98rem; margin-left: 4px; }



/* ë°©ìƒì„±ë²„íŠ¼(í˜„ì§„) */
.room-btn-row {
  display: flex;
  justify-content: center;
  gap: 18px;           /* ë²„íŠ¼ ì‚¬ì´ ì—¬ë°± */
  margin-top: 20px;    /* ìœ„ìª½ ì—¬ë°± */
  width: 100%;
}

.creation{
	background: #e0e4eb; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
	color: #333; /* ì–´ë‘ìš´ ê¸€ììƒ‰ */
	font-size: 13px;
	padding: 6px 12px;
	border: none; /* í…Œë‘ë¦¬ ì—†ìŒ */
	border-radius: 6px;
	cursor: pointer;
	transition: background 0.2s, color 0.2s;
}
.creation:hover {
	background: #cfd5e0; /* ì‚´ì§ ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ ê°•ì¡° */
	color: #000;
}

.moveMain{
	background: #e0e4eb; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
	color: #333; /* ì–´ë‘ìš´ ê¸€ììƒ‰ */
	font-size: 13px;
	padding: 6px 12px;
	border: none; /* í…Œë‘ë¦¬ ì—†ìŒ */
	border-radius: 6px;
	cursor: pointer;
	transition: background 0.2s, color 0.2s;
}
.moveMain:hover {
	background: #cfd5e0; /* ì‚´ì§ ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ ê°•ì¡° */
	color: #000;
}

/* ë°© ìƒì„± ë²„íŠ¼ css ì¶”ê°€(í˜„ì§„) */
.btn-createRoom{
	background: #e0e4eb; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
	color: #333; /* ì–´ë‘ìš´ ê¸€ììƒ‰ */
	font-size: 13px;
	padding: 6px 12px;
	border: none; /* í…Œë‘ë¦¬ ì—†ìŒ */
	border-radius: 6px;
	cursor: pointer;
	transition: background 0.2s, color 0.2s;
}
.btn-createRoom:hover {
	background: #cfd5e0; /* ì‚´ì§ ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ ê°•ì¡° */
	color: #000;
}

.btn-close{
	background: #e0e4eb; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
	color: #333; /* ì–´ë‘ìš´ ê¸€ììƒ‰ */
	font-size: 13px;
	padding: 6px 12px;
	border: none; /* í…Œë‘ë¦¬ ì—†ìŒ */
	border-radius: 6px;
	cursor: pointer;
	transition: background 0.2s, color 0.2s;
}
.btn-close:hover {
	background: #cfd5e0; /* ì‚´ì§ ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ ê°•ì¡° */
	color: #000;
}

/* ëª¨ë‹¬ ë°°ê²½ */
.modal {
  display: none; 
  position: fixed; 
  z-index: 9999;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.15);
}

/* ëª¨ë‹¬ ë³¸ì²´ */
.modal-content {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 32px rgba(0,0,0,0.10);
  padding: 32px 36px 24px 36px;
  width: 350px;
  margin: 60px auto 0 auto;
  position: relative;
  font-size: 16px;
}

/* ë‹«ê¸° ë²„íŠ¼ */
.modal-content .close {
  position: absolute;
  top: 16px; right: 18px;
  font-size: 22px;
  color: #8b8b8b;
  cursor: pointer;
  transition: color 0.2s;
}
.modal-content .close:hover { color: #444; }

/* í¼ ê·¸ë£¹ ì •ë ¬ */
.modal-content .form-group {
  margin-bottom: 18px;
}
.modal-content label {
  display: flex;
  flex-direction: column;
  font-size: 15px;
  color: #333;
  margin-bottom: 2px;
}
.modal-content input[type="text"],
.modal-content input[type="password"],
.modal-content input[type="number"] {
  padding: 7px 10px;
  border: 1px solid #e3e5e8;
  border-radius: 6px;
  font-size: 15px;
  margin-top: 6px;
  margin-bottom: 6px;
  background: #f9fafb;
  transition: border 0.2s;
}
.modal-content input:focus {
  outline: none;
  border-color: #82aaff;
  background: #fff;
}
/* í˜„ì§„ ì¶”ê°€ ë */



</style>
<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>
<script	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js}"></script>
<script	th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js}"></script>
<script	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js}"></script>
<script	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js}"></script>
<script	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js}"></script>
<script	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js}"></script>
<script th:src="@{https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js}"></script>
<script th:src="@{https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js}"></script>


<!-- ë‚´ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script th:src="@{/js/webRtc/janus.js}"></script>
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" th:href="@{/css/hero.css}" />
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css}" />
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css}" />


</head>
<body>
<!-- header -->
<div th:replace="fragments/header :: headerFragment"></div>

<!-- ë°© ëª©ë¡ í™”ë©´ -->
<div id="list-view" class="view active">
	<section class="hero-banner">
		<div class="text-area">
			<h1>Interview</h1>
			<p>Prepare for an interview through a video interview</p>
		</div>
		<div class="img-area"></div>
	</section>
	<div class="board-footer">í™”ìƒ ë©´ì ‘ë°©</div>
	<div class="roomList-container">
		<input type="hidden" id="user_id" name="user_id" th:value="${userId}">
		<div id="roomList" class="room-list"></div>
		
		<div class="room-btn-row">
			<button class="moveMain" onclick="location.href = '/main'">ë©”ì¸í™”ë©´ìœ¼ë¡œ ì´ë™</button>
			<button class="creation" th:if="${userRole == 'intr'}">ë°©ìƒì„±</button>
		</div>
	
		<div id="createRoomModal" class="modal" style="display:none;">
			<div class="modal-content">
			    <h2>ë©´ì ‘ ë°© ìƒì„±</h2>
			    <label for="intrRoomTitle">ë°© ì œëª©:</label> 
			    <input type="text" id="intrRoomTitle" name="intrRoomTitle" /></label><br>
			    <label for="roomPw">ë¹„ë°€ë²ˆí˜¸:</label>
			    <input type="password" id="roomPw" name="roomPw" /></label><br>
			    <label for="participantCount">ìµœëŒ€ ì°¸ê°€ ì¸ì›:</label>
			    <input type="number" id="participantCount" name="participantCount" min="2" max="6" value="2" /></label><br>
			    <input type="hidden" id="host_id" name="host_id" th:value=${userId}>
			    <button id="btn-createRoom" class="btn-createRoom">ë°© ìƒì„±</button>
			    <button id="btn-close" class="btn-close">ì·¨ì†Œ</button>
			</div>
		</div>
	</div>
</div>

<!-- í†µí™”ë°© í™”ë©´ -->
<div id="videoroom-view" class="view">
			
	<div class="video-chat-wrapper">
		<div class="main-video-area">
		  <div class="main-video-bundle">
			<!-- ìƒë‹¨ ì¸ë„¤ì¼ ë°” -->
			<div class="video-thumbnails" id="videoThumbnails"></div>
			<!-- ì¤‘ì•™ ë©”ì¸ ë¹„ë””ì˜¤ -->
			<div class="main-video-container">
			  <video id="mainVideo" autoplay playsinline muted></video>
			</div>
			<div class="control-bar">
			    <div class="control-btn" id="mute-toggle">
			      <span class="icon">ğŸ¤</span>
			      <span class="label">ë§ˆì´í¬</span>
			    </div>
			    <div class="control-btn" id="startCamBtn">
			      <span class="icon">ğŸ“·</span>
			      <span class="label">ì¹´ë©”ë¼</span>
			    </div>
			    <div class="control-btn" id="recordToggleBtn">
			      <span class="icon">ğŸ¥</span>
			      <span class="label">ë…¹í™”</span>
			    </div> 
			    <div class="control-btn" id="audioRecordToggleBtn">
			      <span class="icon">ğŸ™ï¸</span>
			      <span class="label">ìŒì„±ë…¹ìŒ</span>
			    </div>
			    <div class="control-btn end" id="exitBtn">
			      <span class="icon">ğŸšª</span>
			      <span class="label">ì¢…ë£Œ</span>
			    </div>
			  </div>
		  </div>
		</div>
		<div class="right-panel">
			<!-- ì°¸ê°€ì íŒ¨ë„ -->
			<div id="participantPanel" class="participant-panel">
			  <div class="panel-header">
			    <span>ì°¸ê°€ì(<span id="participantCount">0</span>)</span>
			    <button onclick="refreshParticipantList()">ğŸ”„</button>
			  </div>
			  <div class="panel-body" id="participantList"></div>
			</div>
			<!-- ğŸ”µ ì±„íŒ…ì°½ -->
		    <div class="chat-panel">
		      <div class="chat-title">ì±„íŒ…ì°½</div>
		      <div class="chat-messages" id="chatMessages"></div>
		      <div class="chat-input-area">
		        <input type="text" id="chatInput" placeholder="ë‚´ìš© ì…ë ¥" />
		        <button id="sendChatBtn">ì „ì†¡</button>
		      </div>
		  	</div>
		</div>
	</div>
</div>

<script>
//âœ… ì „ì—­ ìƒíƒœ ë³€ìˆ˜
var version = 1.2;
var server = null;
server = "https://janus.jsflux.co.kr/janus";
var janus = null;
var sfutest = null;
var mypvtid = null;
var opaqueId = "videoroom-" + Janus.randomString(12);
var selectedRoomId = null;
var displayName = null;
var feeds = [];
var isDestroying = false; 		// ì¤‘ë³µ detach ë°©ì§€ìš© í”Œë˜ê·¸
const audioContexts = {};  		// { [feedId]: { ctx, gainNode } }
var myUsername = null;
var myDataId = null;
const userId = "[[${userId}]]";
let hostId = null;
let isDataChannelReady = false;
let currentView = null;
const feedHandles = {}; 
let isMicMuted = false;			//í˜„ì¬ ìŒì†Œê±° ìƒíƒœ ì €ì¥ìš© ì „ì—­ ë³€ìˆ˜ (ì´ˆê¸°ê°’ false)

document.addEventListener("DOMContentLoaded", () => {
	  // 'list-view'ê°€ í™œì„±í™”ëœ ê²½ìš° ìë™ìœ¼ë¡œ ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
	  const listView = document.getElementById("list-view");
	  if (listView && listView.classList.contains("active")) {
	  	loadRoomList();
	}
});

// navigate ì²˜ë¦¬ (í™”ë©´ ì „í™˜ ì‹œ ì •ë¦¬ í¬í•¨)
function navigate(view) {
	
	// 1ï¸ í˜„ì¬ ë·°ì—ì„œ ë‚˜ê°€ê¸° ì „ì— ì •ë¦¬ ì‘ì—…
	if (currentView === 'videoroom' && view !== 'videoroom') {
	    leaveRoom();  // WebSocket + Janus ì—°ê²° ì •ë¦¬
	}
	
	// 2 í™”ë©´ ì „í™˜
  	document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
  	document.getElementById(view + '-view').classList.add('active');
  
  	// ë·° ë³„ ì§„ì… ì²˜ë¦¬
  	if (view == 'new')
  	
  	if (view === 'list'){
	  	loadRoomList();
  	}
  	
  	if (view === 'videoroom'){
		initJanus(); // ë°© ì…ì¥ ì‹œ ì´ˆê¸°í™”
  	}
  
  	currentView = view;
}

// ë°© ìƒì„± ë²„íŠ¼ í´ë¦­
$(document).off("click", ".creation").on("click", ".creation", function () {
    $("#createRoomModal").show();
    $("#intrRoomTitle").val("");
    $("#roomPw").val("");
    $("#participantCount").val("2");
});

// ëª¨ë‹¬ ë‹«ê¸°
$(document).off("click", ".modal .btn-close").on("click", ".modal .btn-close", function () {
    $("#createRoomModal").hide();
});

// ë°”ê¹¥ ì˜ì—­ í´ë¦­ì‹œ ë‹«ê¸° (ì„ íƒ)
$(document).off("mousedown", ".modal").on("mousedown", ".modal", function (e) {
    if ($(e.target).is(".modal")) $("#createRoomModal").fadeOut(100);
});

$(document).off("click", "#btn-createRoom").on("click", "#btn-createRoom", function () {
    const title = $("#intrRoomTitle").val();
    const host_id = $("#host_id").val();
    const roomPw = $("#roomPw").val();
    const participantCount = $("#participantCount").val();

    // ê°„ë‹¨ ìœ íš¨ì„±
    if (!title) return alert("ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

    fetch("/api/meeting/roomcreate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            intrRoomTitle: title,
            roomPw: roomPw,
            hostId: host_id,
            participantCount: participantCount
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
        return res.json();
    })
    .then(data => {
        alert(`ë°© ìƒì„± ì™„ë£Œ: ${data.intrRoomTitle}`);

        const roomId = data.intrRoomId;
        const hostId = data.hostId;

        // Janus ì„¸ì…˜ ìƒì„±(ì•„ë˜ í•¨ìˆ˜ ì°¸ê³ )
        return createRoomsOnJanus(roomId, hostId, participantCount);
    })
    .then(() => {
        // ëª¨ë‘ ì™„ë£Œ í›„
        $("#createRoomModal").hide();
        loadRoomList();
    })
    .catch(err => {
        alert("ë°© ìƒì„± ì‹¤íŒ¨: " + err.message);
    });
});


// âœ… ë°© ìƒì„±
const createForm = document.getElementById("createRoomForm");
if (createForm) {
  createForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const title = document.getElementById("intrRoomTitle").value;
	const host_id = document.getElementById("host_id").value;
	const roomPw = document.getElementById("roomPw").value;                
	const participantCount = document.getElementById("participantCount").value;

	console.log("hostId : " + host_id);
    fetch("/api/meeting/roomcreate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
    	  intrRoomTitle: title,
    	  roomPw: roomPw,
    	  hostId: host_id,
    	  participantCount: participantCount
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(`ë°© ìƒì„± ì™„ë£Œ: ${data.intrRoomTitle}`);
      
      const roomId = data.intrRoomId;
      const hostId = data.hostId;

   	  // âœ… Janus ì„¸ì…˜ ì‹œì‘ â†’ ë°© ìƒì„± â†’ ì¢…ë£Œ
      createRoomsOnJanus(roomId, hostId);
      
      navigate('list');
    });
  });
}

// ë°© ìƒì„±ìš© janus ì„¸ì…˜ ìƒì„±
function createRoomsOnJanus(roomId, hostId) {
	  Janus.init({
	    debug: "all",
	    callback: function () {
	      janus = new Janus({
	        server: server, // Janus ì„œë²„ ì£¼ì†Œ
	        success: function () {
	          // ë¹„ë””ì˜¤ë£¸ í”ŒëŸ¬ê·¸ì¸ attach
	          janus.attach({
	            plugin: "janus.plugin.videoroom",
	            success: function (videohandle) {
	              videohandle.send({
	                message: {
	                  request: "create",
	                  room: roomId,
	                  description: `Room for host ${hostId}`,
	                  publishers: 6,
	                  data: true
	                }
	              });
	              
	              console.log("ğŸ“¹ Video room created");
	            },
	            error: function (err) {
	              console.error("Video plugin attach error", err);
	            }
	          });
	        },
	        error: function (err) {
	          console.error("Janus session error", err);
	        },
	        destroyed: function () {
	          console.log("Janus session destroyed");
	        }
	      });
	    }
	  });
}

// âœ… ë°© ëª©ë¡
function loadRoomList() {
  fetch("/api/meeting/roomlist")
    .then(res => res.json())
    .then(data => {
      const listEl = document.getElementById("roomList");
      if (!listEl) return;
      listEl.innerHTML = "";

      data.forEach(room => {
        const statusClass = room.statusCd === 'waiting' ? 'status-waiting'
                          : room.statusCd === 'in_progress' ? 'status-playing'
                          : 'status-ended';

        const div = document.createElement("div");
        div.className = "room-card";
        div.innerHTML = `
          <div>
            <span class="room-status-dot ${statusClass}"></span>
            <span>${room.intrRoomId}</span>
	        <span class="room-icon">${room.roomPw ? 'ğŸ”’' : 'ğŸ”“'}</span>
          </div>
          <div class="room-title">${room.intrRoomTitle}</div>
          <div class="room-info">${room.hostId}ë‹˜ì˜ ë°©</div>
          <div class="room-info">í˜„ì¬ ì°¸ê°€ ì¸ì› : 0 / ${room.participantCount}</div>
          <div class="room-info">ìƒì„±: ${formatDate(room.createdDt)}</div>
        `;
        div.addEventListener("click", () => {
	        if (room.roomPw) {
	            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ íŒì—…
	            const input = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
	            if (input === null) return; // ì·¨ì†Œ
	            if (input === room.roomPw) {
	                // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ â†’ ì…ì¥
	                enterRoom(room.intrRoomId, room.hostId, userId);
	            } else {
	                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
	            }
	        } else {
	            // ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ë°© â†’ ë°”ë¡œ ì…ì¥
	            enterRoom(room.intrRoomId, room.hostId, userId);
	        }
	    });
        listEl.appendChild(div);
      });
    });
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString("ko-KR", {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
  });
}

//ì°¸ê°€ì ëª©ë¡ì„ ë‹´ëŠ” ì „ì—­ ë°°ì—´
let participants = [];

//ì°¸ê°€ì ëª©ë¡ ì½˜ì†” ì¶œë ¥ í•¨ìˆ˜
function logParticipants() {
  console.log("ğŸ“‹ í˜„ì¬ ì°¸ê°€ì ëª©ë¡:");
  participants.forEach(p => {
    console.log(`- ID: ${p.id}, Display: ${p.display}, AudioMuted: ${p.audioMuted}, VideoMuted: ${p.videoMuted}`);
  });
}

// âœ… ì°¸ê°€ì ì¶”ê°€ í•¨ìˆ˜
function addParticipant(id, display, audioMuted = false, videoMuted = false) {
	const idStr = String(id);
	const exists = participants.some(p => p.display === display);

	participants[id] = {
		    id,
		    display,
		    audioMuted: audioMuted,
		    videoMuted: videoMuted
	};
	
	if (!exists) {
	    participants.push({ id: idStr, display, audioMuted, videoMuted });
	    console.log(`âœ… ì°¸ê°€ì ì¶”ê°€ë¨: ${idStr} (${display})`);
	    renderParticipants();
	} else {
	    console.log(`âš ï¸ ì¤‘ë³µ ì°¸ê°€ì ë¬´ì‹œ: ${display}`);
	}  
}

// âœ… ì°¸ê°€ì ì œê±° í•¨ìˆ˜
function removeParticipant(id) {
  participants = participants.filter(p => p.id !== id);
  logParticipants();
}

// ì°¸ê°€ì ëª©ë¡ ë Œë” í•¨ìˆ˜
function renderParticipants() {
	logParticipants();
	const listEl = document.getElementById('participantList');
	const countEl = document.getElementById('participantCount');
	  
	listEl.innerHTML = ''; // ì´ˆê¸°í™”
	countEl.textContent = participants.length;

	participants.forEach(p => {
	    const avatarChar = p.display ? p.display.charAt(0).toUpperCase() : '?';
	    const participantEl = document.createElement('div');
	    participantEl.className = 'participant';
	    participantEl.setAttribute('data-remote-id', p.remoteId);  // <- ë°˜ë“œì‹œ í•„ìš”!

	    participantEl.innerHTML = `
	      <div class="avatar">${avatarChar}</div>
	      <div class="display-name">${p.display}</div>
	      <div class="icons">
	        <span>${p.audioMuted ? 'ğŸ”‡' : 'ğŸ¤'}</span>
	        <span>${p.videoMuted ? 'ğŸ“·âŒ' : 'ğŸ¥'}</span>
	      </div>
	    `;
	    listEl.appendChild(participantEl);
	});
}

function refreshParticipantList() {
	renderParticipants();
}


// âœ… ë°© ì…ì¥
function enterRoom(roomId, host, name) {
  selectedRoomId = roomId;
  displayName = name;
  hostId = host;
  
  console.log("ì„ íƒëœ ë°© ë²ˆí˜¸ : " + selectedRoomId);
  console.log("ì„ íƒëœ ë°© hostId : " + hostId);
  console.log("ì…ì¥ ìœ ì € Id : " + displayName);
  
  connectChat(selectedRoomId);		// ì±„íŒ…ë°© ì—°ê²°

  
  // ğŸ”» ê¸°ì¡´ ì˜ìƒ DOM ì´ˆê¸°í™”
  $('#remoteContainer').empty();
  $('#local-box').remove();
  
  navigate('videoroom');
}

// âœ… Janus ì´ˆê¸°í™”
function initJanus() {
  if (!Janus.isWebrtcSupported()) {
    alert("WebRTCë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
    return;
  }
  
  Janus.init({
    debug: "all",
    callback: createJanusSession
  });
}

// âœ… ì„¸ì…˜ ìƒì„±
function createJanusSession() {
  
	console.log("ì„¸ì…˜ ìƒì„± : createJanusSession ì§„ì…");
	
	if (janus !== null) {
	    janus.destroy();
	    janus = null;
	  }
	  feeds = [];
	
    janus = new Janus({
    server: server,
    success: function () {
      janus.attach({
        plugin: "janus.plugin.videoroom",
        opaqueId: opaqueId,
        success: function (pluginHandle) {
          sfutest = pluginHandle;
          sfutest.send({
            message: {
              request: "join",
              room: Number(selectedRoomId),
              ptype: "publisher",
              display: displayName
            }
          });
          console.log("ì„¸ì…˜ ìƒì„± : ì„±ê³µ");
        },

     	// ICE ìƒíƒœ ë³€ê²½ ë¡œê·¸
		iceState: function(state) {
			Janus.log("ICE state changed to " + state);
		},
		
		// ë¯¸ë””ì–´ ì „ì†¡ ìƒíƒœ (audio/video) ë¡œê·¸
		mediaState: function(medium, on) {
			Janus.log("Janus " + (on ? "started" : "stopped") + " receiving our " + medium);
		},
		
		// webRTC ì—°ê²° ìƒíƒœ
		webrtcState: function(on) {
			Janus.log("Janus says our WebRTC PeerConnection is " + (on ? "up" : "down") + " now");
			// ëŒ€ì—­í­ ì¡°ì ˆ ë²„íŠ¼ì˜ì—­ í‘œì‹œ
			$('#bitrate').parent().parent().removeClass('hide').show();
			// ê° ëŒ€ì—­í­ ë©”ë‰´ í´ë¦­ ì‹œ bitrate ì„¤ì • ì²˜ë¦¬
			$('#bitrate a').click(function() {
				var id = $(this).attr("id");
				var bitrate = parseInt(id)*1000;	// kbps -> bps ë³€í™˜
				if(bitrate === 0) {
					Janus.log("Not limiting bandwidth via REMB");
				} else {
					Janus.log("Capping bandwidth to " + bitrate + " via REMB");
				}
				// ë²„íŠ¼ UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° ë©”ë‰´ ë‹«ê¸°
				$('#bitrateset').html($(this).html() + '<span class="caret"></span>').parent().removeClass('open');
				// janus ì„œë²„ì— bitrate ì„¤ì • ìš”ì²­
				sfutest.send({ message: { request: "configure", bitrate: bitrate }});
				return false;
			});
		},
        
        onmessage: function (msg, jsep) {
          
          console.log("ì°¸ê°€í•œ ë°© ë²ˆí˜¸: " + selectedRoomId);
          console.log("[DEBUG] onmessage ìˆ˜ì‹  msg:", msg);
          // ë°© ìµœì´ˆ ì°¸ê°€ì‹œ
          if (msg.videoroom === "joined") {
        	mypvtid = msg.private_id;
        	// ë³¸ì¸ audio/video ì •ë³´
        	const hasAudio = msg.audio_codec !== null;
        	const hasVideo = msg.video_codec !== null;
        	
        	console.log("ë³¸ì¸ audio_codec:", msg.audio_codec);
        	console.log("ë³¸ì¸ video_codec:", msg.video_codec);
        	  
        	addParticipant(msg.id, displayName, !hasAudio, !hasVideo);
        	renderParticipants();
        	
            publishOwnFeed(displayName);
// 				publishOwnDummyFeed()
            
            // ì°¸ê°€ì ëª©ë¡ ì²˜ë¦¬
            if (msg.publishers) {
              
              msg.publishers.forEach(pub => {
            	const idStr = String(pub.id);
            	
            	if (recentlyLeft.has(idStr)) {
                    console.log("â³ recentlyLeft ìºì‹œ ê°ì§€ â†’ skip:", idStr);
                    return;
                }
                if (feeds.some(f => f.rfid === pub.id)) {
                    console.log("âš ï¸ ì´ë¯¸ ë“±ë¡ëœ feed â†’ skip:", pub.id);
                    return;
                }
                
                if (pub.display === displayName) return; // ë³¸ì¸ì€ ë¬´ì‹œ
                console.log("ì°¸ê°€ì : " + pub.display, displayName);
                
            	const audioMuted = pub.audio_codec === null;
                const videoMuted = pub.video_codec === null;
             
                addParticipant(pub.id, pub.display, audioMuted, videoMuted);
                newRemoteFeed(pub.id, pub.display);
                
              });
              renderParticipants();
            }
          }
          
          // ìƒˆë¡œìš´ ìœ ì €ê°€ ì…ì¥í•œ ê²½ìš°
          if (msg.videoroom === "event" && msg.publishers) {
        	  msg.publishers.forEach(pub => {
        		const idStr = String(pub.id);  
        		
        		if (recentlyLeft.has(idStr)) {
	        		const age = Date.now() - recentlyLeft.get(idStr);
	        		if (age < 3000) {
	        		     console.log(`â³ í‡´ì¥ ìºì‹œ ë¬´ì‹œ: ${idStr} (age ${age})`);
	        		     return;
	        		} else {
	        		     recentlyLeft.delete(idStr); // ë§Œë£Œëœ ìºì‹œëŠ” ì œê±°
	        		}
        		}
        		
	        	if (pub.display === displayName) return; // âœ… ë³¸ì¸ì€ ì œì™¸
        		const alreadyExists = feeds.some(f => String(f.rfid) === idStr);
        		if (!alreadyExists && !isRecentlyLeft(pub.id)) {
        			const audioMuted = pub.audio_codec === null;
        		    const videoMuted = pub.video_codec === null;

        		    addParticipant(pub.id, pub.display, audioMuted, videoMuted); // âœ… ì°¸ê°€ì ì¶”ê°€
        		    newRemoteFeed(pub.id, pub.display);                          // âœ… í”¼ë“œ ì—°ê²°
        	 	} else {
        	    	console.log(`âš ï¸ ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” feed (${pub.id}) ë¬´ì‹œ`);
        	 	}
        	});
        	renderParticipants(); // UI ê°±ì‹ 
          }

       	  // ì°¸ê°€ì í‡´ì¥ ì²˜ë¦¬ (unpublished ë˜ëŠ” leaving ì´ë²¤íŠ¸)
          if (msg.videoroom === "event" && (msg.unpublished || msg.leaving)) {
            const leavingId = msg.unpublished || msg.leaving;
            console.log("ì¬ìƒì„± í™•ì¸ìš© í‡´ì¥ ì²˜ë¦¬ : " + recentlyLeft);
            
            // ë³¸ì¸ í‡´ì¥ ('ok')ì´ë©´ ì „ì²´ í´ë¦°ì—…
            if (leavingId === 'ok' && msg.private_id === mypvtid) {
              console.log("ğŸ” ë³¸ì¸ í‡´ì¥ ê°ì§€ â†’ ì „ì²´ í´ë¦°ì—…");
              cleanupAllFeeds();
              return;
            }

            console.log("ğŸšª ì°¸ê°€ì í‡´ì¥ ê°ì§€:", leavingId, typeof leavingId);
            console.log("í˜„ì¬ feeds ëª©ë¡:", feeds.map(f => f.rfid));

            // âœ… ì •ë¦¬ ìˆ˜í–‰
            removeParticipant(leavingId);       // ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
            removeRemoteFeed(leavingId);        // feeds ë°°ì—´, DOM, ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì œê±°
            renderParticipants();           	// UI ê°±ì‹ 
            
            console.log("í˜„ì¬ feeds ëª©ë¡:", feeds.map(f => f.rfid));

	         // onmessage í‡´ì¥ ì²˜ë¦¬ ì‹œ
	         if (leavingId !== 'ok') {
	           markAsLeft(leavingId);
	           console.log("ì¬ìƒì„± í™•ì¸ìš© : " + recentlyLeft);
	         }
            
          }
          // ğŸ”» ìˆ˜ì‹ í•œ jsep ì²˜ë¦¬
          if (jsep) {
            sfutest.handleRemoteJsep({ jsep });
          }
        },

        onlocalstream: function (stream) {		// ë‚´ ì¶œë ¥í™”ë©´
        	console.log("onlocalstream ì§„ì…");
        		
        	const remoteId = 'local'; // ê³ ì • ID
        	const videoElId = `remotevideo-${remoteId}`;
        	const boxElId = `remote-box-${remoteId}`;
        	const muteBtnId = `mute-btn-${remoteId}`;
        	const volumeSliderId = `volume-slider-${remoteId}`;
        	
        	addVideoThumbnail(stream, remoteId, displayName || 'ë‚˜');
        	// ë‚´ í™”ë©´ ì˜ì—­
        	if (!document.getElementById(boxElId)) {
        	    const localBox = `
        	      <div class="remote-box" id="${boxElId}">
        	        <span>ë‚´ í™”ë©´</span><br>
        	        <video id="${videoElId}" autoplay muted playsinline></video>
        	        <div style="margin-top: 4px;">
        	          <button id="${muteBtnId}" style="cursor: pointer;">ğŸ”Š</button>
        	          <input type="range" min="0" max="2" step="0.01" value="1"
        	            class="volume-slider" data-id="${remoteId}" id="${volumeSliderId}"
        	            style="width: 80%; margin-top: 4px;" />
        	        </div>

        	        <!-- ğŸ”» Bandwidth ì„¤ì • (optional) -->
        	        <div class="bitrate-controls">
        	          <button id="bitrateset">Bandwidth â–¼</button>
        	          <ul id="bitrate" class="dropdown-menu">
        	            <li><a href="#" id="0">No limit</a></li>
        	            <li><a href="#" id="128">128kbps</a></li>
        	            <li><a href="#" id="256">256kbps</a></li>
        	            <li><a href="#" id="512">512kbps</a></li>
        	            <li><a href="#" id="1024">1mbps</a></li>
        	            <li><a href="#" id="1500">1.5mbps</a></li>
        	            <li><a href="#" id="2000">2mbps</a></li>
        	          </ul>
        	        </div>
        	      </div>`;
        	    $('#remoteContainer').append(localBox);
        	  }
          
        	const videoElement = document.getElementById(videoElId);
        	Janus.attachMediaStream(videoElement, stream);

        	// âœ… ì˜¤ë””ì˜¤ íŠ¸ë™ ìˆëŠ” ê²½ìš°ì—ë§Œ ì˜¤ë””ì˜¤ ì œì–´ ì²˜ë¦¬
        	const hasAudio = stream.getAudioTracks().length > 0;
        	
        	// ìŒí–¥ ì¡°ì ˆ
        	if (hasAudio) {
        	  try {
        	    const audioCtx = new AudioContext();
        	    const source = audioCtx.createMediaStreamSource(stream);
        	    const gainNode = audioCtx.createGain();
        	    source.connect(gainNode).connect(audioCtx.destination);

        	    audioContexts[remoteId] = {
        	      ctx: audioCtx,
        	      gainNode: gainNode,
        	      muted: false
        	    };

        	    const slider = document.getElementById(volumeSliderId);
        	    const muteBtn = document.getElementById(muteBtnId);

        	    slider.addEventListener('input', e => {
        	      const value = parseFloat(e.target.value);
        	      const state = audioContexts[remoteId];
        	      if (!state) return;

        	      state.gainNode.gain.value = value;
        	      if (value === 0) {
        	        state.muted = true;
        	        muteBtn.textContent = 'ğŸ”‡';
        	      } else {
        	        state.muted = false;
        	        muteBtn.textContent = 'ğŸ”Š';
        	      }
        	    });

        	    muteBtn.addEventListener('click', () => {
        	      const state = audioContexts[remoteId];
        	      if (!state) return;

        	      const slider = document.getElementById(volumeSliderId);
        	      if (state.muted) {
        	        // ìŒì†Œê±° í•´ì œ
        	        const restoreVolume = parseFloat(slider.value) || 1.0;
        	        state.gainNode.gain.value = restoreVolume;
        	        muteBtn.textContent = 'ğŸ”Š';
        	      } else {
        	        // ìŒì†Œê±°
        	        state.gainNode.gain.value = 0.0;
        	        muteBtn.textContent = 'ğŸ”‡';
        	      }
        	      state.muted = !state.muted;
        	    });
        	  } catch (err) {
        	    console.warn("âš ï¸ local stream audio ì œì–´ ì‹¤íŒ¨", err);
        	  }
          } else {
        	  console.warn("âš ï¸ streamì— audio track ì—†ìŒ â†’ ì˜¤ë””ì˜¤ ì œì–´ ìƒëµ");
          }
        	
          // streamì´ ë¹„ì–´ìˆëŠ” ê²½ìš°ì—ë„ attachMediaStream ì²˜ë¦¬ (ê²€ì€ í™”ë©´ í‘œì‹œ)
//           Janus.attachMediaStream(document.getElementById('localvideo'), stream);
        },

        oncleanup: cleanupAllFeeds,
        ondetached: cleanupAllFeeds,
        error: function (err) {
          console.error("Janus ì˜¤ë¥˜", err);
        }
      });	// end videoroom í”ŒëŸ¬ê·¸ì¸
    },

    destroyed: cleanupAllFeeds
  });
}


function restartPublisherWithRealCam() {
	if (!janus || !selectedRoomId) return;

	if (sfutest) {
		sfutest.detach({
	      success: () => {
	        attachPublisherAndStartCam();
	      },
	      error: (err) => {
	        console.error("detach ì‹¤íŒ¨", err);
	      }
	    });
	} else {
	    attachPublisherAndStartCam();
	}
}

function attachPublisherAndStartCam() {
	janus.attach({
	    plugin: "janus.plugin.videoroom",
	    opaqueId,
	    success: function (pluginHandle) {
	      sfutest = pluginHandle;
	      
	      // join ì „ì†¡
	      sfutest.send({
	        message: {
	          request: "join",
	          room: Number(selectedRoomId),
	          ptype: "publisher",
	          display: displayName
	        }
	      });
	      
	    },
	    
	    onmessage: function (msg, jsep) {
	    	  if (msg.videoroom === "joined") {
	    	    mypvtid = msg.private_id;
	    	    publishOwnFeed(displayName);  // âœ… ì´ ì‹œì ì— í™•ì‹¤íˆ join ì™„ë£Œë¨
	    	  }

	    	  if (jsep) sfutest.handleRemoteJsep({ jsep });
	    },
	    
	    error: function (err) {
	      console.error("í”ŒëŸ¬ê·¸ì¸ ì¬ì—°ê²° ì‹¤íŒ¨", err);
	    }
	});
}

// âœ… ë‚´ ì˜ìƒ publish
function publishOwnFeed(displayName) {
  console.log("publishOwnFeed ì •ìƒ í˜¸ì¶œ");
  sfutest.createOffer({
    media: { 
      audioRecv: false, videoRecv: false, 
      audioSend: true, videoSend: true
    },
    success: function (jsep) {
      sfutest.send({
        message: { request: "configure", audio: true, video: true },
        jsep
      });
      console.log("publishOwnFeed ì„±ê³µ");
    },
    error: async function (error) {
      console.warn("ğŸ“› ë‚´ stream publish ì‹¤íŒ¨", error.message);

      try {
        // âš ï¸ ìº /ë§ˆì´í¬ ì—†ìŒ â†’ dummyStream ì‚¬ìš©
        const dummyStream = getSilentDummyStream(displayName);

        // âš ï¸ local-boxëŠ” onlocalstreamì—ì„œë§Œ ìƒì„± â†’ ì—¬ê¸°ì„  ë¹„ë””ì˜¤ ì—°ê²°ë§Œ
        const videoElem = document.getElementById('localvideo');
        if (videoElem) {
          videoElem.srcObject = dummyStream;
        } else {
          console.warn("âš ï¸ localvideo elementê°€ ì—†ìŒ. onlocalstreamì—ì„œ ì²˜ë¦¬ í•„ìš”");
        }

        // Janusì— dummy stream attach í›„ publish
        sfutest.createOffer({
          stream: dummyStream,
          media: {
            audioRecv: false,
            videoRecv: false,
            audioSend: true,
            videoSend: true
          },
          success: function (jsep) {
            sfutest.send({
              message: { request: "configure", audio: true, video: true },
              jsep
            });
          },
          error: function (err) {
            console.error("ğŸ“› dummyStream publish ì‹¤íŒ¨", err);
          }
        });

      } catch (e) {
        console.error("âŒ dummyStream êµ¬ì„± ì‹¤íŒ¨", e);   
      }
    }
  });
}

// ì…ì¥ì‹œ ë”ë¯¸ ìŠ¤íŠ¸ë¦¼ publish
function publishOwnDummyFeed(displayName) {
	  const dummyStream = getSilentDummyStream(displayName);

	  sfutest.createOffer({
	    stream: dummyStream,
	    media: {
	      audioRecv: false,
	      videoRecv: false,
	      audioSend: true,
	      videoSend: true
	    },
	    success: function (jsep) {
	      sfutest.send({
	        message: { request: "configure", audio: true, video: true },
	        jsep
	      });
	    },
	    error: function (err) {
	      console.error("ğŸ“› dummyStream publish ì‹¤íŒ¨", err);
	    }
	  });
	}

// ìº ì—†ëŠ” ê²½ìš° ë”ë¯¸ ë°ì´í„°
function getSilentDummyStream(displayName) {
	  const stream = new MediaStream();

	  // ğŸ”‡ dummy audio track
	  const ctx = new AudioContext();
	  const dst = ctx.createMediaStreamDestination();
	  const silence = ctx.createBufferSource();
	  silence.buffer = ctx.createBuffer(1, 1, 22050); // ë¬´ìŒ ë²„í¼ (0.000045ì´ˆì§œë¦¬)
	  silence.connect(dst);
	  silence.start();
	  const audioTrack = dst.stream.getAudioTracks()[0];
	  stream.addTrack(audioTrack);

	  // ğŸ“· dummy video track (ê²€ì • í™”ë©´)
	  const canvas = Object.assign(document.createElement("canvas"), { width: 320, height: 240 });
	  const context = canvas.getContext("2d");
	  context.fillStyle = "black";
	  context.fillRect(0, 0, canvas.width, canvas.height);
	  
	  // ê°€ìš´ë° í…ìŠ¤íŠ¸
	  context.fillStyle = "white";               // í…ìŠ¤íŠ¸ ìƒ‰ìƒ
	  context.font = "bold 20px Arial";          // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
	  context.textAlign = "center";
	  context.textBaseline = "middle";
	  context.fillText(displayName, canvas.width / 2, canvas.height / 2);
	  
	  const videoTrack = canvas.captureStream().getVideoTracks()[0];
	  stream.addTrack(videoTrack);

	  return stream;
	}

// âœ… remote feed ì¶”ê°€
function newRemoteFeed(id, display) {
	
  //ì´ë¯¸ ë“±ë¡ëœ feedì¸ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€) ì¡´ì¬ ì‹œ ì œê±° í›„ ì¬ì‚¬ìš© ë°©ì§€
  if (feeds.find(f => String(f.rfid) === String(id)) || isRecentlyLeft(id)) {
    console.warn(`âš ï¸ Feed ${id} already exists, removing newRemoteFeed`);
	return;
  }
  
  //ì´ë¯¸ DOMì— í•´ë‹¹ IDì˜ video ë°•ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°
  if (document.getElementById(`remote-box-${id}`)) {
    console.warn(`âš ï¸ remote-box-${id} already exists in DOM, removing`);
    document.getElementById(`remote-box-${id}`).remove();
  }
  
  janus.attach({
    plugin: "janus.plugin.videoroom",
    opaqueId,

    success: function (pluginHandle) {
      const remoteFeed = pluginHandle;
      remoteFeed.rfid = id;
      remoteFeed.rfdisplay = display;
      feedHandles[id] = remoteFeed;
      feeds.push(remoteFeed);

      remoteFeed.send({
        message: {
          request: "join",
          room: Number(selectedRoomId),
          ptype: "subscriber",
          feed: id,
          private_id: mypvtid
        }
      });
      renderParticipants();
    },

    onmessage: function (msg, jsep) {
      if (jsep) {
        feeds.find(f => f.rfid === id)?.createAnswer({
          jsep,
          media: { audioSend: false, videoSend: false },
          success: function (jsep) {
            feeds.find(f => f.rfid === id)?.send({ message: { request: "start", room: Number(selectedRoomId) }, jsep });
          },
          error: function (err) {
            console.error("remote SDP ì˜¤ë¥˜", err);
          }
        });
      }
    },

    onremotestream: function (stream) {
    	
    	
    	const remoteId = id;
    	const videoElId = `remotevideo-${remoteId}`;
    	const boxElId = `remote-box-${remoteId}`;
    	const muteBtnId = `mute-btn-${remoteId}`;
    	const volumeSliderId = `volume-slider-${remoteId}`;
    	
    	addVideoThumbnail(stream, remoteId, display);

    	// DOM ì´ë¯¸ ìˆëŠ” ê²½ìš° ì¢…ë£Œ
    	if (document.getElementById(boxElId)) return;
      
    	// remote-box HTML ìƒì„± ë° ì‚½ì…
      	const html = `
        	<div class="remote-box" id="${boxElId}">
	          	<span>${display}</span><br>
	          	<video id="${videoElId}" autoplay playsinline></video>
	          	<div style="margin-top: 4px;">
	            	<button id="${muteBtnId}" style="cursor: pointer;">ğŸ”Š</button>
	          		<input type="range" min="0" max="2" step="0.01" value="1" 
	                	class="volume-slider" data-id="${remoteId}" id="${volumeSliderId}" style="width: 80%; margin-top: 4px;" />
	            </div>
        	</div>`;
      	$('#remoteContainer').append(html);
      	
      	// ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
        const videoElement = document.getElementById(videoElId);
        if (!videoElement) {
        	console.error("âŒ video elementê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
        	return;
        }
      	Janus.attachMediaStream(videoElement, stream);
        
     	// ğŸ§ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìˆëŠ” ê²½ìš° ë°°ì—´ì— ì¶”ê°€
//         if (stream.getAudioTracks().length > 0) {
//           console.log(`ğŸ§ remote stream ë“±ë¡ë¨ (ID: ${remoteId})`);
//           remoteAudioMap.set(remoteId, stream);
//         } else {
//           console.warn(`âš ï¸ remote streamì— ì˜¤ë””ì˜¤ íŠ¸ë™ ì—†ìŒ (ID: ${remoteId})`);
//         }
      	
     	// âœ… ì˜¤ë””ì˜¤ íŠ¸ë™ ìˆëŠ” ê²½ìš°ì—ë§Œ ì˜¤ë””ì˜¤ ì œì–´ ì²˜ë¦¬
        const hasAudio = stream.getAudioTracks().length > 0;

        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
        if(hasAudio){
	        const audioCtx = new AudioContext();
	        const source = audioCtx.createMediaStreamSource(stream);
	        const gainNode = audioCtx.createGain();
	
	        // ì˜¤ë””ì˜¤ íë¦„: source -> gainNode -> ì¶œë ¥
	        source.connect(gainNode).connect(audioCtx.destination);
	
	        // ì „ì—­ ì €ì¥ì†Œì— ë“±ë¡
	        audioContexts[remoteId] = {
	          ctx: audioCtx,
	          gainNode: gainNode,
	          muted: false  // ì´ˆê¸° ìƒíƒœ: ìŒì†Œê±° ì•„ë‹˜
	        };
	
	     	// ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ì œì–´
	        const slider = document.getElementById(volumeSliderId);
	        const muteBtn = document.getElementById(muteBtnId);
	        const state = audioContexts[remoteId];
	        
	        if(slider && state && muteBtn){
	        	console.log("ì§€ê¸ˆ ì—¬ê¸°");
		        slider.addEventListener('input', e => {
		          const value = parseFloat(e.target.value);
 		          state.gainNode.gain.value = value;
		          if (value === 0) {
		            state.muted = true;
		            muteBtn.textContent = 'ğŸ”‡';
		          } else {
		            state.muted = false;
		            muteBtn.textContent = 'ğŸ”Š';
		          }
		        });
		     	// ìŒì†Œê±° ë²„íŠ¼ ì œì–´
		        muteBtn.addEventListener('click', () => {
		          const restoreVolume = parseFloat(slider.value) || 1.0;
		          
		          console.log(`ë“±ë¡ëœ muteBtn ID: ${muteBtnId}`, muteBtn);
		          
		          if (state.muted) {
		        	// ìŒì†Œê±° í•´ì œ
		            state.gainNode.gain.value = restoreVolume;
		            muteBtn.textContent = 'ğŸ”Š';
		          } else {
		        	// ìŒì†Œê±°
		            state.gainNode.gain.value = 0.0;
		            muteBtn.textContent = 'ğŸ”‡';
		          }
		          state.muted = !state.muted;
		        });
	        }
	        
        } else {
        	console.warn("âš ï¸ streamì— audio track ì—†ìŒ â†’ ì˜¤ë””ì˜¤ ì œì–´ ìƒëµ");
        }
    },

    oncleanup: function () {
      removeRemoteFeed(id);
      remoteAudioMap.delete(id);
      console.log(`ğŸ§¹ remoteAudioMapì—ì„œ ì œê±°ë¨: ${id}`);
    },

    ondetached: function () {
      removeRemoteFeed(id);
      remoteAudioMap.delete(id);  // âœ… Mapì—ì„œ ì œê±°
      console.log(`ğŸ§¹ remoteAudioMapì—ì„œ ì œê±°ë¨: ${id}`);
    }
  });
}

const detachedFeeds = new Set();  // ì „ì—­ ìºì‹œ

// âœ… remote feed ì œê±°
function removeRemoteFeed(id) {
  console.log(`ğŸ§¹ remote feed ì œê±°: ${id}`);
  const idStr = String(id);
  
  //ì¤‘ë³µ ì œê±° ë°©ì§€
  if (detachedFeeds.has(idStr)) {
    console.log(`â¹ï¸ ì¤‘ë³µ ì œê±° ì°¨ë‹¨: ${idStr}`);
    return;
  }
  detachedFeeds.add(idStr);
  
  // feedsì—ì„œ ì œê±° ëŒ€ìƒ ì°¾ê¸°
  const targetFeed = feeds.find(f => f && String(f.rfid) === idStr);
  if (!targetFeed) {
    console.warn(`âš ï¸ ì´ë¯¸ ì œê±°ëœ remote feed: ${idStr}`);
    removeVideoThumbnail(idStr);			// ì¸ë„¤ì¼ì€ í˜¹ì‹œ ë‚¨ì•„ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì•„ë˜ ì¤„ì€ ë‚¨ê²¨ë‘ 
    return;
  }
  
  // âœ… detach feed handle
  try {
    targetFeed.detach();
  } catch (e) {
    console.warn("âŒ detach ì¤‘ ì˜ˆì™¸:", e);
  }
  
  // feeds ë°°ì—´ì—ì„œ ì œê±°
  feeds = feeds.filter(f => String(f.rfid) !== idStr);

  // ë¹„ë””ì˜¤ DOM ì œê±°
  document.getElementById(`remote-box-${idStr}`)?.remove();
  
  // ì¸ë„¤ì¼ ë¹„ë””ì˜¤ ë™ì  ì œê±°
  console.log(`removeRemoteFeed called with id=${idStr}`);
  removeVideoThumbnail(idStr);
  
  // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì œê±°
  if (audioContexts[id]) {
	  try {
	      audioContexts[id].ctx.close();
	  } catch (e) {}
	  delete audioContexts[id];
  }
  
  
  // í•¸ë“¤ ì œê±°
  if (feedHandles && feedHandles[idStr]) {
    try {
      feedHandles[idStr].detach();
    } catch (e) {}
    delete feedHandles[idStr];
  }
  
  //âœ… ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ì—ì„œë„ ì œê±°
  const p = participants.find(p => String(p.id) === idStr);
  if (p) {
    removeParticipant(p.id);
    renderParticipants();
  }
  
  
}

const recentlyLeft = new Map();

function markAsLeft(id) {
  const strId = String(id);
  recentlyLeft.set(strId, Date.now());
  setTimeout(() => recentlyLeft.delete(strId), 3000); // 3ì´ˆê°„ ìœ íš¨
}

function isRecentlyLeft(id) {
	const strId = String(id);
	if (recentlyLeft.has(strId)) {
	    const age = Date.now() - recentlyLeft.get(strId);
	    if (age < 3000) return true;
		recentlyLeft.delete(strId);
	}
	return false;
}


// âœ… ì „ì²´ ì •ë¦¬
function cleanupAllFeeds() {

	if (isDestroying) return;
	isDestroying = true; // ğŸ” ì§„ì… í”Œë˜ê·¸ ì„¤ì •

	console.log("ğŸ§¹ cleanupAllFeeds() ì‹¤í–‰");
	
   // remote feed detach + ë°°ì—´ ì´ˆê¸°í™”
   // ì¤‘ë³µ ì œê±° ë°©ì§€
   feeds.forEach((f, i) => {
    if (f && !seen.has(f.rfid)) {
      try { f.detach(); } catch (e) {}
      seen.add(f.rfid);
    }
    feeds[i] = null;
  });
   
   feeds = [];
  
  // ì˜ìƒ DOM ì œê±°
  $('#remoteContainer').empty();
  $('#local-box').remove();
  
  // ì˜ìƒ ì¸ë„¤ì¼ ì œê±°
  document.getElementById('videoThumbnails').innerHTML = '';
  document.getElementById('mainVideo').srcObject = null;
  
  // remoteAudioMapì˜ ëª¨ë“  ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€ ë° í•´ì œ
  remoteAudioMap.forEach((stream, feedId) => {
      // ì˜¤ë””ì˜¤ íŠ¸ë™ ì •ì§€
      stream.getTracks().forEach(track => track.stop());
      remoteAudioMap.delete(feedId);
  });

  
  // Audio context ì •ë¦¬
  Object.values(audioContexts).forEach(state => state.ctx.close());
  Object.keys(audioContexts).forEach(k => delete audioContexts[k]);
  
  // í•¸ë“¤ ë° ì„¸ì…˜ ì´ˆê¸°í™”
  if (sfutest) sfutest.detach();
  sfutest = null;
  myid = null;
  mypvtid = null;
  myUsername = null;
  myDataId = null;
  selectedRoomId = null;
  displayName = null;
  
  // janus ì„¸ì…˜ ì œê±°
  if (janus) {
    janus.destroy();
    janus = null;
  }
  
}

// ìƒë‹¨ ì¸ë„¤ì¼ ë™ì  ì¶”ê°€
function addVideoThumbnail(stream, id, displayName) {
	id = String(id);
	
	if (document.getElementById(`thumb-${id}`)) return;  // ì´ë¯¸ ì¸ë„¤ì¼ ìˆìœ¼ë©´ íŒ¨ìŠ¤
	
	const video = document.createElement('video');
	video.id = `thumb-${id}`;
	video.autoplay = true;
	video.playsInline = true;
	video.muted = true;
	video.title = displayName;
	video.srcObject = stream;

	// í´ë¦­ì‹œ ë©”ì¸í™”ë©´ êµì²´
	video.addEventListener('click', function() {
	    const mainVideo = document.getElementById('mainVideo');
	    mainVideo.srcObject = stream;
	    document.querySelectorAll('.video-thumbnails video').forEach(v => v.classList.remove('active'));
	    video.classList.add('active');
	});

	document.getElementById('videoThumbnails').appendChild(video);

	// ìµœì´ˆ ì¶”ê°€ë¼ë©´ mainVideoë„ ìë™ ì—°ê²° (ë³¸ì¸ ì…ì¥/ì²« ì°¸ê°€ì)
	const mainVideo = document.getElementById('mainVideo');
	if (!mainVideo.srcObject) {
	    mainVideo.srcObject = stream;
	    video.classList.add('active');
	}
}

// ìƒë‹¨ ë¹„ë””ì˜¤ ì¸ë„¤ì¼ ë™ì  ì œê±°
function removeVideoThumbnail(id) {
	id = String(id);
	console.log(`removeVideoThumbnail called for thumb-${id}`);
	document.getElementById(`thumb-${id}`)?.remove();
}



// websocket ì—°ê²° ë° êµ¬ë…
let stompClient = null;
let chatSubscription = null;		// êµ¬ë… ê°ì²´ ì €ì¥ìš© (ë‚˜ì¤‘ì— unsubscribe ê°€ëŠ¥)


function connectChat(roomId) {
  if (stompClient && stompClient.connected) {
	  stompClient.disconnect(() => {
	    console.log("ğŸ”Œ ê¸°ì¡´ WebSocket ì—°ê²° í•´ì œ ì™„ë£Œ");
	  });
  }
	
  const socket = new SockJS("http://43.201.107.133:8080/ws-chat");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, function () {
    console.log("âœ… ì±„íŒ… ì—°ê²° ì„±ê³µ");
    
    // êµ¬ë…
    stompClient.subscribe(`/topic/chat/${roomId}`, function (messageOutput) {
      const msg = JSON.parse(messageOutput.body);
	  appendChatMessage(msg.sender, msg.message);
    });
	sendMessage(displayName + "ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
  });
  
}

// websocket ì—°ê²° ì¢…ë£Œ
function disconnectChat() {
	if (stompClient && stompClient.connected) {
	  stompClient.disconnect(() => {
	    console.log("ğŸ›‘ WebSocket ì—°ê²° ì¢…ë£Œë¨");
	  });
	}
}

function leaveRoom() {
	// 1. ì±„íŒ… í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡
	if (stompClient && stompClient.connected) {
    	sendMessage(displayName + "ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
  	}
	
	// 2. WebSocket ì—°ê²° í•´ì œ
	if (stompClient) {
		disconnectChat();
		stompClient = null;
	
		// ì±„íŒ…ì°½ ì´ˆê¸°í™”
		const chatBox = document.getElementById("chatMessages");
		if (chatBox) chatBox.innerHTML = "";
		
	}

	// 3. Janus ì—°ê²° í•´ì œ ì „ì— -> unpublishë¥¼ ëª…ì‹œì ìœ¼ë¡œ ìˆ˜í–‰
	if (sfutest) {
	    const unpubRequest = { request: "unpublish" };
	    sfutest.send({ message: unpubRequest });
	}
	
	// 4. Janus ì—°ê²° í•´ì œ
	if (janus && !isDestroying) {
	    isDestroying = true;
	    janus.destroy({
	      	success: () => {
	        	console.log("ğŸ§¹ Janus ì„¸ì…˜ ì¢…ë£Œ ì™„ë£Œ");
	        	cleanupAllFeeds();
		        janus = null;
		        isDestroying = false;
	    	}
	  	});
	} else {
        // ë§Œì•½ janus ì„¸ì…˜ì´ ì´ë¯¸ ì—†ê±°ë‚˜ ì´ë¯¸ ì¢…ë£Œ ì¤‘ì´ë©´ ì§ì ‘ ì •ë¦¬!
        cleanupAllFeeds();
    }
	
	// 5. ì „ì—­ ìƒíƒœ ì´ˆê¸°í™”
	selectedRoomId = null;
	displayName = null;
	participants = [];
}

// ë©”ì„¸ì§€ ì „ì†¡
function sendMessage(message) {
	const content = message;

	stompClient.send("/app/chat.send", {}, JSON.stringify({
		type: 'chat',
		roomId: selectedRoomId,
		sender: displayName,
	    message: content
	}));

}

// ì±„íŒ… ë©”ì„¸ì§€ DOM ì¶”ê°€
function appendChatMessage(sender, msg) {
  const chatBox = document.getElementById("chatMessages");
  const p = document.createElement("p");
  
  const safeSender = escapeHtml(sender);
  const safeMsg = escapeHtml(msg);
  
  p.textContent = `[${sender}] ${msg}`;
  chatBox.appendChild(p);
  chatBox.scrollTop = chatBox.scrollHeight;
}

//HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ í•¨ìˆ˜ (XSS ë°©ì§€ìš©)
function escapeHtml(str) {
  return str.replace(/[&<>"']/g, function (match) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[match];
  });
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”©
const input = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendChatBtn");

document.getElementById("sendChatBtn").addEventListener("click", () => {
  const message = input.value.trim();
  if (message !== "") {
    sendMessage(message);
    input.value = "";
  }
});

//Enter í‚¤ ì…ë ¥ ì´ë²¤íŠ¸
input.addEventListener("keypress", function (e) {
  if (e.key === "Enter" && !e.shiftKey) {		// ì—”í„°í‚¤ ê°ì§€ && Shift+Enter ì¤„ë°”ê¿ˆ í—ˆìš©
    e.preventDefault(); // ì¤„ë°”ê¿ˆ ë°©ì§€
    sendBtn.click();    // ì „ì†¡ ë²„íŠ¼ í´ë¦­ê³¼ ë™ì¼í•œ íš¨ê³¼
  }
});

// ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendMessagePayload(payload) {
	if (!stompClient || !stompClient.connected) return;
	stompClient.send("/app/chat", {}, JSON.stringify(payload));
}

// ë§ˆì´í¬ ìŒì†Œê±° ìƒíƒœ ì „ì†¡
function notifyAudioMuteStatus(isMuted) {
	const payload = {
	    type: 'audio-mute-status',
	    roomId: selectedRoomId,
	    sender: displayName,
	    muted: isMuted
	};
	sendMessagePayload(payload);
}

//ì¢…ë£Œë²„íŠ¼ í´ë¦­ì‹œ
document.getElementById("exitBtn").addEventListener("click", function () {
	navigate('list'); // navigateëŠ” ì„¸ì…˜ì •ë¦¬ ì—†ì´ í™”ë©´ ì „í™˜ë§Œ
});

let isCamOn = true;
// ìº  ì‹œì‘ ë²„íŠ¼ í´ë¦­
document.getElementById("startCamBtn").addEventListener("click", function () {
	if (isCamOn) {
        // ìº  ë„ê¸° (unpublish ë˜ëŠ” dummy publish)
        turnOffCamera();
    } else {
        // ìº  ì¼œê¸° (ì‹¤ì œ ìº  publish)
        turnOnCamera();
    }
    isCamOn = !isCamOn; // ìƒíƒœ í† ê¸€
    updateCamBtn();
	// 	restartPublisherWithRealCam();
});

//ë§ˆì´í¬ í† ê¸€ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
document.getElementById("mute-toggle").addEventListener("click", toggleMute);


function updateCamBtn() {
    const btn = document.getElementById("startCamBtn");
    btn.textContent = isCamOn ? "ìº  ë„ê¸°" : "ìº  ì¼œê¸°";
}

// ìº  ë„ê¸° (ì‹¤ì œë¡œëŠ” dummy stream publish ë˜ëŠ” unpublish)
function turnOffCamera() {
    if (!sfutest) return;
    // ë‚´ íŠ¸ë™ì„ ë©ˆì¶”ê³  dummyStreamì„ publish
    publishOwnDummyFeed(displayName); // ë˜ëŠ” sfutest.send({ request: "unpublish" });
}

// ìº  ì¼œê¸° (ì‹¤ì œ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ publish)
function turnOnCamera() {
    // ì‹¤ì œ ìº  ìŠ¤íŠ¸ë¦¼ì„ ì¬ì—°ê²°
    publishOwnFeed(displayName);
}

//ë…¹ìŒ ë° ë…¹í™” ë²„íŠ¼ í† ê¸€
let isRecording = false;
let isAudioRecording = false;

// ë…¹í™” ë²„íŠ¼ í† ê¸€
document.getElementById("recordToggleBtn").addEventListener("click", () => {
	const btn = document.getElementById("recordToggleBtn");
	const icon = btn.querySelector('.icon');
	const label = btn.querySelector('.label');
	
	if (!isRecording) {
	    startFullRecording();
	    isRecording = true;
	    icon.textContent = "ğŸ›‘";
	    label.textContent = "ë…¹í™” ì¤‘ì§€";
    } else {
	    stopFullRecording();
	    isRecording = false;
	    icon.textContent = "ğŸ¥";
	    label.textContent = "ë…¹í™”";
    }
});

// ë…¹ìŒ ë²„íŠ¼ í† ê¸€
document.getElementById("audioRecordToggleBtn").addEventListener("click", () => {
	const button = document.getElementById("audioRecordToggleBtn");
	const icon = button.querySelector('.icon');
	const label = button.querySelector('.label');
	  
	if (!isAudioRecording) {
	    startAudioRecording();
	    isAudioRecording = true;
	    icon.textContent = "ğŸ›‘";
	    label.textContent = "ë…¹ìŒ ì¤‘ì§€";
	} else {
	    stopAudioRecording();
	    isAudioRecording = false;
	    icon.textContent = "ğŸ™ï¸";
	    label.textContent = "ìŒì„±ë…¹ìŒ";
	}
});

// ë‚´ ë§ˆì´í¬ ìŒì†Œê±°
function toggleMute() {
	if (!sfutest) {
	    console.warn("â— sfutest í•¸ë“¤ì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•ŠìŒ");
	    return;
	  }

	const btn = document.getElementById("mute-toggle");
	const icon = btn.querySelector('.icon');
	const label = btn.querySelector('.label');
	
	const muted = sfutest.isAudioMuted();
	if (isMicMuted) {
	    sfutest.unmuteAudio(); // ë§ˆì´í¬ ì¼œê¸°
	    icon.textContent = "ğŸ¤";
        label.textContent = "ë§ˆì´í¬";
	    isMicMuted = false;
	    updateMyAudioMuted(false); // ğŸ”Š ë‚´ ë§ˆì´í¬ ìƒíƒœ ì—…ë°ì´íŠ¸
	    console.log("ğŸ”Š ë§ˆì´í¬ í™œì„±í™”ë¨");
	} else {
	    sfutest.muteAudio(); // ë§ˆì´í¬ ë„ê¸°
	    icon.textContent = "ğŸ”‡";
        label.textContent = "ìŒì†Œê±°";
	    isMicMuted = true;
	    updateMyAudioMuted(true); // ğŸ”Š ë‚´ ë§ˆì´í¬ ìƒíƒœ ì—…ë°ì´íŠ¸
	    console.log("ğŸ”‡ ë§ˆì´í¬ ìŒì†Œê±°ë¨");
	}
}

// audioMuted ê°’ ì—…ë°ì´íŠ¸
function updateMyAudioMuted(muted) {
	participants = participants.map(p => {
	    if (p.display === displayName) {
	      return { ...p, audioMuted: muted };
		}
	    return p;
	});
	renderParticipants(); // UI ê°±ì‹ 
}




//ë…¹í™”?
let mediaRecorder;
let recordedChunks = [];
let mixedStream;

const remoteAudioMap = new Map(); 	// feedId â†’ remoteStream
let myMicStream = null;           	// ë‚´ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼
let screenStream = null;

// âœ… ë…¹í™” ì‹œì‘
async function startFullRecording() {
  try {
    recordedChunks = [];

    // 1. í™”ë©´ ê³µìœ  ì‹œì‘ (íƒ­ or ì „ì²´ í™”ë©´ ì„ íƒ)
    screenStream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: false   // ì˜¤ë””ì˜¤ëŠ” AudioContextì—ì„œ ë”°ë¡œ ë¯¹ì‹±
    });

    screenStream.getVideoTracks()[0].onended = () => {
    	stopFullRecording();
    	console.log("ğŸ“´ í™”ë©´ ê³µìœ  ì¢…ë£Œë¨ â†’ ë…¹í™” ìë™ ì¤‘ì§€");
    };
    
    // 2. ë§ˆì´í¬ ì…ë ¥ (ì˜¤ë””ì˜¤)
  	try {
      myMicStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
      console.warn("ğŸ™ï¸ ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:", err);
      myMicStream = null;
    }
    
    // 3. AudioContextë¡œ ëª¨ë“  ì˜¤ë””ì˜¤ í•©ì„± (remote + ë‚´ ë§ˆì´í¬)
    const audioCtx = new AudioContext();
    const destination = audioCtx.createMediaStreamDestination();

    // ë¯¹ì‹±í•  ìŠ¤íŠ¸ë¦¼: remote + ë§ˆì´í¬
    const allAudioStreams = [...remoteAudioMap.values(), myMicStream];
    if (myMicStream) allAudioStreams.push(myMicStream);

    if (allAudioStreams.length === 0) {
      throw new Error("ì˜¤ë””ì˜¤ ì…ë ¥ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
    
    allAudioStreams.forEach(stream => {
      try {
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(destination);
      } catch (err) {
        console.warn("âš ï¸ ì˜¤ë””ì˜¤ ë¯¹ì‹± ì‹¤íŒ¨:", err);
      }
    });

    // 4. video (í™”ë©´ ìº¡ì²˜) + audio (ë¯¹ì‹±ëœ íŠ¸ë™) ê²°í•©
    const mixedTracks = [
      ...screenStream.getVideoTracks(),
      ...destination.stream.getAudioTracks()
    ];
    mixedStream = new MediaStream(mixedTracks);

    // 5. MediaRecorderë¡œ ë…¹í™” ì‹œì‘
    mediaRecorder = new MediaRecorder(mixedStream, {
    	mimeType: 'video/webm;codecs=vp8,opus'
  	});

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      
      const saveLink = document.createElement('a');
      saveLink.href = url;
      saveLink.download = `ë…¹í™”íŒŒì¼_${new Date().toISOString().slice(0,19).replace(/[:T]/g, '-')}.webm`;
      saveLink.textContent = "ğŸ”½ ë…¹í™”íŒŒì¼ ì €ì¥";
      saveLink.click();
    };

    mediaRecorder.start();
    console.log("âœ… ë…¹í™” ì‹œì‘ë¨");

  } catch (err) {
    console.error("ğŸ¥ ë…¹í™” ì‹œì‘ ì‹¤íŒ¨:", err);
    
 	// ğŸ‘‰ í™”ë©´ ê³µìœ  ìë™ ì¢…ë£Œ
    if (screenStream) {
      screenStream.getTracks().forEach(track => track.stop());
      console.log("ğŸ›‘ ì˜ˆì™¸ ë°œìƒ â†’ í™”ë©´ ê³µìœ  ì¤‘ë‹¨ë¨");
    }
    alert("ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message);
  }
}

// âœ… ë…¹í™” ì¤‘ì§€
function stopFullRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    console.log("ğŸ›‘ ë…¹í™” ì¤‘ì§€ë¨");
  }
  
  if (screenStream) {
	    screenStream.getTracks().forEach(track => track.stop()); // í™”ë©´ ê³µìœ  ì¢…ë£Œ
	    console.log("ğŸ–¥ï¸ í™”ë©´ ê³µìœ  ì¤‘ë‹¨ë¨");
	    screenStream = null;
  }
  
}

// ë…¹ìŒ ê¸°ëŠ¥
let mediaRecorder2;
let recordedChunks2 = [];
let mixedAudioStream;
let myMicStream2 = null;

const remoteAudioMap2 = new Map();   // feedId â†’ MediaStream

// âœ… ì˜¤ë””ì˜¤ ë…¹ìŒ ì‹œì‘
async function startAudioRecording() {
  try {
    recordedChunks2 = [];

    // ë§ˆì´í¬ ì…ë ¥
    try {
      myMicStream2 = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
      console.warn("ğŸ™ï¸ ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:", err);
      myMicStream2 = null;
    }

    const audioCtx = new AudioContext();
    const destination = audioCtx.createMediaStreamDestination();

    const allStreams = [...remoteAudioMap2.values()];
    if (myMicStream2) allStreams.push(myMicStream2);

    if (allStreams.length === 0) {
      alert("ğŸ§ ì˜¤ë””ì˜¤ ì…ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì˜¤ë””ì˜¤ ë¯¹ì‹±
    allStreams.forEach(stream => {
      try {
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(destination);
      } catch (err) {
        console.warn("âš ï¸ ì˜¤ë””ì˜¤ ë¯¹ì‹± ì‹¤íŒ¨:", err);
      }
    });

    mixedAudioStream2 = destination.stream;

    mediaRecorder2 = new MediaRecorder(mixedAudioStream2, {
      mimeType: 'audio/webm'
    });

    mediaRecorder2.ondataavailable = e => {
      if (e.data.size > 0) recordedChunks2.push(e.data);
    };

    mediaRecorder2.onstop = () => {
      const blob = new Blob(recordedChunks2, { type: 'audio/webm' });
      uploadAudio(blob);
      console.log("ë…¹ìŒ ì—¬ê¸°ê¹Œì§„ ë˜ë‚˜");
    };

    mediaRecorder2.start();
    console.log("ğŸ™ï¸ ì˜¤ë””ì˜¤ ë…¹ìŒ ì‹œì‘ë¨");
  } catch (err) {
    console.error("ğŸ™ï¸ ì˜¤ë””ì˜¤ ë…¹ìŒ ì‹¤íŒ¨:", err);
    alert("ë…¹ìŒì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
}

// âœ… ì˜¤ë””ì˜¤ ë…¹ìŒ ì¤‘ì§€
function stopAudioRecording() {
  if (mediaRecorder2 && mediaRecorder2.state !== 'inactive') {
    mediaRecorder2.stop();
    console.log("ğŸ›‘ ì˜¤ë””ì˜¤ ë…¹ìŒ ì¤‘ì§€ë¨");
  }
}

// ë…¹ìŒ íŒŒì¼ ì„œë²„ë¡œ ì—…ë¡œë“œ
function uploadAudio(blob) {
	const formData = new FormData();
	const filename = `recorded_audio_${Date.now()}.webm`;
	formData.append("audioFile", blob, filename);

	fetch("/api/audio/upload", {
	    method: "POST",
	    body: formData
	})
	.then(res => res.text())
	.then(msg => alert("âœ… ì„œë²„ ì—…ë¡œë“œ ì™„ë£Œ\n" + msg))
	.catch(err => console.error("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨", err));
}



// ë³¼ë¥¨ ìŠ¬ë¼ì´ë”
// ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ë³¼ë¥¨ ìŠ¬ë¼ì´ë” í† ê¸€
document.getElementById('participantList').addEventListener('click', function(e){
  const target = e.target;
  if (target.classList.contains('display-name')) {
    const participantDiv = target.closest('.participant');
    const remoteId = participantDiv.getAttribute('data-remote-id');
    showProfilePopup(participantDiv, remoteId, e);
  }
});

function showProfilePopup(participantDiv, remoteId, event) {
	// ê¸°ì¡´ íŒì—… ì œê±°
	const prevPopup = document.getElementById('profilePopup');
	if (prevPopup) prevPopup.remove();

	// (ìœ„ì¹˜ ê³„ì‚°: í´ë¦­ ìœ„ì¹˜ë‚˜ participantDiv ìœ„ì¹˜)
	const rect = participantDiv.getBoundingClientRect();
	const top = rect.bottom + window.scrollY + 5;
	const left = rect.left + window.scrollX - 20;

	// ì°¸ê°€ì ì •ë³´
	const nick = participantDiv.querySelector('.display-name').textContent;
	const avatar = participantDiv.querySelector('.avatar').textContent;

	// íŒì—… ìƒì„±
	const popup = document.createElement('div');
	popup.className = 'profile-popup';
	popup.id = 'profilePopup';
	popup.style.top = `${top}px`;
	popup.style.left = `${left}px`;

	popup.innerHTML = `

	    <div class="profile-volume">
	        <span class="icon">ğŸ”Š</span>
	        <input type="range" min="0" max="2" step="0.01" value="${getRemoteVolume(remoteId)}" class="volume-slider" style="width:110px">
	        <span class="volume-value">${getRemoteVolume(remoteId).toFixed(2)}</span>
	    </div>
	`;

	document.body.appendChild(popup);

	// ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
	const slider = popup.querySelector('.volume-slider');
	const valueSpan = popup.querySelector('.volume-value');
    const icon = popup.querySelector('.icon');
	slider.addEventListener('input', function(){
		const volume = parseFloat(this.value);
		setRemoteVolume(remoteId, volume);
	    valueSpan.textContent = this.value;
	    // ğŸ”ŠğŸ”‡ ì•„ì´ì½˜ í† ê¸€
	    icon.textContent = volume === 0 ? 'ğŸ”‡' : 'ğŸ”Š';
	    console.log('setRemoteVolume:', remoteId, this.value, audioContexts[remoteId]?.gainNode?.gain.value);
	});
	
	// ì•„ì´ì½˜ í´ë¦­ì‹œ ë³¼ë¥¨ 0<->1 í† ê¸€
    icon.addEventListener('click', function(){
        if (parseFloat(slider.value) === 0) {
            slider.value = 1.0;
        } else {
            slider.value = 0;
        }
        slider.dispatchEvent(new Event('input'));
    });

	// ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«í˜
	setTimeout(() => {
	    document.addEventListener('mousedown', hideProfilePopup, { once: true });
	}, 50);

	function hideProfilePopup(e){
	    if (!popup.contains(e.target)){
	    	popup.remove();
	    	document.removeEventListener('mousedown', hideProfilePopup);
	    }
    }
}

//ì‹¤ì œ ë³¼ë¥¨ ì œì–´ í•¨ìˆ˜ ì˜ˆì‹œ
function getRemoteVolume(remoteId) {
  // audioContexts[remoteId].gainNode.gain.value ë“± ì‹¤ì œ ì˜¤ë””ì˜¤ ìƒíƒœì™€ ì—°ë™!
  return audioContexts[remoteId]?.gainNode?.gain.value || 1.0;
}
function setRemoteVolume(remoteId, value) {
  if (audioContexts[remoteId]) audioContexts[remoteId].gainNode.gain.value = value;
}

// remote feed í‡´ì¥ì‹œ ì œê±°
function removeRemoteStreamFromAudioList(feedId) {
	if (remoteAudioMap.has(feedId)) {
    	remoteAudioMap.delete(feedId);
    	console.log(`ğŸ§¹ feed ${feedId} ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì œê±°ë¨`);
  	}
}
</script>


</body>
</html>